<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ü¶∑ Poladent Sistema Completo Mejorado</title>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
body{font-family:Arial;background:#f0f8ff;margin:0}
header{background:#3aa6ff;color:white;padding:15px;text-align:center}
button{background:#3aa6ff;color:white;border:none;padding:10px 15px;border-radius:8px;margin:5px;cursor:pointer;width:45%}
input,select{padding:10px;margin:5px;border-radius:6px;border:1px solid #ccc;width:90%}
.panel{display:none;padding:20px}
.card{background:white;padding:15px;border-radius:12px;margin-bottom:10px;box-shadow:0 4px 10px rgba(0,0,0,0.1)}
.eye{cursor:pointer;margin-left:-30px}
#notificacionesAdmin,#notiEmpleado{position:fixed;top:20px;right:20px;z-index:9999;width:250px}
.notificacion{background:#e6f4ff;border-left:6px solid #3aa6ff;padding:12px;margin-bottom:10px;border-radius:8px}
.empleadoItem{display:flex;justify-content:space-between;align-items:center;margin:5px 0}
.borrar{background:#ff4d4d}
#nombreGrande{text-align:center;font-size:1.8em;margin-bottom:15px}
</style>
</head>
<body>

<header>
<h2>ü¶∑ Poladent Sistema Completo Mejorado ü¶∑</h2>
</header>

<!-- Pantalla de selecci√≥n -->
<div id="seleccion" class="panel" style="display:block;text-align:center;padding:50px">
  <button onclick="mostrarLoginAdmin()">Entrar como Administrador</button>
  <button onclick="mostrarLoginEmpleado()">Entrar como Empleado</button>
</div>

<!-- LOGIN ADMIN -->
<div id="loginAdmin" class="panel">
  <div class="card">
    <h3>Administrador</h3>
    <input type="password" id="adminPass" placeholder="Contrase√±a">
    <span class="eye" onclick="togglePass('adminPass')">üëÅ</span><br>
    <button onclick="loginAdmin()">Entrar Admin</button>
    <button onclick="volverSeleccion()">Volver</button>
  </div>
</div>

<!-- LOGIN EMPLEADO -->
<div id="loginEmp" class="panel">
  <div class="card">
    <h3>Empleado</h3>
    <input id="empNombreLogin" placeholder="Nombre">
    <input type="password" id="empPinLogin" placeholder="PIN">
    <span class="eye" onclick="togglePass('empPinLogin')">üëÅ</span><br>
    <button onclick="loginEmpleado()">Entrar Empleado</button>
    <button onclick="volverSeleccion()">Volver</button>
  </div>
</div>

<!-- PANEL ADMIN -->
<div id="admin" class="panel">

  <div class="card">
    <h3>Panel Admin</h3>
    <button onclick="logout('admin')">Cerrar sesi√≥n</button>
  </div>

  <!-- Registro Empleado -->
  <div class="card">
    <h4>Registrar empleado</h4>
    <input id="empNombre" placeholder="Nombre">
    <input type="password" id="empPin" placeholder="PIN">
    <span class="eye" onclick="togglePass('empPin')">üëÅ</span><br>
    <button onclick="crearEmpleado()">Guardar</button>
  </div>

  <!-- Lista Empleados -->
  <div class="card">
    <h4>Empleados</h4>
    <div id="listaEmpleados"></div>
  </div>

  <!-- C√≥digo QR -->
  <div class="card">
    <h4>C√≥digo QR del escritorio</h4>
    <div id="qrcode"></div>
  </div>

  <!-- Exportar Excel -->
  <div class="card">
    <h4>Exportar Resumen Salarial</h4>
    <select id="periodo">
      <option value="30">Mensual (30 d√≠as)</option>
      <option value="15">Quincenal (15 d√≠as)</option>
    </select><br>
    <button onclick="exportarExcel()">Exportar a Excel</button>
  </div>
</div>

<!-- PANEL EMPLEADO -->
<div id="empleado" class="panel">
  <div class="card">
    <h2 id="nombreGrande"></h2>
    <button onclick="marcar('Entrada','Buen trabajo üíô')">Entrada</button>
    <button onclick="marcar('Almuerzo','Buen provecho üçΩÔ∏è')">Almuerzo</button>
    <button onclick="marcar('Regreso','Buen regreso üí™')">Regreso</button>
    <button onclick="marcar('Salida','Gracias por tu trabajo üëè')">Salida</button>
    <br><button onclick="logout('emp')">Cerrar sesi√≥n</button>
  </div>
  <div class="card">
    <h4>Mis √∫ltimas marcaciones</h4>
    <div id="misMarcaciones"></div>
  </div>
</div>

<div id="notificacionesAdmin"></div>
<div id="notiEmpleado"></div>

<script>
var firebaseConfig = {
  apiKey: "AIzaSyAFOyMEo2SgWpcs8WHp2nKCO_ax9-lYZWo",
  authDomain: "poladent-5fa13.firebaseapp.com",
  databaseURL: "https://poladent-5fa13-default-rtdb.firebaseio.com",
  projectId: "poladent-5fa13",
  storageBucket: "poladent-5fa13.firebasestorage.app",
  messagingSenderId: "539152567873",
  appId: "1:539152567873:web:89c67ebb14bd55a77900c0",
  measurementId: "G-XS7W8B86WY"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();
const horaEntrada=8,horaSalida=17;
let empleadoActual="";

// =================== SELECCION ===================
function mostrarLoginAdmin(){seleccion.style.display='none';loginAdmin.style.display='block';}
function mostrarLoginEmpleado(){seleccion.style.display='none';loginEmp.style.display='block';}
function volverSeleccion(){loginAdmin.style.display='none';loginEmp.style.display='none';seleccion.style.display='block';}

// =================== ADMIN ===================
function loginAdmin(){
  if(adminPass.value==="Poladen2026"){
    loginAdmin.style.display="none";
    admin.style.display="block";
    cargarEmpleados();
    generarQR();
  } else alert("Contrase√±a incorrecta");
}
function cargarEmpleados(){
  db.ref("empleados").on("value",snap=>{
    listaEmpleados.innerHTML="";
    snap.forEach(e=>{
      const id=e.key,d=e.val();
      listaEmpleados.innerHTML+=`<div class="empleadoItem"><div>${d.nombre} - PIN: <b>${d.pin}</b></div><button class="borrar" onclick="borrarEmpleado('${id}')">üóë</button></div>`;
    });
  });
}
function crearEmpleado(){if(!empNombre.value||!empPin.value)return;db.ref("empleados").push({nombre:empNombre.value,pin:empPin.value});empNombre.value="";empPin.value="";}
function borrarEmpleado(id){if(confirm("¬øBorrar este empleado?"))db.ref("empleados/"+id).remove();}
function generarQR(){qrcode.innerHTML="";new QRCode(qrcode,{text:window.location.href,width:180,height:180});}

// Notificaciones Admin
db.ref("notificaciones").limitToLast(10).on("child_added",s=>{
  const d=s.val();
  const div=document.createElement("div");div.className="notificacion";
  let atrasado="";
  if(d.tipo==="Entrada"){const h=d.hora.split(":")[0]*1;if(h>horaEntrada) atrasado="‚ö†Ô∏è Atrasado";}
  div.innerHTML=`<b>${d.nombre}</b> ${atrasado}<br>${d.tipo}<br>${d.fecha} ${d.hora}`;
  notificacionesAdmin.appendChild(div); setTimeout(()=>div.remove(),10000);
});

// Exportar Excel
function exportarExcel(){
  const dias=parseInt(document.getElementById("periodo").value);
  db.ref("marcaciones").once("value",snap=>{
    const data=[];const registros={};
    snap.forEach(e=>{const d=e.val();if(!registros[d.nombre])registros[d.nombre]=[];registros[d.nombre].push(d);});
    for(const nombre in registros){
      const logs=registros[nombre].slice(-dias*4);
      logs.sort((a,b)=>new Date(a.fecha+" "+a.hora)-new Date(b.fecha+" "+b.hora));
      let totalHoras=0;
      logs.forEach((l,i)=>{if(i%4===0){const ent=l,sal=logs[i+3];if(ent && sal){const hi=ent.hora.split(":").map(Number),hf=sal.hora.split(":").map(Number);let horas=hf[0]+hf[1]/60-(hi[0]+hi[1]/60)-1;totalHoras+=Math.max(0,horas);}}});
      logs.forEach(l=>data.push({Nombre:nombre,Fecha:l.fecha,Tipo:l.tipo,Hora:l.hora}));
      data.push({Nombre:nombre,TotalHoras:totalHoras.toFixed(2),Salario:(totalHoras*1.5).toFixed(2)});
    }
    const ws=XLSX.utils.json_to_sheet(data);
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,"Resumen");
    XLSX.writeFile(wb,"Resumen_Poladent.xlsx");
  });
}

// =================== EMPLEADO ===================
function loginEmpleado(){
  const nombre=empNombreLogin.value.trim();
  const pin=empPinLogin.value.trim();
  if(!nombre || !pin){alert("Ingrese nombre y PIN"); return;}
  db.ref("empleados").orderByChild("nombre").equalTo(nombre).once("value",snap=>{
    let valido=false;
    snap.forEach(e=>{const d=e.val();if(d.pin===pin){valido=true; empleadoActual=nombre;}});
    if(valido){loginEmp.style.display="none";empleado.style.display="block";document.getElementById("nombreGrande").innerText=empleadoActual;cargarMisMarcaciones();}
    else alert("Nombre o PIN incorrecto");
  });
}

function marcar(tipo,mensaje){
  if(!empleadoActual) return;
  const n=new Date(); let lat=0,lng=0;
  if(navigator.geolocation){navigator.geolocation.getCurrentPosition(p=>{lat=p.coords.latitude; lng=p.coords.longitude; guardarMarcacion(tipo,mensaje,n,lat,lng);},()=>{guardarMarcacion(tipo,mensaje,n,lat,lng);});} 
  else guardarMarcacion(tipo,mensaje,n,lat,lng);
}

function guardarMarcacion(tipo,mensaje,n,lat,lng){
  db.ref("marcaciones").push({nombre:empleadoActual,tipo:tipo,hora:n.toLocaleTimeString(),fecha:n.toLocaleDateString(),lat:lat,lng:lng});
  db.ref("notificaciones").push({nombre:empleadoActual,tipo:tipo,hora:n.toLocaleTimeString(),fecha:n.toLocaleDateString()});
  mostrarNotificacion(mensaje);
  cargarMisMarcaciones();
}

function cargarMisMarcaciones(){
  db.ref("marcaciones").orderByChild("nombre").equalTo(empleadoActual).limitToLast(10).once("value",snap=>{
    misMarcaciones.innerHTML="";
    snap.forEach(e=>{const d=e.val();misMarcaciones.innerHTML+=`<div class="notificacion">${d.tipo} - ${d.fecha} ${d.hora}</div>`;});
  });
}

function mostrarNotificacion(texto){
  const div=document.createElement("div");div.className="notificacion";div.innerText=texto;
  notiEmpleado.appendChild(div); setTimeout(()=>div.remove(),5000);
}

// Cerrar sesi√≥n
function logout(tipo){location.reload();}
function togglePass(id){const i=document.getElementById(id);i.type=i.type==="password"?"text":"password";}
</script>
</body>
  </html>
