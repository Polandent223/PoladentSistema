<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Poladent ğŸ¦· Sistema</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{font-family:Arial;background:#eaf6ff;padding:20px;text-align:center;}
.card{background:#fff;padding:20px;border-radius:10px;margin:15px auto;max-width:450px;}
input,button{padding:10px;margin:5px;width:90%;font-size:15px;}
button{background:#007bff;color:white;border:none;border-radius:5px;}
.hidden{display:none;}
.notif{background:#fff3cd;padding:10px;margin:5px;border-radius:6px;}
.nombreGrande{font-size:26px;font-weight:bold;margin-bottom:10px;}
</style>
</head>

<body>

<h1>Poladent ğŸ¦·ğŸ¦·</h1>

<div id="home" class="card">
  <button onclick="goAdmin()">Administrador</button>
  <button onclick="goEmployee()">Empleado</button>
</div>

<div id="adminLogin" class="card hidden">
  <h3>Administrador</h3>
  <input id="adminEmail" placeholder="Correo">
  <input id="adminPass" type="password" placeholder="ContraseÃ±a">
  <button onclick="loginAdmin()">Entrar</button>
  <button onclick="backHome()">Volver</button>
</div>

<div id="adminPanel" class="card hidden">
  <h3>Panel Administrador</h3>

  <div class="card">
    <h4>Agregar empleado</h4>
    <input id="nombreEmpleado" placeholder="Nombre">
    <input id="pinEmpleado" placeholder="PIN">
    <button onclick="agregarEmpleado()">Guardar</button>
  </div>

  <div class="card">
    <h4>Empleados</h4>
    <div id="listaEmpleados"></div>
  </div>

  <div class="card">
    <h4>ğŸ”” Notificaciones</h4>
    <div id="notificaciones"></div>
  </div>

  <button onclick="logout()">Salir</button>
</div>

<div id="employeePanel" class="card hidden">
  <div id="empNombreGrande" class="nombreGrande"></div>
  <input id="empPin" type="password" placeholder="PIN">
  <div id="employeeButtons" class="hidden">
    <button onclick="marcar('entrada')">Entrada</button>
    <button onclick="marcar('salida')">Salida</button>
  </div>
  <button onclick="backHome()">Volver</button>
</div>

<script>
// ğŸ”¥ FIREBASE
firebase.initializeApp({
  apiKey:"AIzaSyAFOyMEo2SgWpcs8WHp2nKCO_ax9-lYZWo",
  authDomain:"poladent-5fa13.firebaseapp.com",
  databaseURL:"https://poladent-5fa13-default-rtdb.firebaseio.com",
  projectId:"poladent-5fa13"
});
const auth=firebase.auth();
const db=firebase.database();

// ğŸ§­ NAV
function hideAll(){
  home.classList.add("hidden");
  adminLogin.classList.add("hidden");
  adminPanel.classList.add("hidden");
  employeePanel.classList.add("hidden");
}
function backHome(){hideAll();home.classList.remove("hidden");}
function goAdmin(){hideAll();adminLogin.classList.remove("hidden");}
function goEmployee(){hideAll();employeePanel.classList.remove("hidden");}

// ğŸ‘¤ ADMIN
function loginAdmin(){
  auth.signInWithEmailAndPassword(adminEmail.value,adminPass.value)
  .then(()=>{
    hideAll();
    adminPanel.classList.remove("hidden");
    cargarEmpleados();
    escucharNotificaciones();
  }).catch(()=>alert("Error"));
}
function logout(){auth.signOut();backHome();}

function agregarEmpleado(){
  if(!nombreEmpleado.value||!pinEmpleado.value)return;
  db.ref("empleados").push({nombre:nombreEmpleado.value,pin:pinEmpleado.value});
  nombreEmpleado.value="";pinEmpleado.value="";
}
function cargarEmpleados(){
  db.ref("empleados").on("value",snap=>{
    listaEmpleados.innerHTML="";
    snap.forEach(e=>{
      listaEmpleados.innerHTML+=`<div>${e.val().nombre}</div>`;
    });
  });
}

// ğŸ‘· EMPLEADO
let empleadoActual=null;
empPin.addEventListener("change",()=>{
  db.ref("empleados").orderByChild("pin").equalTo(empPin.value)
  .once("value",snap=>{
    snap.forEach(e=>{
      empleadoActual={id:e.key,nombre:e.val().nombre};
      empNombreGrande.innerText=empleadoActual.nombre;
      employeeButtons.classList.remove("hidden");
    });
  });
});

// â±ï¸ MARCAR + ATRASOS (E3)
function marcar(tipo){
  const now=new Date();
  const hora=now.toLocaleTimeString();
  const fecha=now.toISOString().split("T")[0];
  const timestamp=now.getTime();

  let atrasoMin=0, salidaAntesMin=0;

  if(tipo==="entrada"){
    const limite=new Date(); limite.setHours(8,0,0,0);
    if(now>limite) atrasoMin=Math.floor((now-limite)/60000);
  }
  if(tipo==="salida"){
    const limite=new Date(); limite.setHours(17,0,0,0);
    if(now<limite) salidaAntesMin=Math.floor((limite-now)/60000);
  }

  const data={
    nombre:empleadoActual.nombre,
    tipo, hora, fecha, timestamp,
    atrasoMin, salidaAntesMin
  };

  db.ref("marcaciones").push(data);
  db.ref("notificaciones").push(data);

  backHome();
}

// ğŸ”” NOTIF REALTIME
function escucharNotificaciones(){
  notificaciones.innerHTML="";
  db.ref("notificaciones").limitToLast(15).on("child_added",snap=>{
    const n=snap.val();
    let msg=`${n.nombre} marcÃ³ ${n.tipo} (${n.hora})`;
    if(n.atrasoMin>0) msg+=` âš ï¸ ${n.atrasoMin} min tarde`;
    if(n.salidaAntesMin>0) msg+=` âš ï¸ saliÃ³ ${n.salidaAntesMin} min antes`;
    notificaciones.innerHTML=`<div class="notif">${msg}</div>`+notificaciones.innerHTML;
  });
}

backHome();
</script>
</body>
</html>
