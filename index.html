<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Poladent â€“ Control Profesional</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body{font-family:Arial;background:#eaf6ff;padding:20px;text-align:center}
button,input{padding:10px;margin:5px;font-size:15px}
.card{background:#fff;padding:20px;border-radius:10px;margin-top:15px}
.hidden{display:none}
.notice{background:#dff3ff;padding:10px;border-radius:6px;margin-top:8px}
</style>
</head>

<body>

<h1>Poladent ðŸ¦·ðŸ¦·</h1>

<div id="home" class="card">
  <button onclick="goAdmin()">Administrador</button>
  <button onclick="goEmployee()">Empleado</button>
</div>

<div id="adminLogin" class="card hidden">
  <h3>Administrador</h3>
  <input id="adminEmail" placeholder="Correo">
  <input id="adminPass" type="password" placeholder="ContraseÃ±a">
  <br>
  <button onclick="loginAdmin()">Entrar</button>
  <button onclick="backHome()">Volver</button>
</div>

<div id="adminPanel" class="card hidden">
  <h3>Panel Administrador</h3>

  <label>Salario por hora:</label>
  <input id="salarioHora" type="number" value="10">
  <label>Factor extra:</label>
  <input id="factorExtra" type="number" value="1.5">

  <div id="adminList"></div>
  <button onclick="exportExcel()">Exportar Excel</button>
  <button onclick="logout()">Salir</button>
</div>

<div id="employeePanel" class="card hidden">
  <h3>Empleado</h3>
  <input id="empName" placeholder="Nombre">
  <input id="empPin" type="password" placeholder="PIN"><br>
  <button onclick="mark('entrada')">Entrada</button>
  <button onclick="mark('almuerzo_salida')">Salida Almuerzo</button>
  <button onclick="mark('almuerzo_regreso')">Regreso Almuerzo</button>
  <button onclick="mark('salida')">Salida</button>
  <div id="empMsg" class="notice"></div>
  <button onclick="backHome()">Volver</button>
</div>

<script>
const firebaseConfig={
apiKey:"AIzaSyAFOyMEo2SgWpcs8WHp2nKCO_ax9-lYZWo",
authDomain:"poladent-5fa13.firebaseapp.com",
databaseURL:"https://poladent-5fa13-default-rtdb.firebaseio.com",
projectId:"poladent-5fa13",
storageBucket:"poladent-5fa13.firebasestorage.app",
messagingSenderId:"539152567873",
appId:"1:539152567873:web:89c67ebb14bd55a77900c0"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(),db=firebase.database();

function hideAll(){home.classList.add("hidden");adminLogin.classList.add("hidden");adminPanel.classList.add("hidden");employeePanel.classList.add("hidden")}
function backHome(){hideAll();home.classList.remove("hidden")}
function goAdmin(){hideAll();adminLogin.classList.remove("hidden")}
function goEmployee(){hideAll();employeePanel.classList.remove("hidden")}

function loginAdmin(){
auth.signInWithEmailAndPassword(adminEmail.value,adminPass.value)
.then(()=>{hideAll();adminPanel.classList.remove("hidden");loadAdmin()})
.catch(()=>alert("Error login"))
}
function logout(){auth.signOut();backHome()}

function mark(tipo){
if(!empName.value||!empPin.value)return alert("Completa datos");
const now=new Date(),fecha=now.toLocaleDateString(),hora=now.toLocaleTimeString();
const ref=db.ref("marcaciones/"+fecha+"/"+empName.value+"_"+empPin.value+"/"+tipo);
ref.once("value",s=>{
if(s.exists())empMsg.innerHTML="âš ï¸ Ya marcado";
else{ref.set({nombre:empName.value,tipo,fecha,hora,timestamp:now.getTime()});
empMsg.innerHTML=`âœ” ${tipo} ${hora}`}
});
}

function loadAdmin(){
db.ref("marcaciones").on("value",snap=>{
let html="",rows=[];
snap.forEach(day=>{
let fecha=day.key;
day.forEach(emp=>{
let data={},entrada,salida;
emp.forEach(m=>{
data[m.key]=m.val();
});
if(data.entrada && data.salida){
let h1=new Date("1970-01-01 "+data.entrada.hora);
let h2=new Date("1970-01-01 "+data.salida.hora);
let horas=(h2-h1)/3600000;
let extra=Math.max(0,horas-9);
let normales=horas-extra;
let salario=normales*salarioHora.value + extra*salarioHora.value*factorExtra.value;
html+=`<p><b>${data.entrada.nombre}</b> ${fecha} | ${horas.toFixed(2)}h | $${salario.toFixed(2)}</p>`;
rows.push([data.entrada.nombre,fecha,normales,extra,salario]);
}
});
});
adminList.innerHTML=html||"Sin datos";
window.excelRows=rows;
});
}

function exportExcel(){
let wb=XLSX.utils.book_new();
let ws=XLSX.utils.aoa_to_sheet([["Nombre","Fecha","Horas","Extra","Salario"],...excelRows]);
XLSX.utils.book_append_sheet(wb,ws,"Resumen");
XLSX.writeFile(wb,"Poladent.xlsx");
}

backHome();
</script>
</body>
  </html>
