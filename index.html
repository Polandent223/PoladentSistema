<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Poladent ‚Äì Control de Jornada</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body{font-family:Arial;background:#eaf6ff;text-align:center;padding:20px}
.card{background:#fff;padding:20px;border-radius:10px;margin:15px auto;max-width:480px}
input,button,select{width:90%;padding:10px;margin:5px;font-size:15px}
button{background:#007bff;color:#fff;border:none;border-radius:6px;cursor:pointer}
button.danger{background:#dc3545}
.hidden{display:none}
.nombre{font-size:26px;font-weight:bold;margin-bottom:10px}
.alerta{background:#ffe0e0;padding:8px;margin:5px;border-radius:6px}
.ok{background:#e0ffe6;padding:8px;margin:5px;border-radius:6px}
</style>
</head>

<body>

<h1>ü¶∑ Poladent</h1>

<div id="home" class="card">
<button onclick="showAdmin()">Administrador</button>
<button onclick="showEmpleado()">Empleado</button>
</div>

<div id="adminLogin" class="card hidden">
<input id="adminEmail" placeholder="Correo">
<input id="adminPass" type="password" placeholder="Contrase√±a">
<button onclick="loginAdmin()">Entrar</button>
<button onclick="back()">Volver</button>
</div>

<div id="adminPanel" class="card hidden">
<h3>Administrador</h3>

<div class="card">
<input id="nombreEmp" placeholder="Nombre empleado">
<input id="pinEmp" placeholder="PIN">
<button onclick="addEmpleado()">Agregar empleado</button>
</div>

<div class="card">
<h4>Empleados</h4>
<div id="listaEmpleados"></div>
</div>

<div class="card">
<h4>Resumen diario</h4>
<input type="date" id="fechaResumen" onchange="cargarResumen()">
<div id="resumen"></div>
<div id="alertas"></div>
<button onclick="exportar()">Exportar Excel</button>
</div>

<button onclick="logout()">Salir</button>
</div>

<div id="empleadoPanel" class="card hidden">
<div id="nombreGrande" class="nombre"></div>
<input id="pinIngreso" type="password" placeholder="PIN">
<div id="botones" class="hidden">
<button onclick="marcar('entrada')">Entrada</button>
<button onclick="marcar('salida')">Salida</button>
</div>
<div id="mensaje"></div>
<button onclick="back()">Volver</button>
</div>

<script>
// FIREBASE
firebase.initializeApp({
apiKey:"AIzaSyAFOyMEo2SgWpcs8WHp2nKCO_ax9-lYZWo",
authDomain:"poladent-5fa13.firebaseapp.com",
databaseURL:"https://poladent-5fa13-default-rtdb.firebaseio.com",
projectId:"poladent-5fa13"
});
const auth=firebase.auth(),db=firebase.database();

let empleado=null;

// NAVEGACI√ìN
function hide(){
home.classList.add("hidden");
adminLogin.classList.add("hidden");
adminPanel.classList.add("hidden");
empleadoPanel.classList.add("hidden");
}
function back(){hide();home.classList.remove("hidden")}
function showAdmin(){hide();adminLogin.classList.remove("hidden")}
function showEmpleado(){hide();empleadoPanel.classList.remove("hidden")}

// ADMIN
function loginAdmin(){
auth.signInWithEmailAndPassword(adminEmail.value,adminPass.value)
.then(()=>{hide();adminPanel.classList.remove("hidden");initFecha();cargarEmpleados();cargarResumen()})
.catch(()=>alert("Error"));
}
function logout(){auth.signOut();back()}

function addEmpleado(){
if(!nombreEmp.value||!pinEmp.value)return;
db.ref("empleados").push({nombre:nombreEmp.value,pin:pinEmp.value});
nombreEmp.value="";pinEmp.value="";
}

function cargarEmpleados(){
db.ref("empleados").on("value",s=>{
listaEmpleados.innerHTML="";
s.forEach(e=>{
listaEmpleados.innerHTML+=`
<p>${e.val().nombre}
<button class="danger" onclick="db.ref('empleados/${e.key}').remove()">X</button></p>`;
});
});
}

// EMPLEADO
pinIngreso.addEventListener("change",()=>{
db.ref("empleados").orderByChild("pin").equalTo(pinIngreso.value)
.once("value",s=>{
if(!s.exists()){alert("PIN incorrecto");return;}
s.forEach(e=>{
empleado={id:e.key,nombre:e.val().nombre};
nombreGrande.innerText=empleado.nombre;
botones.classList.remove("hidden");
});
});
});

function marcar(tipo){
const d=new Date();
const fecha=d.toISOString().slice(0,10);
db.ref(`marcaciones/${empleado.id}/${fecha}/${tipo}`)
.set({hora:d.toLocaleTimeString(),timestamp:d.getTime(),nombre:empleado.nombre});
mensaje.innerHTML=`<div class="ok">‚úî ${tipo} registrada</div>`;
setTimeout(back,1500);
cargarResumen();
}

// RESUMEN + ALERTAS (ARREGLADO)
function initFecha(){
fechaResumen.value=new Date().toISOString().slice(0,10);
}

function cargarResumen(){
resumen.innerHTML="";alertas.innerHTML="";
db.ref("marcaciones").once("value",snap=>{
snap.forEach(emp=>{
db.ref("empleados/"+emp.key).once("value",empSnap=>{
const nombre=empSnap.val().nombre;
const dia=emp.child(fechaResumen.value);
if(!dia.exists())return;

let ent=dia.child("entrada").val()?.timestamp;
let sal=dia.child("salida").val()?.timestamp;

if(ent) resumen.innerHTML+=`<p><b>${nombre}</b> Entrada ${new Date(ent).toLocaleTimeString()}</p>`;
if(sal) resumen.innerHTML+=`<p><b>${nombre}</b> Salida ${new Date(sal).toLocaleTimeString()}</p>`;

if(ent && new Date(ent).getHours()>8)
alertas.innerHTML+=`<div class="alerta">‚è∞ ${nombre} lleg√≥ tarde</div>`;
if(sal && new Date(sal).getHours()<17)
alertas.innerHTML+=`<div class="alerta">‚ö†Ô∏è ${nombre} sali√≥ temprano</div>`;
});
});
});
}

// EXCEL
function exportar(){
let rows=[["Nombre","Fecha","Tipo","Hora"]];
db.ref("marcaciones").once("value",s=>{
s.forEach(emp=>{
s.child(emp.key).forEach(d=>{
Object.values(d.val()).forEach(m=>{
rows.push([m.nombre,d.key,m.tipo||"",m.hora]);
});
});
});
let wb=XLSX.utils.book_new();
let ws=XLSX.utils.aoa_to_sheet(rows);
XLSX.utils.book_append_sheet(wb,ws,"Resumen");
XLSX.writeFile(wb,"Poladent.xlsx");
});
}

back();
</script>
</body>
</html>
