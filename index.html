<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Poladent â€“ Sistema E14 Salario</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{font-family:Arial;background:#eaf6ff;padding:20px;text-align:center}
.card{background:#fff;padding:20px;border-radius:10px;max-width:500px;margin:15px auto;box-shadow:0 2px 5px rgba(0,0,0,.1)}
button,input,select{padding:10px;margin:5px;width:90%;font-size:15px}
button{background:#007bff;color:#fff;border:none;border-radius:5px;cursor:pointer}
button.danger{background:#dc3545}
.hidden{display:none}
.nombreGrande{font-size:24px;font-weight:bold;margin-bottom:10px}
.notif{background:#fff3cd;padding:8px;margin:5px;border-radius:5px}
</style>
</head>

<body>
<h1>Poladent ðŸ¦·ðŸ¦· â€“ E14 Salario</h1>

<div id="home" class="card">
  <button onclick="showAdmin()">Administrador</button>
  <button onclick="showEmpleado()">Empleado</button>
</div>

<div id="adminLogin" class="card hidden">
  <h3>Administrador</h3>
  <input id="adminEmail" placeholder="Correo">
  <input id="adminPass" type="password" placeholder="ContraseÃ±a">
  <button onclick="loginAdmin()">Entrar</button>
  <button onclick="goHome()">Volver</button>
</div>

<div id="adminPanel" class="card hidden">
  <h3>Panel Administrador</h3>

  <div class="card">
    <h4>Agregar empleado</h4>
    <input id="empNombre" placeholder="Nombre">
    <input id="empPin" placeholder="PIN">
    <input id="empTarifa" placeholder="Tarifa por hora (USD)">
    <button onclick="addEmpleado()">Guardar</button>
  </div>

  <div class="card">
    <h4>Empleados</h4>
    <div id="listaEmpleados"></div>
  </div>

  <div class="card">
    <h4>Resumen de Marcaciones y Salario</h4>
    <input type="date" id="fechaFiltro">
    <select id="periodoResumen" onchange="mostrarResumen()">
      <option value="diario">Diario</option>
      <option value="quincenal">Quincenal</option>
      <option value="mensual">Mensual</option>
    </select>
    <div id="resumen"></div>
    <div id="notificaciones"></div>
    <button onclick="exportarExcelMarc()">Exportar Marcaciones</button>
    <button onclick="exportarExcelSalario()">Exportar Salario</button>
  </div>

  <div class="card">
    <h4>EscÃ¡ner QR de llegada</h4>
    <div id="qr-reader" style="width:300px;margin:auto;"></div>
  </div>

  <button onclick="logout()">Salir</button>
</div>

<div id="empleadoPanel" class="card hidden">
  <div id="empNombreGrande" class="nombreGrande"></div>
  <input id="pinInput" type="password" placeholder="Ingresa tu PIN">
  <div id="acciones" class="hidden">
    <button onclick="marcar('entrada')">Entrada</button>
    <button onclick="marcar('almuerzo_salida')">Salida Almuerzo</button>
    <button onclick="marcar('almuerzo_regreso')">Regreso Almuerzo</button>
    <button onclick="marcar('salida')">Salida</button>
  </div>
  <div id="msg"></div>
  <button onclick="goHome()">Volver</button>
</div>

<script>
// ðŸ”¥ FIREBASE
firebase.initializeApp({
 apiKey:"AIzaSyAFOyMEo2SgWpcs8WHp2nKCO_ax9-lYZWo",
 authDomain:"poladent-5fa13.firebaseapp.com",
 databaseURL:"https://poladent-5fa13-default-rtdb.firebaseio.com",
 projectId:"poladent-5fa13"
});
const auth=firebase.auth(), db=firebase.database();

// ðŸŒ NavegaciÃ³n
function hideAll(){home.classList.add("hidden");adminLogin.classList.add("hidden");adminPanel.classList.add("hidden");empleadoPanel.classList.add("hidden")}
function goHome(){hideAll();home.classList.remove("hidden")}
function showAdmin(){hideAll();adminLogin.classList.remove("hidden")}
function showEmpleado(){hideAll();empleadoPanel.classList.remove("hidden")}

// ðŸ” Login Admin
function loginAdmin(){
  auth.signInWithEmailAndPassword(adminEmail.value,adminPass.value)
  .then(()=>{hideAll();adminPanel.classList.remove("hidden");cargarEmpleados();setFechaHoy();cargarNotificaciones();startQR();})
  .catch(()=>alert("Error de acceso"));
}
function logout(){auth.signOut();goHome()}

// ðŸ‘· Empleados
function addEmpleado(){
  if(!empNombre.value||!empPin.value||!empTarifa.value) return alert("Completa todo");
  db.ref("empleados").push({nombre:empNombre.value,pin:empPin.value,tarifa:Number(empTarifa.value)});
  empNombre.value="";empPin.value="";empTarifa.value="";
}
function cargarEmpleados(){
  db.ref("empleados").on("value",s=>{
    listaEmpleados.innerHTML="";
    s.forEach(e=>{
      listaEmpleados.innerHTML+=`
        <div class="empleado">
          <b>${e.val().nombre}</b> | PIN: ${e.val().pin} | Tarifa: $${e.val().tarifa.toFixed(2)}
          <button class="danger" onclick="delEmp('${e.key}')">X</button>
        </div>`;
    });
  });
}
function delEmp(id){if(confirm("Â¿Borrar empleado?")){db.ref("empleados/"+id).remove();db.ref("marcaciones/"+id).remove();}}

// ðŸ‘¤ Empleado con GPS
let empActual=null;
pinInput.onchange=()=>{
  db.ref("empleados").once("value",s=>{
    empActual=null;
    s.forEach(e=>{if(e.val().pin===pinInput.value) empActual={id:e.key,nombre:e.val().nombre,tarifa:e.val().tarifa};});
    if(!empActual) return alert("PIN incorrecto");
    empNombreGrande.innerText=empActual.nombre;
    acciones.classList.remove("hidden");
  });
};

function marcar(tipo){
  if(!navigator.geolocation) return alert("GPS no disponible");
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat=pos.coords.latitude, lon=pos.coords.longitude;
    const now=new Date(), fecha=now.toISOString().slice(0,10), hora=now.toLocaleTimeString();
    db.ref(`marcaciones/${empActual.id}/${fecha}/${tipo}`).set({nombre:empActual.nombre,tipo,hora,ts:Date.now(),lat,lon})
    .then(()=>{mostrarNotificacion(`${empActual.nombre} marcÃ³ ${tipo} a las ${hora}`); msg.innerText="Marcado âœ”"; setTimeout(goHome,2000);});
  },err=>alert("No se pudo obtener GPS"));
}

// ðŸ“… Calendario
function setFechaHoy(){fechaFiltro.value=new Date().toISOString().slice(0,10);fechaFiltro.onchange=mostrarResumen;mostrarResumen();}

// ðŸ”” Notificaciones
function cargarNotificaciones(){db.ref("marcaciones").on("child_added",snap=>{snap.forEach(emp=>{Object.values(emp.val()).forEach(dia=>{Object.values(dia).forEach(m=>{mostrarNotificacion(`${m.nombre} marcÃ³ ${m.tipo} a las ${m.hora}`);});});});});}
function mostrarNotificacion(text){const div=document.createElement("div");div.className="notif";div.innerText=text;notificaciones.prepend(div);}

// ðŸ“ Resumen + Salario
function mostrarResumen(){
  resumen.innerHTML="";
  const fecha=fechaFiltro.value, periodo=periodoResumen.value;
  db.ref("empleados").once("value",emps=>{
    db.ref("marcaciones").once("value",marc=>{
      let dataExcel=[];
      emps.forEach(e=>{
        let totalHoras=0, totalExtra=0;
        const marcEmp=(marc.val()||{})[e.key]||{};
        for(const dia in marcEmp){
          if(periodo==="diario" && dia!==fecha) continue;
          if(periodo==="quincenal" && dia<fecha.slice(0,8)+"01") continue;
          if(periodo==="mensual" && dia.slice(0,7)!==fecha.slice(0,7)) continue;

          let entrada=null,salida=null;
          Object.values(marcEmp[dia]).forEach(m=>{if(m.tipo==="entrada") entrada=m.ts; if(m.tipo==="salida") salida=m.ts;});
          if(entrada && salida){
            let hrs=(salida-entrada)/3600000, extra=Math.max(0,hrs-8);
            totalHoras+=Math.min(hrs,8); totalExtra+=extra;
            resumen.innerHTML+=`<p><b>${m.nombre||e.val().nombre}</b> - ${dia} - Horas: ${hrs.toFixed(2)}, Extra: ${extra.toFixed(2)}, Salario: $${((Math.min(hrs,8))*e.val().tarifa).toFixed(2)}</p>`;
            dataExcel.push([m.nombre||e.val().nombre,dia,hrs.toFixed(2),extra.toFixed(2),((Math.min(hrs,8))*e.val().tarifa).toFixed(2)]);
          }
        }
        if(totalHoras>0){
          const salario=totalHoras*e.val().tarifa;
          resumen.innerHTML+=`<p><b>Total ${e.val().nombre}</b> Horas normales: ${totalHoras.toFixed(2)}, Extra: ${totalExtra.toFixed(2)}, Salario: $${salario.toFixed(2)}</p><hr>`;
        }
      });
    });
  });
}

// ðŸ“¤ Exportar Excel
function exportarExcelMarc(){mostrarResumen(); let wb=XLSX.utils.book_new(); let ws=XLSX.utils.table_to_sheet(resumen); XLSX.writeFile(wb,"Marcaciones.xlsx");}
function exportarExcelSalario(){mostrarResumen(); let wb=XLSX.utils.book_new(); let ws=XLSX.utils.table_to_sheet(resumen); XLSX.writeFile(wb,"Salario.xlsx");}

// ðŸ”¹ QR
function startQR(){
  const html5QrCode=new Html5Qrcode("qr-reader");
  html5QrCode.start({facingMode:"environment"},{fps:10,qrbox:250},qrCodeMessage=>scanQR(qrCodeMessage)).catch(err=>console.log(err));
}
function scanQR(pin){
  db.ref("empleados").orderByChild("pin").equalTo(pin).once("value",snap=>{
    if(!snap.exists()) return alert("PIN QR no registrado");
    snap.forEach(e=>{
      const emp={id:e.key,nombre:e.val().nombre,tarifa:e.val().tarifa};
      if(!navigator.geolocation) return alert("GPS no disponible");
      navigator.geolocation.getCurrentPosition(pos=>{
        const lat=pos.coords.latitude, lon=pos.coords.longitude;
        const now=new Date(), fecha=now.toISOString().slice(0,10), hora=now.toLocaleTimeString();
        db.ref(`marcaciones/${emp.id}/${fecha}/entrada_qr`).set({nombre:emp.nombre,tipo:"entrada_qr",hora,ts:Date.now(),lat,lon});
        mostrarNotificacion(`${emp.nombre} llegÃ³ QR a las ${hora} (GPS:${lat.toFixed(5)},${lon.toFixed(5)})`);
      });
    });
  });
}

goHome();
</script>
</body>
</html>
