<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Poladent â€“ Control de Jornada</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body{font-family:Arial;background:#eaf6ff;text-align:center;padding:20px}
.card{background:#fff;padding:20px;border-radius:10px;margin:15px auto;max-width:450px}
button,input{padding:10px;margin:5px;width:90%}
button{background:#007bff;color:#fff;border:none;border-radius:5px}
.hidden{display:none}
.nombreGrande{font-size:24px;font-weight:bold}
.empleado{border-bottom:1px solid #ddd;padding:10px}
</style>
</head>

<body>

<h1>Poladent ðŸ¦·</h1>

<div id="home" class="card">
<button onclick="goAdmin()">Administrador</button>
<button onclick="goEmployee()">Empleado</button>
</div>

<div id="adminLogin" class="card hidden">
<input id="adminEmail" placeholder="Correo">
<input id="adminPass" type="password" placeholder="ContraseÃ±a">
<button onclick="loginAdmin()">Entrar</button>
<button onclick="backHome()">Volver</button>
</div>

<div id="adminPanel" class="card hidden">
<h3>Administrador</h3>

<button onclick="toggle('empBox')">ðŸ‘¥ Empleados</button>
<div id="empBox" class="hidden">
<input id="nombreEmpleado" placeholder="Nombre">
<input id="pinEmpleado" placeholder="PIN">
<button onclick="agregarEmpleado()">Agregar</button>
<div id="listaEmpleados"></div>
</div>

<button onclick="toggle('resBox')">ðŸ“… Resumen del dÃ­a</button>
<div id="resBox" class="hidden">
<input type="date" id="filterDate">
<div id="adminList"></div>
<button onclick="exportExcel()">Exportar Excel</button>
</div>

<button onclick="logout()">Salir</button>
</div>

<div id="employeePanel" class="card hidden">
<div id="empNombre" class="nombreGrande"></div>
<input id="empPin" type="password" placeholder="PIN">
<div id="empBtns" class="hidden">
<button id="btnEntrada" onclick="mark('entrada')">Entrada</button>
<button id="btnAS" onclick="mark('almuerzo_salida')">Salida Almuerzo</button>
<button id="btnAR" onclick="mark('almuerzo_regreso')">Regreso Almuerzo</button>
<button id="btnSalida" onclick="mark('salida')">Salida</button>
</div>
<div id="msg"></div>
<button onclick="backHome()">Volver</button>
</div>

<script>
// FIREBASE
firebase.initializeApp({
apiKey:"AIzaSyAFOyMEo2SgWpcs8WHp2nKCO_ax9-lYZWo",
authDomain:"poladent-5fa13.firebaseapp.com",
databaseURL:"https://poladent-5fa13-default-rtdb.firebaseio.com"
});
const auth=firebase.auth(), db=firebase.database();

function hideAll(){
home.classList.add("hidden");
adminLogin.classList.add("hidden");
adminPanel.classList.add("hidden");
employeePanel.classList.add("hidden");
}
function backHome(){hideAll();home.classList.remove("hidden");}
function goAdmin(){hideAll();adminLogin.classList.remove("hidden");}
function goEmployee(){hideAll();employeePanel.classList.remove("hidden");}

function toggle(id){document.getElementById(id).classList.toggle("hidden");}

// ADMIN
function loginAdmin(){
auth.signInWithEmailAndPassword(adminEmail.value,adminPass.value)
.then(()=>{hideAll();adminPanel.classList.remove("hidden");loadEmpleados();})
.catch(()=>alert("Error"));
}
function logout(){auth.signOut();backHome();}

function agregarEmpleado(){
const n=nombreEmpleado.value,p=pinEmpleado.value;
db.ref("empleados").push({nombre:n,pin:p});
nombreEmpleado.value=pinEmpleado.value="";
}
function loadEmpleados(){
db.ref("empleados").on("value",s=>{
listaEmpleados.innerHTML="";
s.forEach(e=>{
listaEmpleados.innerHTML+=`<div class="empleado">${e.val().nombre}</div>`;
});
});
}

// EMPLEADO â€“ CONTROL DE ORDEN
let emp=null;
empPin.onchange=()=>{
db.ref("empleados").orderByChild("pin").equalTo(empPin.value).once("value",s=>{
if(!s.exists())return alert("PIN invÃ¡lido");
s.forEach(e=>{emp={id:e.key,nombre:e.val().nombre};});
empNombre.innerText=emp.nombre;
empBtns.classList.remove("hidden");
checkEstado();
});
};

function checkEstado(){
const f=new Date().toISOString().slice(0,10);
db.ref(`marcaciones/${emp.id}/${f}`).once("value",s=>{
const d=s.val()||{};
btnEntrada.disabled=!!d.entrada;
btnAS.disabled=!d.entrada||!!d.almuerzo_salida;
btnAR.disabled=!d.almuerzo_salida||!!d.almuerzo_regreso;
btnSalida.disabled=!d.almuerzo_regreso||!!d.salida;
});
}

function mark(tipo){
const f=new Date().toISOString().slice(0,10);
const h=new Date().toLocaleTimeString();
db.ref(`marcaciones/${emp.id}/${f}/${tipo}`).set({nombre:emp.nombre,hora:h});
msg.innerText="âœ” Marcado correctamente";
setTimeout(backHome,1500);
}

// RESUMEN
function exportExcel(){
let rows=[["Nombre","Fecha","Tipo","Hora"]];
db.ref("marcaciones").once("value",s=>{
s.forEach(emp=>{
emp.forEach(f=>{
f.forEach(t=>{
rows.push([t.val().nombre,f.key,t.key,t.val().hora]);
});
});
});
let wb=XLSX.utils.book_new();
let ws=XLSX.utils.aoa_to_sheet(rows);
XLSX.utils.book_append_sheet(wb,ws,"Resumen");
XLSX.writeFile(wb,"Poladent.xlsx");
});
}

backHome();
</script>
</body>
</html>
