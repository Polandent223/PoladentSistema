
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Poladent â€“ Sistema Completo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body{font-family:Arial;background:#eaf6ff;padding:20px;text-align:center;}
.card{background:#fff;padding:20px;border-radius:10px;max-width:450px;margin:15px auto;}
.hidden{display:none}
button,input,select{width:90%;padding:10px;margin:5px}
.notif{background:#fff3cd;padding:6px;margin:4px;border-radius:5px}
</style>
</head>

<body>

<h1>Poladent ðŸ¦·</h1>

<div id="home" class="card">
  <button onclick="goAdmin()">Administrador</button>
  <button onclick="goEmployee()">Empleado</button>
</div>

<div id="adminLogin" class="card hidden">
  <input id="adminEmail" placeholder="Correo">
  <input id="adminPass" type="password" placeholder="ContraseÃ±a">
  <button onclick="loginAdmin()">Entrar</button>
  <button onclick="backHome()">Volver</button>
</div>

<div id="adminPanel" class="card hidden">
  <h3>Administrador</h3>

  <input id="nombreEmpleado" placeholder="Nombre">
  <input id="pinEmpleado" placeholder="PIN">
  <button onclick="addEmpleado()">Agregar empleado</button>

  <h4>Empleados</h4>
  <div id="listaEmpleados"></div>

  <h4>Resumen diario</h4>
  <input type="date" id="fechaFiltro" onchange="renderResumen()">
  <div id="resumen"></div>

  <button onclick="exportarExcel()">Exportar Excel</button>
  <button onclick="logout()">Salir</button>
</div>

<div id="employeePanel" class="card hidden">
  <h3 id="empNombre"></h3>
  <input id="empPin" type="password" placeholder="PIN">
  <div id="empBtns" class="hidden">
    <button onclick="marcar('entrada')">Entrada</button>
    <button onclick="marcar('almuerzo_salida')">Salida Almuerzo</button>
    <button onclick="marcar('almuerzo_regreso')">Regreso Almuerzo</button>
    <button onclick="marcar('salida')">Salida</button>
  </div>
  <div id="empMsg"></div>
  <button onclick="backHome()">Volver</button>
</div>

<script>
const firebaseConfig={
apiKey:"AIzaSyAFOyMEo2SgWpcs8WHp2nKCO_ax9-lYZWo",
authDomain:"poladent-5fa13.firebaseapp.com",
databaseURL:"https://poladent-5fa13-default-rtdb.firebaseio.com",
projectId:"poladent-5fa13"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(), db=firebase.database();

function hideAll(){
home.classList.add("hidden");
adminLogin.classList.add("hidden");
adminPanel.classList.add("hidden");
employeePanel.classList.add("hidden");
}
function backHome(){hideAll();home.classList.remove("hidden")}
function goAdmin(){hideAll();adminLogin.classList.remove("hidden")}
function goEmployee(){hideAll();employeePanel.classList.remove("hidden")}

function loginAdmin(){
auth.signInWithEmailAndPassword(adminEmail.value,adminPass.value)
.then(()=>{hideAll();adminPanel.classList.remove("hidden");initAdmin()})
.catch(()=>alert("Error"))
}
function logout(){auth.signOut();backHome()}

function addEmpleado(){
const nombre=nombreEmpleado.value.trim();
const pin=pinEmpleado.value.trim();
if(!nombre||!pin)return alert("Completa");
db.ref("empleados").push({nombre,pin});
nombreEmpleado.value=""; pinEmpleado.value="";
}

function initAdmin(){
db.ref("empleados").on("value",s=>{
listaEmpleados.innerHTML="";
s.forEach(e=>{
listaEmpleados.innerHTML+=`<div>${e.val().nombre}</div>`;
});
});
const hoy=new Date().toISOString().slice(0,10);
fechaFiltro.value=hoy;
renderResumen();
}

let empleadoActual=null;

empPin.onchange=()=>{
const pin=empPin.value.trim();
db.ref("empleados").orderByChild("pin").equalTo(pin).once("value",s=>{
if(!s.exists())return alert("PIN incorrecto");
s.forEach(e=>{
empleadoActual={id:e.key,nombre:e.val().nombre};
empNombre.innerText=empleadoActual.nombre;
empBtns.classList.remove("hidden");
});
});
};

function marcar(tipo){
const hoy=new Date().toISOString().slice(0,10);
const ref=db.ref(`marcaciones/${empleadoActual.id}/${hoy}`);
ref.once("value",s=>{
const data=s.val()||{};
const orden=["entrada","almuerzo_salida","almuerzo_regreso","salida"];
const ultimo=Object.keys(data).pop();
if(ultimo && orden.indexOf(tipo)!==orden.indexOf(ultimo)+1){
empMsg.innerText="Debes marcar en orden";
return;
}
ref.child(tipo).set({hora:new Date().toLocaleTimeString(),ts:Date.now(),nombre:empleadoActual.nombre});
empMsg.innerText="Marcado âœ”";
});
}

function renderResumen(){
const fecha=fechaFiltro.value;
resumen.innerHTML="";
db.ref("marcaciones").once("value",s=>{
s.forEach(emp=>{
const d=emp.val()[fecha];
if(!d)return;
const ent=d.entrada?.ts, sal=d.salida?.ts;
if(ent&&sal){
const hrs=((sal-ent)/3600000).toFixed(2);
const extra=Math.max(0,hrs-8).toFixed(2);
resumen.innerHTML+=`<div class="notif">
${Object.values(d)[0].nombre} â€“ ${hrs}h (Extra: ${extra})
</div>`;
}
});
});
}

function exportarExcel(){
const rows=[["Empleado","Fecha","Horas","Extras"]];
const fecha=fechaFiltro.value;
db.ref("marcaciones").once("value",s=>{
s.forEach(emp=>{
const d=emp.val()[fecha];
if(!d)return;
const ent=d.entrada?.ts, sal=d.salida?.ts;
if(ent&&sal){
const hrs=((sal-ent)/3600000).toFixed(2);
const extra=Math.max(0,hrs-8).toFixed(2);
rows.push([Object.values(d)[0].nombre,fecha,hrs,extra]);
}
});
const wb=XLSX.utils.book_new();
const ws=XLSX.utils.aoa_to_sheet(rows);
XLSX.utils.book_append_sheet(wb,ws,"Resumen");
XLSX.writeFile(wb,"Poladent_E26.xlsx");
});
}

backHome();
</script>
</body>
  </html>
