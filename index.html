<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Poladent Control de Empleados</title>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; background-color: #d0f0fd; color: #333; padding: 20px; }
  h1,h2,h3{margin:5px 0;}
  input, button, select {padding:8px; margin:5px 0; border-radius:8px; border:1px solid #a0cce8;}
  button {background-color:#5bb0e5; color:white; border:none; cursor:pointer; transition:0.3s;}
  button:hover {background-color:#3f8bcf;}
  .card {background:#e0f7ff; padding:15px; margin:10px 0; border-radius:15px; box-shadow:0px 2px 6px rgba(0,0,0,0.15);}
  table {border-collapse: collapse; width: 100%;}
  th, td {border:1px solid #333; padding:5px; text-align:center;}
  .atraso {color:red; font-weight:bold;}
  #qr img {border:2px solid #5bb0e5; border-radius:10px;}
  #logoEmpresa {max-width:200px; margin-bottom:10px; border-radius:10px;}
</style>
</head>
<body>

<h1>Poladent â€“ Control de Empleados</h1>

<!-- LOGO ADMIN -->
<div id="panelLogo" class="card">
  <h3>Logo de la Empresa</h3>
  <img id="logoEmpresa" src="https://via.placeholder.com/150?text=Logo+Provisorio">
  <br>
  <input type="file" id="fileLogo" accept="image/*">
  <button onclick="subirLogo()">Subir/Actualizar Logo</button>
</div>

<!-- LOGIN ADMIN -->
<div id="loginAdmin" class="card">
  <h2>Administrador</h2>
  <input type="password" id="passAdmin" placeholder="ContraseÃ±a">
  <button onclick="loginAdmin()">Entrar</button>
</div>

<!-- PANEL ADMIN -->
<div id="panelAdmin" class="card" style="display:none;">
  <h2>Panel Administrador</h2>
  <button onclick="cerrarSesionAdmin()">Cerrar sesiÃ³n</button>

  <br><br>
  <h3>Registrar Empleado</h3>
  <input type="text" id="empName" placeholder="Nombre empleado">
  <input type="text" id="empPin" placeholder="PIN">
  <button onclick="registrarEmpleado()">Registrar</button>
  <div id="msgRegistro"></div>

  <br>
  <button onclick="mostrarQR()">Mostrar QR</button>
  <div id="qr"></div>

  <br>
  <label>Periodo:</label>
  <select id="periodo">
    <option value="15">15 dÃ­as</option>
    <option value="30">30 dÃ­as</option>
  </select>
  <button onclick="generarResumen()">ðŸ“Š Calcular Resumen</button>
  <button onclick="exportarExcel()">ðŸ’¾ Exportar a Excel</button>
  <div id="resumenAdmin"></div>
</div>

<!-- LOGIN EMPLEADO -->
<div id="loginEmpleado" class="card">
  <h2>Empleado</h2>
  <input type="text" id="pinEmpleado" placeholder="PIN">
  <button onclick="loginEmpleado()">Entrar</button>
</div>

<!-- PANEL EMPLEADO -->
<div id="panelEmpleado" class="card" style="display:none;">
  <h2 id="nombreEmpleado"></h2>
  <button id="btnEntrada" onclick="marcarEmpleado('Entrada')">Entrada</button>
  <button id="btnSalidaAlm" onclick="marcarEmpleado('Salida almuerzo')">Salida Almuerzo</button>
  <button id="btnRegresoAlm" onclick="marcarEmpleado('Regreso almuerzo')">Regreso Almuerzo</button>
  <button id="btnSalida" onclick="marcarEmpleado('Salida')">Salida</button>
  <div id="mensajesEmpleado"></div>
</div>

<script>
  // ======================
  // CONFIGURACIÃ“N FIREBASE
  // ======================
const firebaseConfig = {
  apiKey: "AIzaSyAFOyMEo2SgWpcs8WHp2nKCO_ax9-lYZWo",
  authDomain: "poladent-5fa13.firebaseapp.com",
  databaseURL: "https://poladent-5fa13-default-rtdb.firebaseio.com",
  projectId: "poladent-5fa13",
  storageBucket: "poladent-5fa13.firebasestorage.app",
  messagingSenderId: "539152567873",
  appId: "1:539152567873:web:89c67ebb14bd55a77900c0",
  measurementId: "G-XS7W8B86WY"
};
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const storage = firebase.storage();

  // ======================
  // CONFIGURACIÃ“N GENERAL
  // ======================
  const ADMIN_PASS = "Poladen2026";
  const HORA_ENTRADA = 8;
  const TOLERANCIA = 10;
  const HORA_SALIDA = 17;
  let FACTOR_EXTRA = 1.5;

  // ======================
  // LOGO EMPRESA
  // ======================
  function subirLogo(){
    const file = document.getElementById("fileLogo").files[0];
    if(!file) return alert("Selecciona una imagen");
    const ref = storage.ref("logo/logoEmpresa.png");
    ref.put(file).then(()=>{
      ref.getDownloadURL().then(url=>{
        document.getElementById("logoEmpresa").src=url;
        db.ref("config/logo").set(url);
      });
    });
  }

  function cargarLogo(){
    db.ref("config/logo").once("value").then(snap=>{
      if(snap.exists()){
        document.getElementById("logoEmpresa").src = snap.val();
      }
    });
  }
  cargarLogo();

  // ======================
  // ADMINISTRADOR
  // ======================
  function loginAdmin(){
    const p = document.getElementById("passAdmin").value;
    if(p===ADMIN_PASS){
      document.getElementById("loginAdmin").style.display="none";
      document.getElementById("panelAdmin").style.display="block";
    } else alert("ContraseÃ±a incorrecta");
  }

  function cerrarSesionAdmin(){
    document.getElementById("panelAdmin").style.display="none";
    document.getElementById("loginAdmin").style.display="block";
  }

  function registrarEmpleado(){
    const nombre = document.getElementById("empName").value;
    const pin = document.getElementById("empPin").value;
    const msg = document.getElementById("msgRegistro");
    if(!nombre || !pin){ msg.innerText="Completar todos los campos"; msg.style.color="red"; return; }
    db.ref("empleados/"+pin).set({name:nombre}).then(()=>{
      msg.innerText="Empleado registrado con Ã©xito âœ…"; msg.style.color="green";
      document.getElementById("empName").value=""; document.getElementById("empPin").value="";
    }).catch(()=>{msg.innerText="Error al registrar"; msg.style.color="red";});
  }

  function mostrarQR(){
    const qrDiv = document.getElementById("qr"); qrDiv.innerHTML="";
    const qr = document.createElement("img"); const link = window.location.href;
    qr.src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data="+encodeURIComponent(link);
    qrDiv.appendChild(qr);
  }

  function generarResumen(){
    const periodo = parseInt(document.getElementById("periodo").value);
    db.ref("logs").once("value").then(snap=>{
      const data = snap.val(); if(!data){alert("No hay registros"); return;}
      let resumen={};
      Object.values(data).forEach(r=>{
        const [d,m,y]=r.fecha.split("/"); let dia=parseInt(d);
        if(periodo===15 && dia>15) return; if(periodo===30 && dia>30) return;
        const key=r.name+"_"+r.fecha; if(!resumen[key]) resumen[key]=[]; resumen[key].push(r);
      });
      let html="<h3>Resumen "+periodo+" dÃ­as</h3><table border='1'><tr><th>Empleado</th><th>Fecha</th><th>Horas Normales</th><th>Horas Extra</th><th>Total</th></tr>";
      Object.values(resumen).forEach(registros=>{
        const dia = calcularDia(registros); if(!dia) return;
        const nombre=registros[0].name; const fecha=registros[0].fecha;
        const total=dia.normales+dia.extras*FACTOR_EXTRA;
        html+=`<tr><td>${nombre}</td><td>${fecha}</td><td>${dia.normales.toFixed(2)}</td><td>${dia.extras.toFixed(2)}</td><td>${total.toFixed(2)}</td></tr>`;
      });
      html+="</table>"; document.getElementById("resumenAdmin").innerHTML=html;
    });
  }

  function exportarExcel(){
    db.ref("logs").once("value").then(snap=>{
      const data=[]; snap.forEach(c=>{
        const r=c.val(); data.push({
          "Empleado": r.name,"Fecha": r.fecha,"Hora": r.hora,"Tipo": r.tipo,
          "Latitud": r.lat,"Longitud": r.lon,"Atraso": r.atraso?"SÃ­":"No"
        });
      }); if(data.length===0){alert("No hay registros"); return;}
      const ws=XLSX.utils.json_to_sheet(data); const wb=XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Marcaciones"); XLSX.writeFile(wb,"Poladent_Empleados.xlsx");
    });
  }

  // ======================
  // EMPLEADO
  // ======================
  let actualEmpleado=null; const marcados={};

  function loginEmpleado(){
    const pin=document.getElementById("pinEmpleado").value;
    db.ref("empleados/"+pin).once("value").then(s=>{
      if(s.exists()){
        actualEmpleado={pin:pin,name:s.val().name};
        document.getElementById("loginEmpleado").style.display="none";
        document.getElementById("panelEmpleado").style.display="block";
        document.getElementById("nombreEmpleado").innerText=actualEmpleado.name;
        marcados['Entrada']=false; marcados['Salida almuerzo']=false;
        marcados['Regreso almuerzo']=false; marcados['Salida']=false;
      } else alert("PIN invÃ¡lido");
    });
  }

  function esAtraso(horaStr){ const [h,m]=horaStr.split(":").map(Number); const minutosTotales=h*60+m; const limite=HORA_ENTRADA*60+TOLERANCIA; return minutosTotales>limite; }
  function horaADecimal(hora){ const [h,m]=hora.split(":").map(Number); return h+m/60; }
  function calcularDia(registros){
    let entrada,salida,salidaAlm,regresoAlm;
    registros.forEach(r=>{if(r.tipo==="Entrada") entrada=r.hora;if(r.tipo==="Salida") salida=r.hora;if(r.tipo==="Salida almuerzo") salidaAlm=r.hora;if(r.tipo==="Regreso almuerzo") regresoAlm=r.hora;});
    if(!entrada||!salida||!salidaAlm||!regresoAlm) return null;
    const manana=horaADecimal(salidaAlm)-horaADecimal(entrada);
    const tarde=horaADecimal(salida)-horaADecimal(regresoAlm);
    const totalDia=manana+tarde; let extra=Math.max(0,horaADecimal(salida)-HORA_SALIDA);
    let normales=totalDia-extra; return {normales:normales<0?0:normales, extras:extra};
  }

  function marcarEmpleado(tipo){
    if(!actualEmpleado){ alert("Empleado no logueado"); return; }
    if(marcados[tipo]){ alert("Ya marcaste esta opciÃ³n"); return; }
    const d=new Date();
    if(!navigator.geolocation){ alert("GPS no soportado"); return; }
    navigator.geolocation.getCurrentPosition(pos=>{
      db.ref("logs").push({
        name:actualEmpleado.name, tipo:tipo, fecha:d.toLocaleDateString(), hora:d.toLocaleTimeString(),
        lat:pos.coords.latitude, lon:pos.coords.longitude, atraso: tipo==="Entrada"?esAtraso(d.toLocaleTimeString()):false
      });
      let mensaje="";
      if(tipo==="Entrada") mensaje=`Bienvenido ${actualEmpleado.name}! Buen trabajo.`;
      if(tipo==="Salida almuerzo") mensaje=`Buen provecho ${actualEmpleado.name}!`;
      if(tipo==="Regreso almuerzo") mensaje=`Bienvenido de regreso ${actualEmpleado.name}!`;
      if(tipo==="Salida") mensaje=`Hasta maÃ±ana ${actualEmpleado.name}!`;
      document.getElementById("mensajesEmpleado").innerText=mensaje;
      marcados[tipo]=true;
    });
  }
</script>
