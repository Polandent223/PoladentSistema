<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Poladent â€“ Sistema Completo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial;background:#eaf6ff;padding:20px;text-align:center;}
h1,h2,h3{text-align:center;}
.card{background:white;padding:20px;border-radius:10px;margin:15px auto;max-width:450px;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
input,button,select{padding:10px;margin:5px;width:90%;font-size:15px;}
button{cursor:pointer;background:#007bff;color:white;border:none;border-radius:5px;}
button.danger{background:#dc3545;}
.hidden{display:none;}
.notice{background:#dff3ff;padding:10px;margin-top:8px;border-radius:6px;}
.empleado{border-bottom:1px solid #ddd;padding:10px 0;}
.nombreGrande{font-size:24px;font-weight:bold;margin-bottom:10px;}
.notif{background:#fff3cd;padding:10px;margin:5px;border-radius:5px;border:1px solid #ffeeba;}
</style>
</head>

<body>

<h1>Poladent ðŸ¦·ðŸ¦·</h1>

<!-- HOME -->
<div id="home" class="card">
  <button onclick="goAdmin()">Administrador</button>
  <button onclick="goEmployee()">Empleado</button>
</div>

<!-- ADMIN LOGIN -->
<div id="adminLogin" class="card hidden">
  <h3>Administrador</h3>
  <input id="adminEmail" placeholder="Correo">
  <input id="adminPass" type="password" placeholder="ContraseÃ±a">
  <br>
  <button onclick="loginAdmin()">Entrar</button>
  <button onclick="backHome()">Volver</button>
</div>

<!-- ADMIN PANEL -->
<div id="adminPanel" class="card hidden">
  <h3>Panel Administrador</h3>

  <!-- AGREGAR EMPLEADO -->
  <div class="card">
    <h4>Agregar empleado</h4>
    <input id="nombreEmpleado" placeholder="Nombre del empleado">
    <input id="pinEmpleado" placeholder="PIN del empleado">
    <button onclick="agregarEmpleado()">Guardar empleado</button>
  </div>

  <!-- LISTA EMPLEADOS -->
  <div class="card">
    <h4>Empleados registrados</h4>
    <div id="listaEmpleados"></div>
  </div>

  <!-- RESUMEN DE MARCACIONES -->
  <div class="card">
    <h4>Resumen de marcaciones</h4>
    <input type="date" id="filterDate" onchange="filterByDate()">
    <select id="periodoResumen" onchange="filterByDate()">
      <option value="diario">Diario</option>
      <option value="quincenal">Quincenal</option>
      <option value="mensual">Mensual</option>
    </select>
    <div id="adminList"></div>
    <div id="notificaciones"></div>
    <button onclick="exportExcel()">Exportar Marcaciones</button>
  </div>

  <!-- SALARIO Y OLERITE -->
  <div class="card">
    <h4>Salario & Olerites</h4>
    <select id="periodoSalario" onchange="renderSalario()">
      <option value="diario">Diario</option>
      <option value="quincenal">Quincenal</option>
      <option value="mensual">Mensual</option>
    </select>
    <div id="salarioList"></div>
    <button onclick="exportExcelSalarial()">Exportar Excel Salarial</button>
  </div>

  <button onclick="logout()">Salir</button>
</div>

<!-- EMPLOYEE PANEL -->
<div id="employeePanel" class="card hidden">
  <div class="nombreGrande" id="empNombreGrande"></div>
  <input id="empPin" type="password" placeholder="Ingresa tu PIN">
  <br>
  <div id="employeeButtons" class="hidden">
    <button onclick="mark('entrada')">Entrada</button>
    <button onclick="mark('almuerzo_salida')">Salida Almuerzo</button>
    <button onclick="mark('almuerzo_regreso')">Regreso Almuerzo</button>
    <button onclick="mark('salida')">Salida</button>
  </div>
  <div id="empMsg" class="notice"></div>
  <button onclick="backHome()">Volver</button>
</div>

<script>
// ðŸ”¥ FIREBASE CONFIG
const firebaseConfig={
  apiKey:"AIzaSyAFOyMEo2SgWpcs8WHp2nKCO_ax9-lYZWo",
  authDomain:"poladent-5fa13.firebaseapp.com",
  databaseURL:"https://poladent-5fa13-default-rtdb.firebaseio.com",
  projectId:"poladent-5fa13",
  storageBucket:"poladent-5fa13.firebasestorage.app",
  messagingSenderId:"539152567873",
  appId:"1:539152567873:web:89c67ebb14bd55a77900c0"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(), db=firebase.database();

// ðŸŒ NAVEGACIÃ“N
function hideAll(){
  home.classList.add("hidden");
  adminLogin.classList.add("hidden");
  adminPanel.classList.add("hidden");
  employeePanel.classList.add("hidden");
}
function backHome(){
  hideAll();
  home.classList.remove("hidden");
  document.getElementById("empNombreGrande").innerHTML="";
  document.getElementById("empPin").value="";
  document.getElementById("employeeButtons").classList.add("hidden");
  document.getElementById("empMsg").innerHTML="";
}
function goAdmin(){hideAll();adminLogin.classList.remove("hidden");}
function goEmployee(){hideAll();employeePanel.classList.remove("hidden");}

// ðŸ‘¤ ADMIN LOGIN
function loginAdmin(){
  auth.signInWithEmailAndPassword(adminEmail.value,adminPass.value)
  .then(()=>{
    hideAll();
    adminPanel.classList.remove("hidden");
    setDefaultDate();
    loadEmpleados();
    loadMarcaciones();
    renderSalario();
  })
  .catch(()=>alert("Error de acceso"));
}
function logout(){auth.signOut();backHome();}

// ðŸ‘· AGREGAR Y BORRAR EMPLEADOS
function agregarEmpleado(){
  const nombre=document.getElementById("nombreEmpleado").value.trim();
  const pin=document.getElementById("pinEmpleado").value.trim();
  if(!nombre||!pin){alert("Completa todos los campos");return;}
  const id=db.ref("empleados").push().key;
  db.ref("empleados/"+id).set({nombre,pin,creado:Date.now()});
  document.getElementById("nombreEmpleado").value="";
  document.getElementById("pinEmpleado").value="";
}
function cargarEmpleados(){
  const contenedor=document.getElementById("listaEmpleados");
  db.ref("empleados").on("value",snap=>{
    contenedor.innerHTML="";
    snap.forEach(emp=>{
      const data=emp.val();
      contenedor.innerHTML+=`<div class="empleado">
        <strong>${data.nombre}</strong><br>
        PIN: ${data.pin}<br>
        <button class="danger" onclick="borrarEmpleado('${emp.key}')">Borrar</button>
        <button onclick="verResumenEmpleado('${emp.key}')">Resumen</button>
      </div>`;
    });
  });
}
function loadEmpleados(){cargarEmpleados();}
function borrarEmpleado(id){
  if(confirm("Â¿Seguro que deseas borrar este empleado?")){
    db.ref("empleados/"+id).remove();
    db.ref("marcaciones/"+id).remove();
  }
}

// ðŸ‘· EMPLEADO â€“ PIN + BOTONES DINÃMICOS + FRASES + GPS
let empleadoActual=null;
function mark(tipo){
  if(!empleadoActual) return;
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const lat=pos.coords.latitude, lon=pos.coords.longitude;
      const now=new Date();
      const yyyy=now.getFullYear(), mm=now.getMonth()+1, dd=now.getDate();
      const fecha=`${yyyy}-${mm<10?'0'+mm:mm}-${dd<10?'0'+dd:dd}`;
      const hora=now.toLocaleTimeString(), timestamp=now.getTime();
      const ref=db.ref("marcaciones/"+empleadoActual.id+"/"+fecha+"/"+tipo);
      ref.once("value",s=>{
        if(s.exists()){document.getElementById("empMsg").innerHTML="âš ï¸ Ya marcado";}
        else{
          ref.set({nombre:empleadoActual.nombre,tipo,fecha,hora,timestamp,lat,lon});
          let frase="";
          if(tipo=="entrada") frase="Â¡Que tengas un buen inicio de jornada!";
          if(tipo=="almuerzo_salida") frase="Buen provecho ðŸ½ï¸";
          if(tipo=="almuerzo_regreso") frase="Bienvenido de vuelta ðŸ‘‹";
          if(tipo=="salida") frase="Â¡Buen trabajo!";
          document.getElementById("empMsg").innerHTML=`${empleadoActual.nombre} | ${frase} (${hora})`;
          mostrarNotificacion(`${empleadoActual.nombre} marcÃ³ ${tipo} a las ${hora}`);
          setTimeout(backHome,2000);
          loadMarcaciones();
          renderSalario();
        }
      });
    },err=>alert("No se pudo obtener ubicaciÃ³n GPS"));
  } else alert("GPS no disponible");
}
document.getElementById("empPin").addEventListener("change",()=>{
  const pin=document.getElementById("empPin").value.trim();
  if(!pin) return;
  db.ref("empleados").orderByChild("pin").equalTo(pin).once("value",snap=>{
    if(!snap.exists()){alert("PIN no encontrado");document.getElementById("employeeButtons").classList.add("hidden"); return;}
    snap.forEach(empSnap=>{
      empleadoActual={id:empSnap.key,nombre:empSnap.val().nombre};
      document.getElementById("empNombreGrande").innerHTML=empleadoActual.nombre;
      document.getElementById("employeeButtons").classList.remove("hidden");
      document.getElementById("empMsg").innerHTML="";
    });
  });
});

// ðŸ“ ADMIN â€“ RESUMEN, NOTIFICACIONES, HORAS Y BANCO DE HORAS
let excelRows=[], excelSalarial=[], allMarcaciones={};
function loadMarcaciones(){
  db.ref("marcaciones").on("value",snap=>{
    allMarcaciones=snap.val()||{};
    renderAdminList(document.getElementById("filterDate").value);
    renderSalario();
  });
}

function renderAdminList(dateFilter){
  const cont=document.getElementById("adminList"), notif=document.getElementById("notificaciones");
  cont.innerHTML=""; notif.innerHTML=""; excelRows=[]; excelSalarial=[];
  if(!allMarcaciones) return;
  const periodo=document.getElementById("periodoResumen").value;
  for(const empID in allMarcaciones){
    const fechas=allMarcaciones[empID];
    for(const fecha in fechas){
      if(dateFilter && !fecha.startsWith(dateFilter.substring(0,7)) && periodo!=="diario") continue;
      if(periodo==="diario" && dateFilter && fecha!==dateFilter) continue;
      const tipos=fechas[fecha];
      const sorted=Object.values(tipos).sort((a,b)=>a.timestamp-b.timestamp);
      sorted.forEach(data=>{
        cont.innerHTML+=`<p><b>${data.nombre}</b> | ${data.tipo} | ${fecha} | ${data.hora}</p>`;
        excelRows.push([data.nombre,fecha,data.tipo,data.hora]);
        excelSalarial.push({nombre:data.nombre,fecha:data.fecha,tipo:data.tipo,timestamp:data.timestamp});
        notif.innerHTML+=`<div class="notif">${data.nombre} marcÃ³ ${data.tipo} a las ${data.hora}</div>`;
      });
    }
  }
}

// ðŸ“Š EXPORTAR EXCEL
function exportExcel(){
  let wb=XLSX.utils.book_new();
  let ws=XLSX.utils.aoa_to_sheet([["Nombre","Fecha","Tipo","Hora"],...excelRows]);
  XLSX.utils.book_append_sheet(wb,ws,"Resumen");
  XLSX.writeFile(wb,"Poladent_Marcaciones.xlsx");
}

// ðŸ¦ SALARIO + BANCO DE HORAS + OLERITE (E5)
function renderSalario(){
  const cont=document.getElementById("salarioList");
  const periodo=document.getElementById("periodoSalario").value;
  cont.innerHTML="";
  let resumen={};
  for(const empID in allMarcaciones){
    const fechas=allMarcaciones[empID];
    for(const fecha in fechas){
      if(periodo==="diario" && fecha!==document.getElementById("filterDate").value) continue;
      if(periodo==="quincenal"){
        const day=parseInt(fecha.split("-")[2]);
        if(day>15) continue;
      }
      const tipos=fechas[fecha];
      const sorted=Object.values(tipos).sort((a,b)=>a.timestamp-b.timestamp);
      sorted.forEach(data=>{
        if(!resumen[data.nombre]) resumen[data.nombre]={dias:{}};
        if(!resumen[data.nombre].dias[data.fecha]) resumen[data.nombre].dias[data.fecha]={entrada:null,salida:null};
        if(data.tipo==="entrada") resumen[data.nombre].dias[data.fecha].entrada=data.timestamp;
        if(data.tipo==="salida") resumen[data.nombre].dias[data.fecha].salida=data.timestamp;
      });
    }
  }
  for(const emp in resumen){
    let bancoTotal=0;
    let html=`<p><b>${emp}</b> <button onclick="generarOlerite('${emp}')">Olerite PDF</button></p><ul>`;
    for(const dia in resumen[emp].dias){
      const ent=resumen[emp].dias[dia].entrada;
      const sal=resumen[emp].dias[dia].salida;
      if(!ent||!sal) continue;
      let hrs=(sal-ent)/3600000;
      let extra=Math.max(0,hrs-8);
      let normales=Math.min(8,hrs);
      bancoTotal+=extra;
      html+=`<li>${dia}: Horas normales: ${normales.toFixed(2)}, Extra: ${extra.toFixed(2)}, Banco: ${bancoTotal.toFixed(2)}</li>`;
    }
    html+="</ul><hr>";
    cont.innerHTML+=html;
  }
}
function exportExcelSalarial(){
  const wsData=[["Nombre","Fecha","Horas normales","Horas extra","Banco de horas"]];
  const resumen={};
  for(const empID in allMarcaciones){
    const fechas=allMarcaciones[empID];
    for(const fecha in fechas){
      const tipos=fechas[fecha];
      const sorted=Object.values(tipos).sort((a,b)=>a.timestamp-b.timestamp);
      sorted.forEach(data=>{
        if(!resumen[data.nombre]) resumen[data.nombre]={dias:{}};
        if(!resumen[data.nombre].dias[data.fecha]) resumen[data.nombre].dias[data.fecha]={entrada:null,salida:null};
        if(data.tipo==="entrada") resumen[data.nombre].dias[data.fecha].entrada=data.timestamp;
        if(data.tipo==="salida") resumen[data.nombre].dias[data.fecha].salida=data.timestamp;
      });
    }
  }
  for(const emp in resumen){
    let bancoTotal=0;
    for(const dia in resumen[emp].dias){
      const ent=resumen[emp].dias[dia].entrada;
      const sal=resumen[emp].dias[dia].salida;
      if(!ent||!sal) continue;
      let hrs=(sal-ent)/3600000;
      let extra=Math.max(0,hrs-8);
      let normales=Math.min(8,hrs);
      bancoTotal+=extra;
      wsData.push([emp,dia,normales.toFixed(2),extra.toFixed(2),bancoTotal.toFixed(2)]);
    }
  }
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet(wsData);
  XLSX.utils.book_append_sheet(wb,ws,"Salario");
  XLSX.writeFile(wb,"Poladent_Salario.xlsx");
}

// ðŸ“ GENERAR OLERITE PDF
function generarOlerite(nombre){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(18);
  doc.text("Poladent - Olerite de Pago",20,20);
  doc.setFontSize(14);
  doc.text("Empleado: "+nombre,20,30);
  const periodo=document.getElementById("periodoSalario").value;
  doc.text("Periodo: "+periodo,20,40);
  const resumen={};
  for(const empID in allMarcaciones){
    const fechas=allMarcaciones[empID];
    for(const fecha in fechas){
      const tipos=fechas[fecha];
      const sorted=Object.values(tipos).sort((a,b)=>a.timestamp-b.timestamp);
      sorted.forEach(data=>{
        if(data.nombre!==nombre) return;
        if(!resumen[data.fecha]) resumen[data.fecha]={entrada:null,salida:null};
        if(data.tipo==="entrada") resumen[data.fecha].entrada=data.timestamp;
        if(data.tipo==="salida") resumen[data.fecha].salida=data.timestamp;
      });
    }
  }
  let y=50,bancoTotal=0;
  for(const dia in resumen){
    const ent=resumen[dia].entrada;
    const sal=resumen[dia].salida;
    if(!ent||!sal) continue;
    let hrs=(sal
