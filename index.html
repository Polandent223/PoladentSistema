<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ðŸ¦· Poladent Control Total</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body{font-family:Arial;background:#eef7ff;margin:0}
header{background:#4da3ff;color:white;padding:15px;text-align:center}
.panel{display:none;padding:20px}
.card{background:white;padding:15px;border-radius:12px;margin-bottom:15px;box-shadow:0 4px 10px rgba(0,0,0,.1)}
button{background:#4da3ff;color:white;border:none;padding:10px 15px;border-radius:8px;margin:5px}
input{padding:10px;width:90%;margin:5px}
.notificacion{background:#e6f4ff;padding:10px;border-radius:8px;margin:5px}
.empleadoItem{display:flex;justify-content:space-between;align-items:center}
.borrar{background:#ff4d4d}
</style>
</head>

<body>
<header><h2>ðŸ¦· Poladent â€“ Control de Asistencia</h2></header>

<!-- SELECCIÃ“N -->
<div id="seleccion" class="panel" style="display:block;text-align:center">
  <button onclick="mostrarLoginAdmin()">Administrador</button>
  <button onclick="mostrarLoginEmpleado()">Empleado</button>
</div>

<!-- LOGIN ADMIN -->
<div id="loginAdminPanel" class="panel">
  <div class="card">
    <h3>Administrador</h3>
    <input type="password" id="adminPass" placeholder="ContraseÃ±a">
    <button onclick="entrarAdmin()">Entrar</button>
  </div>
</div>

<!-- LOGIN EMP -->
<div id="loginEmpPanel" class="panel">
  <div class="card">
    <h3>Empleado</h3>
    <input id="empLoginNombre" placeholder="Nombre">
    <input id="empLoginPin" type="password" placeholder="PIN">
    <button onclick="entrarEmpleado()">Entrar</button>
  </div>
</div>

<!-- PANEL ADMIN -->
<div id="adminPanel" class="panel">

  <div class="card">
    <h3>Panel Administrador</h3>
    <button onclick="location.reload()">Cerrar sesiÃ³n</button>
  </div>

  <div class="card">
    <h4>Registrar empleado</h4>
    <input id="empNombre" placeholder="Nombre">
    <input id="empPin" placeholder="PIN">
    <button onclick="crearEmpleado()">Guardar</button>
  </div>

  <div class="card">
    <h4>Empleados registrados</h4>
    <div id="listaEmpleados"></div>
  </div>

  <div class="card">
    <h4>CÃ³digo QR del escritorio</h4>
    <div id="qrcode"></div>
  </div>

  <div class="card">
    <h4>Exportar Excel</h4>
    <button onclick="exportarExcel()">Exportar</button>
  </div>

</div>

<!-- PANEL EMPLEADO -->
<div id="empleadoPanel" class="panel">
  <div class="card">
    <h2 id="empNombreGrande"></h2>
    <button onclick="marcar('Entrada','Buen trabajo ðŸ’™')">Entrada</button>
    <button onclick="marcar('Almuerzo','Buen provecho ðŸ½ï¸')">Almuerzo</button>
    <button onclick="marcar('Regreso','Buen regreso ðŸ’ª')">Regreso</button>
    <button onclick="marcar('Salida','Gracias por tu dÃ­a ðŸ‘')">Salida</button>
    <br><button onclick="location.reload()">Cerrar sesiÃ³n</button>
  </div>

  <div class="card">
    <h4>Mis marcaciones</h4>
    <div id="misMarcaciones"></div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAFOyMEo2SgWpcs8WHp2nKCO_ax9-lYZWo",
  authDomain: "poladent-5fa13.firebaseapp.com",
  databaseURL: "https://poladent-5fa13-default-rtdb.firebaseio.com",
  projectId: "poladent-5fa13",
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

let empleadoActual="", ultimoTipo="";

function mostrarLoginAdmin(){
  document.getElementById("seleccion").style.display="none";
  document.getElementById("loginAdminPanel").style.display="block";
}

function mostrarLoginEmpleado(){
  document.getElementById("seleccion").style.display="none";
  document.getElementById("loginEmpPanel").style.display="block";
}

function entrarAdmin(){
  if(document.getElementById("adminPass").value==="Poladen2026"){
    document.getElementById("loginAdminPanel").style.display="none";
    document.getElementById("adminPanel").style.display="block";
    cargarEmpleados();
    document.getElementById("qrcode").innerHTML="";
    new QRCode(document.getElementById("qrcode"),location.href);
  } else alert("ContraseÃ±a incorrecta");
}

function crearEmpleado(){
  const n=empNombre.value,p=empPin.value;
  if(!n||!p) return;
  db.ref("empleados").push({nombre:n,pin:p});
  empNombre.value="";empPin.value="";
}

function cargarEmpleados(){
  db.ref("empleados").on("value",snap=>{
    listaEmpleados.innerHTML="";
    if(!snap.exists()){
      listaEmpleados.innerHTML="<i>No hay empleados</i>";
      return;
    }
    snap.forEach(e=>{
      const d=e.val();
      listaEmpleados.innerHTML+=`
      <div class="empleadoItem">
        <div>${d.nombre} | PIN: ${d.pin}</div>
        <button class="borrar" onclick="db.ref('empleados/${e.key}').remove()">ðŸ—‘</button>
      </div>`;
    });
  });
}

function entrarEmpleado(){
  const n=empLoginNombre.value,p=empLoginPin.value;
  db.ref("empleados").once("value",snap=>{
    let ok=false;
    snap.forEach(e=>{if(e.val().nombre===n && e.val().pin===p) ok=true;});
    if(ok){
      document.getElementById("loginEmpPanel").style.display="none";
      document.getElementById("empleadoPanel").style.display="block";
      empleadoActual=n;
      empNombreGrande.innerText=n;
      cargarMisMarcaciones();
    } else alert("Datos incorrectos");
  });
}

function marcar(tipo,msg){
  if(tipo===ultimoTipo) return alert("Ya marcaste esta opciÃ³n");
  ultimoTipo=tipo;
  const f=new Date();
  navigator.geolocation.getCurrentPosition(pos=>{
    db.ref("marcaciones").push({
      nombre:empleadoActual,
      tipo,
      fecha:f.toLocaleDateString(),
      hora:f.toLocaleTimeString(),
      lat:pos.coords.latitude,
      lng:pos.coords.longitude
    });
    alert(msg);
    cargarMisMarcaciones();
  });
}

function cargarMisMarcaciones(){
  db.ref("marcaciones").orderByChild("nombre").equalTo(empleadoActual)
  .limitToLast(10).once("value",snap=>{
    misMarcaciones.innerHTML="";
    snap.forEach(e=>{
      const d=e.val();
      misMarcaciones.innerHTML+=`<div class="notificacion">${d.tipo} - ${d.fecha} ${d.hora}</div>`;
    });
  });
}

function exportarExcel(){
  db.ref("marcaciones").once("value",snap=>{
    const data=[];
    snap.forEach(e=>data.push(e.val()));
    const ws=XLSX.utils.json_to_sheet(data);
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,"Poladent");
    XLSX.writeFile(wb,"Poladent.xlsx");
  });
}
</script>
</body>
  </html>
