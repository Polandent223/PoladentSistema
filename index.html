<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Poladent ‚Äì Sistema Completo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial;background:#eaf6ff;padding:20px;text-align:center;}
h1,h2,h3{text-align:center;}
.card{background:white;padding:20px;border-radius:10px;margin:15px auto;max-width:450px;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
input,button,select{padding:10px;margin:5px;width:90%;font-size:15px;}
button{cursor:pointer;background:#007bff;color:white;border:none;border-radius:5px;}
button.danger{background:#dc3545;}
.hidden{display:none;}
.notice{background:#dff3ff;padding:10px;margin-top:8px;border-radius:6px;}
.empleado{border-bottom:1px solid #ddd;padding:10px 0;display:flex;flex-direction:column;}
.nombreGrande{font-size:24px;font-weight:bold;margin-bottom:10px;}
.notif{background:#fff3cd;padding:10px;margin:5px;border-radius:5px;border:1px solid #ffeeba;}
.empActions{margin-top:5px; display:flex; gap:5px;}
.toggleButton{background:#17a2b8;margin-top:5px;}
</style>
</head>

<body>

<h1>Poladent ü¶∑ü¶∑</h1>

<!-- Home -->
<div id="home" class="card">
  <button onclick="goAdmin()">Administrador</button>
  <button onclick="goEmployee()">Empleado</button>
</div>

<!-- Admin Login -->
<div id="adminLogin" class="card hidden">
  <h3>Administrador</h3>
  <input id="adminEmail" placeholder="Correo">
  <input id="adminPass" type="password" placeholder="Contrase√±a">
  <br>
  <button onclick="loginAdmin()">Entrar</button>
  <button onclick="backHome()">Volver</button>
</div>

<!-- Admin Panel -->
<div id="adminPanel" class="card hidden">
  <h3>Panel Administrador</h3>

  <!-- Agregar empleado -->
  <div class="card">
    <h4>Agregar empleado</h4>
    <input id="nombreEmpleado" placeholder="Nombre del empleado">
    <input id="pinEmpleado" placeholder="PIN del empleado">
    <button onclick="agregarEmpleado()">Guardar empleado</button>
  </div>

  <!-- Empleados registrados (toggle) -->
  <div class="card">
    <button class="toggleButton" onclick="toggleEmpleados()">Empleados registrados</button>
    <div id="listaEmpleados" class="hidden"></div>
  </div>

  <!-- Resumen de marcaciones (toggle) -->
  <div class="card">
    <button class="toggleButton" onclick="toggleResumen()">Resumen de marcaciones</button>
    <div id="resumenPanel" class="hidden">
      <input type="date" id="filterDate" onchange="filterByDate()">
      <select id="periodoResumen" onchange="filterByDate()">
        <option value="diario">Diario</option>
        <option value="quincenal">Quincenal</option>
        <option value="mensual">Mensual</option>
      </select>
      <div id="adminList"></div>
      <div id="notificaciones"></div>
      <button onclick="exportExcelFiltro()">Exportar Marcaciones</button>
      <button onclick="exportExcelSalarialFiltro()">Exportar Salario</button>
    </div>
  </div>

  <button onclick="logout()">Salir</button>
</div>

<!-- Employee Panel -->
<div id="employeePanel" class="card hidden">
  <div class="nombreGrande" id="empNombreGrande"></div>
  <input id="empPin" type="password" placeholder="Ingresa tu PIN">
  <br>
  <div id="employeeButtons" class="hidden">
    <button onclick="mark('entrada')">Entrada</button>
    <button onclick="mark('almuerzo_salida')">Salida Almuerzo</button>
    <button onclick="mark('almuerzo_regreso')">Regreso Almuerzo</button>
    <button onclick="mark('salida')">Salida</button>
  </div>
  <div id="empMsg" class="notice"></div>
  <button onclick="backHome()">Volver</button>
</div>

<script>
// üî• FIREBASE CONFIG
const firebaseConfig={
apiKey:"AIzaSyAFOyMEo2SgWpcs8WHp2nKCO_ax9-lYZWo",
authDomain:"poladent-5fa13.firebaseapp.com",
databaseURL:"https://poladent-5fa13-default-rtdb.firebaseio.com",
projectId:"poladent-5fa13",
storageBucket:"poladent-5fa13.firebasestorage.app",
messagingSenderId:"539152567873",
appId:"1:539152567873:web:89c67ebb14bd55a77900c0"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(), db=firebase.database();

// üåê NAVEGACI√ìN
function hideAll(){home.classList.add("hidden");adminLogin.classList.add("hidden");adminPanel.classList.add("hidden");employeePanel.classList.add("hidden");}
function backHome(){hideAll();home.classList.remove("hidden");document.getElementById("empNombreGrande").innerHTML="";document.getElementById("empPin").value="";document.getElementById("employeeButtons").classList.add("hidden");document.getElementById("empMsg").innerHTML="";}
function goAdmin(){hideAll();adminLogin.classList.remove("hidden");}
function goEmployee(){hideAll();employeePanel.classList.remove("hidden");}

// üë§ ADMIN LOGIN
function loginAdmin(){auth.signInWithEmailAndPassword(adminEmail.value,adminPass.value).then(()=>{hideAll();adminPanel.classList.remove("hidden");setDefaultDate();loadEmpleados();loadMarcaciones();}).catch(()=>alert("Error de acceso"));}
function logout(){auth.signOut();backHome();}

// üë∑ AGREGAR Y BORRAR EMPLEADOS
function agregarEmpleado(){const nombre=document.getElementById("nombreEmpleado").value.trim();const pin=document.getElementById("pinEmpleado").value.trim();if(!nombre||!pin){alert("Completa todos los campos");return;}const id=db.ref("empleados").push().key;db.ref("empleados/"+id).set({nombre,pin,creado:Date.now(),salario:0,tipoSalario:"diario"});document.getElementById("nombreEmpleado").value="";document.getElementById("pinEmpleado").value="";}
function cargarEmpleados(){const cont=document.getElementById("listaEmpleados");db.ref("empleados").on("value",snap=>{contenedor=cont;contenedor.innerHTML="";snap.forEach(emp=>{const data=emp.val();contenedor.innerHTML+=`<div class="empleado"><strong>${data.nombre}</strong><br>PIN: ${data.pin}<br>Salario: ${data.salario} (${data.tipoSalario})<div class="empActions"><button onclick="borrarEmpleado('${emp.key}')">Borrar</button><button onclick="asignarSalario('${emp.key}')">Asignar Salario</button><button onclick="generarOlerite('${emp.key}')">Olerite PDF</button></div></div>`;});});}
function loadEmpleados(){cargarEmpleados();}
function borrarEmpleado(id){if(confirm("¬øSeguro que deseas borrar este empleado?")){db.ref("empleados/"+id).remove();db.ref("marcaciones/"+id).remove();}}
function asignarSalario(empID){const salario=prompt("Ingresa el salario:");if(!salario) return;const tipo=prompt("Tipo de salario (diario/quincenal/mensual):","diario");db.ref("empleados/"+empID).update({salario:parseFloat(salario),tipoSalario:tipo});loadEmpleados();}
function generarOlerite(empID){db.ref("empleados/"+empID).once("value",snap=>{const emp=snap.val();if(!emp) return;const { jsPDF }=window.jspdf;const doc=new jsPDF();doc.setFontSize(20);doc.text("Olerite de Pago",20,20);doc.setFontSize(14);doc.text(`Empleado: ${emp.nombre}`,20,40);doc.text(`Salario: ${emp.salario} (${emp.tipoSalario})`,20,50);doc.text(`Fecha: ${new Date().toLocaleDateString()}`,20,60);doc.save(`Olerite_${emp.nombre}.pdf`);});}

// üë∑ EMPLEADO ‚Äì PIN + BOTONES DIN√ÅMICOS + CONTROL ORDEN
let empleadoActual=null;let marcacionesActuales={};
function mark(tipo){
  if(!empleadoActual) return;
  // control de orden
  const orden=["entrada","almuerzo_salida","almuerzo_regreso","salida"];
  const ultimo=marcacionesActuales[tipoDiaActual()]||[];
  const lastTipo=ultimo.length?ultimo[ultimo.length-1].tipo:null;
  if(lastTipo && orden.indexOf(tipo)<orden.indexOf(lastTipo)){alert("Debes seguir el orden de marcaciones");return;}
  
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const lat=pos.coords.latitude, lon=pos.coords.longitude;
      const now=new Date();
      const yyyy=now.getFullYear(), mm=now.getMonth()+1, dd=now.getDate();
      const fecha=`${yyyy}-${mm<10?'0'+mm:mm}-${dd<10?'0'+dd:dd}`;
      const hora=now.toLocaleTimeString(), timestamp=now.getTime();
      const ref=db.ref("marcaciones/"+empleadoActual.id+"/"+fecha+"/"+tipo);
      ref.once("value",s=>{if(s.exists()){document.getElementById("empMsg").innerHTML="‚ö†Ô∏è Ya marcado";}else{ref.set({nombre:empleadoActual.nombre,tipo,fecha,hora,timestamp,lat,lon});let frase="";if(tipo=="entrada")frase="¬°Que tengas un buen inicio de jornada!";if(tipo=="almuerzo_salida")frase="Buen provecho üçΩÔ∏è";if(tipo=="almuerzo_regreso")frase="Bienvenido de vuelta üëã";if(tipo=="salida")frase="¬°Buen trabajo!";document.getElementById("empMsg").innerHTML=`${empleadoActual.nombre} | ${frase} (${hora})`;mostrarNotificacion(`${empleadoActual.nombre} marc√≥ ${tipo} a las ${hora}`);setTimeout(backHome,2000);loadMarcaciones();}});},err=>alert("No se pudo obtener ubicaci√≥n GPS"));}else alert("GPS no disponible");}
function tipoDiaActual(){const today=new Date();let mm=today.getMonth()+1;if(mm<10)mm="0"+mm;let dd=today.getDate();if(dd<10)dd="0"+dd;const yyyy=today.getFullYear();return `${yyyy}-${mm}-${dd}`;}
document.getElementById("empPin").addEventListener("change",()=>{const pin=document.getElementById("empPin").value.trim();if(!pin) return;db.ref("empleados").orderByChild("pin").equalTo(pin).once("value",snap=>{if(!snap.exists()){alert("PIN no encontrado");document.getElementById("employeeButtons").classList.add("hidden"); return;}snap.forEach(empSnap=>{empleadoActual={id:empSnap.key,nombre:empSnap.val().nombre};document.getElementById("empNombreGrande").innerHTML=empleadoActual.nombre;document.getElementById("employeeButtons").classList.remove("hidden");document.getElementById("empMsg").innerHTML="";cargarMarcacionesActuales();});});});
function cargarMarcacionesActuales(){marcacionesActuales={};const fecha=tipoDiaActual();if(!empleadoActual) return;db.ref("marcaciones/"+empleadoActual.id+"/"+fecha).once("value",snap=>{snap.forEach(s=>{if(!marcacionesActuales[fecha])marcacionesActuales[fecha]=[];marcacionesActuales[fecha].push(s.val());});});}

// üìù ADMIN ‚Äì RESUMEN Y NOTIFICACIONES
let excelRows=[], excelSalarial=[], allMarcaciones={};
function loadMarcaciones(){db.ref("marcaciones").on("value",snap=>{allMarcaciones=snap.val()||{};renderAdminList(document.getElementById("filterDate").value);});}
function renderAdminList(dateFilter){const cont=document.getElementById("adminList"), notif=document.getElementById("notificaciones");cont.innerHTML=""; notif.innerHTML=""; excelRows=[]; excelSalarial=[]; if(!allMarcaciones) return; const periodo=document.getElementById("periodoResumen").value; for(const empID in allMarcaciones){const fechas=allMarcaciones[empID];for(const fecha in fechas){if(dateFilter && !fecha.startsWith(dateFilter.substring(0,7)) && periodo!=="diario") continue;if(periodo==="diario" && dateFilter && fecha!==dateFilter) continue;const tipos=fechas[fecha];const sorted=Object.values(tipos).sort((a,b)=>a.timestamp-b.timestamp);let entradaDia=null,salidaDia=null,totalHoras=0;sorted.forEach(data=>{if(!data.nombre)data.nombre="Sin nombre";cont.innerHTML+=`<p><b>${data.nombre}</b> | ${data.tipo} | ${fecha} | ${data.hora}</p>`;excelRows.push([data.nombre,fecha,data.tipo,data.hora]);excelSalarial.push({nombre:data.nombre,fecha:data.fecha,tipo:data.tipo,timestamp:data.timestamp});notif.innerHTML+=`<div class="notif">${data.nombre} marc√≥ ${data.tipo} a las ${data.hora}</div>`;if(data.tipo==="entrada")entradaDia=data.timestamp;if(data.tipo==="salida")salidaDia=data.timestamp;if(entradaDia && salidaDia)totalHoras=(salidaDia-entradaDia)/3600000;});}}}

// üìä EXPORTAR EXCEL
function exportExcelFiltro(){const fecha=document.getElementById("filterDate").value;const periodo=document.getElementById("periodoResumen").value;const rows=[["Nombre","Fecha","Tipo","Hora"]];for(const m of excelRows){const mFecha=m[1];if(periodo==="diario" && mFecha!==fecha) continue;if(periodo==="quincenal" && !mFecha.startsWith(fecha.substring(0,7))) continue;if(periodo==="mensual" && !mFecha.startsWith(fecha.substring(0,4)+"-"+fecha.substring(5,7))) continue;rows.push(m);}const wb=XLSX.utils.book_new();const ws=XLSX.utils.aoa_to_sheet(rows);XLSX.utils.book_append_sheet(wb,ws,"Resumen");XLSX.writeFile(wb,"Poladent_Marcaciones_Filtro.xlsx");}
function exportExcelSalarialFiltro(){const fecha=document.getElementById("filterDate").value;const periodo=document.getElementById("periodoResumen").value;const resumen={};for(const m of excelSalarial){const mFecha=m.fecha;if(periodo==="diario" && mFecha!==fecha) continue;if(periodo==="quincenal" && !mFecha.startsWith(fecha.substring(0,7))) continue;if(periodo==="mensual" && !mFecha.startsWith(fecha.substring(0,4)+"-"+fecha.substring(5,7))) continue;if(!resumen[m.nombre])resumen[m.nombre]={dias:{}};if(!resumen[m.nombre].dias[mFecha])resumen[m.nombre].dias[mFecha]={entrada:null,salida:null};if(m.tipo==="entrada")resumen[m.nombre].dias[mFecha].entrada=m.timestamp;if(m.tipo==="salida")resumen[m.nombre].dias[mFecha].salida=m.timestamp;}const wsData=[["Nombre","Fecha","Horas trabajadas","Horas extra","Banco de horas"]];for(const emp in resumen){let bancoTotal=0;for(const dia in resumen[emp].dias){const ent=resumen[emp].dias[dia].entrada;const sal=resumen[emp].dias[dia].salida;if(!ent||!sal)continue;let hrs=(sal-ent)/3600000;let extra=Math.max(0,hrs-8);let normales=Math.min(8,hrs);bancoTotal+=extra;wsData.push([emp,dia,normales.toFixed(2),extra.toFixed(2),bancoTotal.toFixed(2)]);}}const wb=XLSX.utils.book_new();const ws=XLSX.utils.aoa_to_sheet(wsData);XLSX.utils.book_append_sheet(wb,ws,"Salario");XLSX.writeFile(wb,"Poladent_Salario_Filtro.xlsx");}

// üìÖ CALENDARIO
function setDefaultDate(){const today=new Date();let month=today.getMonth()+1;if(month<10)month="0"+month;let day=today.getDate();if(day<10)day="0"+day;const yyyy=today..getFullYear();
  document.getElementById("filterDate").value=`${yyyy}-${month}-${day}`;
}
function filterByDate(){renderAdminList(document.getElementById("filterDate").value);}

// üîî NOTIFICACIONES
function mostrarNotificacion(text){
  const notif=document.getElementById("notificaciones");
  const div=document.createElement("div");
  div.className="notif";
  div.innerText=text;
  notif.prepend(div);
}

// üîπ FUNCIONES TOGGLE PARA LIMPIEZA
function toggleResumen(){
  const panel=document.getElementById("resumenPanel");
  panel.classList.toggle("hidden");
}
function toggleEmpleados(){
  const panel=document.getElementById("listaEmpleados");
  panel.classList.toggle("hidden");
}

// üîπ INICIO
backHome();
setDefaultDate();
</script>
</body>
</html>
