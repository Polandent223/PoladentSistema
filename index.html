<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Poladent ‚Äì Sistema Completo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body{font-family:Arial;background:#eaf6ff;padding:20px;text-align:center;}
h1,h2,h3{text-align:center;}
.card{background:white;padding:20px;border-radius:10px;margin:15px auto;max-width:500px;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
input,button,select{padding:10px;margin:5px;width:90%;font-size:15px;}
button{cursor:pointer;background:#007bff;color:white;border:none;border-radius:5px;}
button.danger{background:#dc3545;}
.hidden{display:none;}
.notice{background:#dff3ff;padding:10px;margin-top:8px;border-radius:6px;}
.empleado{border-bottom:1px solid #ddd;padding:10px 0;display:flex;justify-content:space-between;align-items:center;}
.nombreGrande{font-size:24px;font-weight:bold;margin-bottom:10px;}
.notif{background:#fff3cd;padding:10px;margin:5px;border-radius:5px;border:1px solid #ffeeba;}
</style>
</head>
<body>
<h1>Poladent ü¶∑ü¶∑</h1>

<div id="home" class="card">
  <button onclick="goAdmin()">Administrador</button>
  <button onclick="goEmployee()">Empleado</button>
</div>

<div id="adminLogin" class="card hidden">
  <h3>Administrador</h3>
  <input id="adminEmail" placeholder="Correo">
  <input id="adminPass" type="password" placeholder="Contrase√±a">
  <br>
  <button onclick="loginAdmin()">Entrar</button>
  <button onclick="backHome()">Volver</button>
</div>

<div id="adminPanel" class="card hidden">
  <h3>Panel Administrador</h3>

  <!-- Agregar empleado -->
  <div class="card">
    <h4>Agregar empleado</h4>
    <input id="nombreEmpleado" placeholder="Nombre del empleado">
    <input id="pinEmpleado" placeholder="PIN del empleado">
    <button onclick="agregarEmpleado()">Guardar empleado</button>
  </div>

  <!-- Lista empleados -->
  <div class="card">
    <h4>Empleados registrados</h4>
    <div id="listaEmpleados"></div>
  </div>

  <!-- Resumen y alertas -->
  <div class="card">
    <h4>Resumen de marcaciones</h4>
    <input type="date" id="filterDate" onchange="cargarResumen()">
    <select id="periodoResumen" onchange="cargarResumen()">
      <option value="diario">Diario</option>
      <option value="quincenal">Quincenal</option>
      <option value="mensual">Mensual</option>
    </select>
    <div id="resumen"></div>
    <div id="alertas"></div>
    <button onclick="exportExcel()">Exportar Marcaciones</button>
    <button onclick="exportExcelSalarial()">Exportar Salario</button>
  </div>

  <button onclick="logout()">Salir</button>
</div>

<div id="employeePanel" class="card hidden">
  <div class="nombreGrande" id="empNombreGrande"></div>
  <input id="empPin" type="password" placeholder="Ingresa tu PIN">
  <br>
  <div id="employeeButtons" class="hidden">
    <button onclick="marcar('entrada')">Entrada</button>
    <button onclick="marcar('almuerzo_salida')">Salida Almuerzo</button>
    <button onclick="marcar('almuerzo_regreso')">Regreso Almuerzo</button>
    <button onclick="marcar('salida')">Salida</button>
  </div>
  <div id="mensaje" class="notice"></div>
  <button onclick="backHome()">Volver</button>
</div>

<script>
// üî• FIREBASE CONFIG
const firebaseConfig={
  apiKey:"AIzaSyAFOyMEo2SgWpcs8WHp2nKCO_ax9-lYZWo",
  authDomain:"poladent-5fa13.firebaseapp.com",
  databaseURL:"https://poladent-5fa13-default-rtdb.firebaseio.com",
  projectId:"poladent-5fa13",
  storageBucket:"poladent-5fa13.firebasestorage.app",
  messagingSenderId:"539152567873",
  appId:"1:539152567873:web:89c67ebb14bd55a77900c0"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(), db=firebase.database();

// üåê NAVEGACI√ìN
function hideAll(){home.classList.add("hidden"); adminLogin.classList.add("hidden"); adminPanel.classList.add("hidden"); employeePanel.classList.add("hidden");}
function backHome(){hideAll(); home.classList.remove("hidden"); document.getElementById("empNombreGrande").innerHTML=""; document.getElementById("empPin").value=""; document.getElementById("employeeButtons").classList.add("hidden"); document.getElementById("mensaje").innerHTML="";}
function goAdmin(){hideAll();adminLogin.classList.remove("hidden");}
function goEmployee(){hideAll();employeePanel.classList.remove("hidden");}

// üë§ ADMIN LOGIN
function loginAdmin(){auth.signInWithEmailAndPassword(adminEmail.value,adminPass.value).then(()=>{hideAll(); adminPanel.classList.remove("hidden"); setDefaultDate(); cargarEmpleados(); cargarResumen();}).catch(()=>alert("Error de acceso"));}
function logout(){auth.signOut();backHome();}

// üë∑ AGREGAR / BORRAR EMPLEADOS
function agregarEmpleado(){const nombre=document.getElementById("nombreEmpleado").value.trim(); const pin=document.getElementById("pinEmpleado").value.trim(); if(!nombre||!pin){alert("Completa todos los campos");return;} const id=db.ref("empleados").push().key; db.ref("empleados/"+id).set({nombre,pin,creado:Date.now()}); document.getElementById("nombreEmpleado").value=""; document.getElementById("pinEmpleado").value="";}
function cargarEmpleados(){const cont=document.getElementById("listaEmpleados"); db.ref("empleados").on("value",snap=>{ cont.innerHTML=""; snap.forEach(emp=>{ const data=emp.val(); cont.innerHTML+=`<div class="empleado"><span><strong>${data.nombre}</strong></span><span><button class="danger" onclick="borrarEmpleado('${emp.key}')">Borrar</button><button onclick="generarOlerete('${emp.key}')">Olerete PDF</button></span></div>`; }); });}
function borrarEmpleado(id){if(confirm("¬øSeguro que deseas borrar este empleado?")){db.ref("empleados/"+id).remove(); db.ref("marcaciones/"+id).remove();}}

// üë∑ EMPLEADO ‚Äì MARCACIONES TIEMPO REAL
let empleadoActual=null;
function marcar(tipo){if(!empleadoActual) return; if(!navigator.geolocation){alert("GPS no disponible"); return;} navigator.geolocation.getCurrentPosition(pos=>{ const lat=pos.coords.latitude, lon=pos.coords.longitude; const now=new Date(); const fecha=now.toISOString().slice(0,10); const hora=now.toLocaleTimeString(); const ref=db.ref(`marcaciones/${empleadoActual.id}/${fecha}/${tipo}`); ref.once("value").then(s=>{if(s.exists()){document.getElementById("mensaje").innerHTML="‚ö†Ô∏è Ya marcado"; return;} ref.set({nombre:empleadoActual.nombre,tipo,fecha,hora,timestamp:now.getTime(),lat,lon}).then(()=>{document.getElementById("mensaje").innerHTML=`${empleadoActual.nombre} | ${tipo} marcado a las ${hora}`; cargarResumen(); setTimeout(backHome,2000);});}); },err=>alert("No se pudo obtener ubicaci√≥n GPS"));}
document.getElementById("empPin").addEventListener("change",()=>{const pin=document.getElementById("empPin").value.trim(); if(!pin) return; db.ref("empleados").orderByChild("pin").equalTo(pin).once("value").then(snap=>{ if(!snap.exists()){alert("PIN no encontrado");document.getElementById("employeeButtons").classList.add("hidden"); return;} snap.forEach(empSnap=>{empleadoActual={id:empSnap.key,nombre:empSnap.val().nombre}; document.getElementById("empNombreGrande").innerHTML=empleadoActual.nombre; document.getElementById("employeeButtons").classList.remove("hidden"); document.getElementById("mensaje").innerHTML="";});});});

// üìä RESUMEN + SALARIO
function cargarResumen(){
  const cont=document.getElementById("resumen"); const alertas=document.getElementById("alertas"); cont.innerHTML=""; alertas.innerHTML="";
  const periodo=document.getElementById("periodoResumen").value;
  const filtroFecha=document.getElementById("filterDate").value;
  db.ref("marcaciones").on("value",snap=>{
    snap.forEach(empSnap=>{
      const empID=empSnap.key;
      db.ref("empleados/"+empID).once("value").then(empData=>{
        const nombre=empData.val().nombre; const dias=empSnap.val();
        for(const fecha in dias){
          if(periodo==="diario" && filtroFecha && fecha!==filtroFecha) continue;
          const marcaciones=Object.values(dias[fecha]).sort((a,b)=>a.timestamp-b.timestamp);
          let entrada,salida,totalHoras=0;
          marcaciones.forEach(m=>{
            cont.innerHTML+=`<p><b>${nombre}</b> | ${m.tipo} | ${fecha} | ${m.hora}</p>`;
            const divNotif=document.createElement("div"); divNotif.className="notif"; divNotif.innerText=`${nombre} marc√≥ ${m.tipo} a las ${m.hora}`; alertas.prepend(divNotif);
            if(m.tipo==="entrada") entrada=m.timestamp; if(m.tipo==="salida") salida=m.timestamp;
          });
          if(entrada && salida){
            totalHoras=(salida-entrada)/3600000;
            if(new Date(entrada).getHours()>8) alertas.innerHTML+=`<div class="alerta">‚è∞ ${nombre} lleg√≥ tarde</div>`;
            if(new Date(salida).getHours()<17) alertas.innerHTML+=`<div class="alerta">‚ö†Ô∏è ${nombre} sali√≥ temprano</div>`;
          }
        }
      });
    });
  });
}

// üìä EXPORTAR EXCEL
function exportExcel(){let wb=XLSX.utils.book_new(); let excelRows=[["Nombre","Fecha","Tipo","Hora"]]; db.ref("marcaciones").once("value").then(snap=>{ snap.forEach(empSnap=>{ const dias=empSnap.val(); for(const fecha in dias){ for(const tipo in dias[fecha]){ const m=dias[fecha][tipo]; excelRows.push([m.nombre,m.fecha,m.tipo,m.hora]); }}}); let ws=XLSX.utils.aoa_to_sheet(excelRows); XLSX.utils.book_append_sheet(wb,ws,"Resumen"); XLSX.writeFile(wb,"Poladent_Marcaciones.xlsx"); });

// üí∞ EXPORTAR SALARIO
function exportExcelSalarial(){
  let wb=XLSX.utils.book_new(); let wsData=[["Nombre","Fecha","Horas normales","Horas extra","Banco de horas"]];
  db.ref("marcaciones").once("value").then(snap=>{
    snap.forEach(empSnap=>{
      const empID=empSnap.key;
      const dias=empSnap.val(); let bancoHorasTotal=0;
      for(const fecha in dias){
        const marcaciones=Object.values(dias[fecha]).sort((a,b)=>a.timestamp-b.timestamp);
        let entrada,salida;
        marcaciones.forEach(m=>{if(m.tipo==="entrada") entrada=m.timestamp; if(m.tipo==="salida") salida=m.timestamp;});
        if(entrada && salida){
          let hrs=(salida-entrada)/3600000; let extra=Math.max(0,hrs-8); let normales=Math.min(8,hrs); bancoHorasTotal+=extra;
          wsData.push([empSnap.val().nombre,fecha,normales.toFixed(2),extra.toFixed(2),bancoHorasTotal.toFixed(2)]);
        }
      }
    });
    let ws=XLSX.utils.aoa_to_sheet(wsData); XLSX.utils.book_append_sheet(wb,ws,"Salario"); XLSX.writeFile(wb,"Poladent_Salario.xlsx");
  });
}

// üìë GENERAR OLERETE PDF
function generarOlerete(empID){db.ref("empleados/"+empID).once("value").then(empData=>{const nombre=empData.val().nombre; db.ref("marcaciones/"+empID).once("value").then(marcSnap=>{ const doc=new jspdf.jsPDF(); doc.setFontSize(16); doc.text("Poladent ü¶∑",20,20); doc.setFontSize(12); doc.text(`Empleado: ${nombre}`,20,30); doc.text(`Fecha: ${new Date().toLocaleDateString()}`,20,40); let y=50; marcSnap.forEach(fecha=>{for(const tipo in fecha.val()){const m=fecha.val()[tipo]; doc.text(`${m.tipo}: ${m.hora}`,20,y); y+=7;}}); doc.text("Firma: ____________________",20,y+10); doc.save(`${nombre}_Olerete.pdf`);});});}

// üìÖ CALENDARIO
function setDefaultDate(){const today=new Date(); let month=today.getMonth()+1;if(month<10)month="0"+month; let day=today.getDate();if(day<10)day="0"+day; document.getElementById("filterDate").value=`${today.getFullYear()}-${month}-${day}`;}

// üîπ INICIO
backHome();
</script>
</body>
</html>
