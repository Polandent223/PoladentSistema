<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Poladent â€“ Sistema Completo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial;background:#eaf6ff;padding:20px;text-align:center;}
h1,h2,h3{text-align:center;}
.card{background:white;padding:20px;border-radius:10px;margin:15px auto;max-width:450px;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
input,button,select{padding:10px;margin:5px;width:90%;font-size:15px;}
button{cursor:pointer;background:#007bff;color:white;border:none;border-radius:5px;}
button:disabled{background:#999;}
.hidden{display:none;}
.notice{background:#dff3ff;padding:10px;margin-top:8px;border-radius:6px;}
.empleado{border-bottom:1px solid #ddd;padding:10px 0;}
.nombreGrande{font-size:24px;font-weight:bold;margin-bottom:10px;}
.notif{background:#fff3cd;padding:10px;margin:5px;border-radius:5px;border:1px solid #ffeeba;}
.empActions{margin-top:5px; display:flex; gap:5px;}
</style>
</head>

<body>

<h1>Poladent ðŸ¦·ðŸ¦·</h1>

<div id="home" class="card">
  <button onclick="goAdmin()">Administrador</button>
  <button onclick="goEmployee()">Empleado</button>
</div>

<div id="adminLogin" class="card hidden">
  <h3>Administrador</h3>
  <input id="adminEmail" placeholder="Correo">
  <input id="adminPass" type="password" placeholder="ContraseÃ±a">
  <button onclick="loginAdmin()">Entrar</button>
  <button onclick="backHome()">Volver</button>
</div>

<div id="adminPanel" class="card hidden">
  <h3>Panel Administrador</h3>

  <div class="card">
    <h4>Agregar empleado</h4>
    <input id="nombreEmpleado" placeholder="Nombre del empleado">
    <input id="pinEmpleado" placeholder="PIN">
    <button onclick="agregarEmpleado()">Guardar</button>
  </div>

  <div class="card">
    <h4>Empleados</h4>
    <div id="listaEmpleados"></div>
  </div>

  <div class="card">
    <h4>Resumen</h4>
    <input type="date" id="filterDate" onchange="filterByDate()">
    <select id="periodoResumen" onchange="filterByDate()">
      <option value="diario">Diario</option>
      <option value="quincenal">Quincenal</option>
      <option value="mensual">Mensual</option>
    </select>
    <div id="adminList"></div>
    <div id="notificaciones"></div>
    <button onclick="exportExcel()">Exportar Marcaciones</button>
    <button onclick="exportExcelSalarial()">Exportar Salario</button>
  </div>

  <button onclick="logout()">Salir</button>
</div>

<div id="employeePanel" class="card hidden">
  <div class="nombreGrande" id="empNombreGrande"></div>
  <input id="empPin" type="password" placeholder="Ingresa tu PIN">

  <div id="employeeButtons" class="hidden">
    <button onclick="mark('entrada')">Entrada</button>
    <button onclick="mark('almuerzo_salida')">Salida Almuerzo</button>
    <button onclick="mark('almuerzo_regreso')">Regreso Almuerzo</button>
    <button onclick="mark('salida')">Salida</button>
  </div>

  <div id="empMsg" class="notice"></div>
  <button onclick="backHome()">Volver</button>
</div>

<script>
// FIREBASE
const firebaseConfig={
apiKey:"AIzaSyAFOyMEo2SgWpcs8WHp2nKCO_ax9-lYZWo",
authDomain:"poladent-5fa13.firebaseapp.com",
databaseURL:"https://poladent-5fa13-default-rtdb.firebaseio.com",
projectId:"poladent-5fa13"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(), db=firebase.database();

// NAVEGACIÃ“N
function hideAll(){
  home.classList.add("hidden");
  adminLogin.classList.add("hidden");
  adminPanel.classList.add("hidden");
  employeePanel.classList.add("hidden");
}
function backHome(){
  hideAll();
  home.classList.remove("hidden");
  empPin.value="";
  empMsg.innerHTML="";
  employeeButtons.classList.add("hidden");
}
function goAdmin(){hideAll();adminLogin.classList.remove("hidden");}
function goEmployee(){hideAll();employeePanel.classList.remove("hidden");}

// ADMIN
function loginAdmin(){
  auth.signInWithEmailAndPassword(adminEmail.value,adminPass.value)
  .then(()=>{
    hideAll();
    adminPanel.classList.remove("hidden");
    setDefaultDate();
    loadEmpleados();
    loadMarcaciones();
  })
  .catch(()=>alert("Error"));
}
function logout(){auth.signOut();backHome();}

function agregarEmpleado(){
  if(!nombreEmpleado.value||!pinEmpleado.value) return alert("Completa");
  const id=db.ref("empleados").push().key;
  db.ref("empleados/"+id).set({nombre:nombreEmpleado.value,pin:pinEmpleado.value});
  nombreEmpleado.value=""; pinEmpleado.value="";
}

function loadEmpleados(){
  db.ref("empleados").on("value",s=>{
    listaEmpleados.innerHTML="";
    s.forEach(e=>{
      listaEmpleados.innerHTML+=`<div class="empleado"><b>${e.val().nombre}</b> | PIN ${e.val().pin}</div>`;
    });
  });
}

// EMPLEADO + E18
let empleadoActual=null;

function hoy(){
  const d=new Date();
  return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,"0")}-${d.getDate().toString().padStart(2,"0")}`;
}

function actualizarEstadoEmpleado(){
  const fecha=hoy();
  document.querySelectorAll("#employeeButtons button").forEach(b=>b.disabled=true);

  db.ref(`marcaciones/${empleadoActual.id}/${fecha}`).once("value",s=>{
    const m=s.val()||{};
    let estado="entrada";
    if(m.entrada) estado="almuerzo_salida";
    if(m.almuerzo_salida) estado="almuerzo_regreso";
    if(m.almuerzo_regreso) estado="salida";
    if(m.salida) estado="fin";

    document.querySelectorAll("#employeeButtons button").forEach(b=>{
      if(b.getAttribute("onclick").includes(estado)) b.disabled=false;
    });

    let msg="Hoy:<br>";
    Object.values(m).forEach(x=>msg+=`âœ” ${x.tipo} ${x.hora}<br>`);
    empMsg.innerHTML=msg;
  });
}

document.getElementById("empPin").addEventListener("change",()=>{
  db.ref("empleados").orderByChild("pin").equalTo(empPin.value).once("value",s=>{
    if(!s.exists()) return alert("PIN incorrecto");
    s.forEach(e=>{
      empleadoActual={id:e.key,nombre:e.val().nombre};
      empNombreGrande.innerText=empleadoActual.nombre;
      employeeButtons.classList.remove("hidden");
      actualizarEstadoEmpleado();
    });
  });
});

function mark(tipo){
  const fecha=hoy();
  const now=new Date();
  const hora=now.toLocaleTimeString();
  const ts=now.getTime();

  const ref=db.ref(`marcaciones/${empleadoActual.id}/${fecha}/${tipo}`);
  ref.once("value",s=>{
    if(s.exists()) return;
    ref.set({nombre:empleadoActual.nombre,tipo,fecha,hora,timestamp:ts});
    actualizarEstadoEmpleado();
    loadMarcaciones();
  });
}

// ADMIN RESUMEN
let excelRows=[], excelSalarial=[], allMarcaciones={};

function loadMarcaciones(){
  db.ref("marcaciones").on("value",s=>{
    allMarcaciones=s.val()||{};
    renderAdminList(filterDate.value);
  });
}

function renderAdminList(f){
  adminList.innerHTML=""; excelRows=[];
  for(const emp in allMarcaciones){
    for(const fecha in allMarcaciones[emp]){
      if(f && fecha!==f) continue;
      const marcas=allMarcaciones[emp][fecha];
      let ent=false,sal=false;
      Object.values(marcas).forEach(m=>{
        adminList.innerHTML+=`${m.nombre} | ${m.tipo} | ${fecha}<br>`;
        if(m.tipo==="entrada") ent=true;
        if(m.tipo==="salida") sal=true;
      });
      if(ent&&!sal) adminList.innerHTML+="âš  Jornada incompleta<br>";
    }
  }
}

function exportExcel(){}
function exportExcelSalarial(){}

function setDefaultDate(){
  filterDate.value=hoy();
}
function filterByDate(){renderAdminList(filterDate.value);}

backHome();
</script>
</body>
</html>
