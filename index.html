<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Poladent ðŸ¦· Sistema de Control</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body{font-family:Arial;background:#eaf6ff;text-align:center;padding:20px}
.card{background:#fff;padding:20px;margin:15px auto;max-width:500px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
button{padding:10px;width:90%;margin:5px;border:none;border-radius:5px;background:#007bff;color:#fff;font-size:15px}
button.danger{background:#dc3545}
input,select{padding:10px;width:90%;margin:5px}
.hidden{display:none}
.empleado{border-bottom:1px solid #ddd;padding:10px}
.nombreGrande{font-size:26px;font-weight:bold}
.notice{background:#dff3ff;padding:10px;border-radius:6px;margin-top:8px}
</style>
</head>

<body>

<h1>Poladent ðŸ¦·ðŸ¦·</h1>

<div id="home" class="card">
  <button onclick="goAdmin()">Administrador</button>
  <button onclick="goEmpleado()">Empleado</button>
</div>

<!-- ADMIN LOGIN -->
<div id="adminLogin" class="card hidden">
  <h3>Administrador</h3>
  <input id="adminEmail" placeholder="Correo">
  <input id="adminPass" type="password" placeholder="ContraseÃ±a">
  <button onclick="loginAdmin()">Entrar</button>
  <button onclick="backHome()">Volver</button>
</div>

<!-- ADMIN PANEL -->
<div id="adminPanel" class="card hidden">
  <h3>Panel Administrador</h3>

  <h4>Agregar empleado</h4>
  <input id="nombreEmpleado" placeholder="Nombre">
  <input id="pinEmpleado" placeholder="PIN">
  <button onclick="agregarEmpleado()">Guardar</button>

  <h4>Empleados</h4>
  <div id="listaEmpleados"></div>

  <h4>Resumen del dÃ­a</h4>
  <input type="date" id="fechaResumen" onchange="cargarMarcaciones()">
  <div id="resumen"></div>

  <button onclick="exportarExcel()">Exportar Excel</button>
  <button onclick="logout()">Salir</button>
</div>

<!-- EMPLEADO -->
<div id="empleadoPanel" class="card hidden">
  <div id="empNombre" class="nombreGrande"></div>
  <input id="empPin" type="password" placeholder="PIN">
  <div id="botonesEmpleado" class="hidden">
    <button onclick="marcar('entrada')">Entrada</button>
    <button onclick="marcar('almuerzo_salida')">Salida Almuerzo</button>
    <button onclick="marcar('almuerzo_regreso')">Regreso Almuerzo</button>
    <button onclick="marcar('salida')">Salida</button>
  </div>
  <div id="empMsg" class="notice"></div>
  <button onclick="backHome()">Volver</button>
</div>

<script>
// ðŸ”¥ FIREBASE
firebase.initializeApp({
  apiKey: "AIzaSyAFOyMEo2SgWpcs8WHp2nKCO_ax9-lYZWo",
  authDomain: "poladent-5fa13.firebaseapp.com",
  databaseURL: "https://poladent-5fa13-default-rtdb.firebaseio.com",
  projectId: "poladent-5fa13",
  storageBucket: "poladent-5fa13.firebasestorage.app",
  messagingSenderId: "539152567873",
  appId: "1:539152567873:web:89c67ebb14bd55a77900c0"
});

const auth=firebase.auth();
const db=firebase.database();
let empleadoActual=null;

// ðŸ§­ NAVEGACIÃ“N
function hideAll(){
  home.classList.add("hidden");
  adminLogin.classList.add("hidden");
  adminPanel.classList.add("hidden");
  empleadoPanel.classList.add("hidden");
}
function backHome(){hideAll();home.classList.remove("hidden");}
function goAdmin(){hideAll();adminLogin.classList.remove("hidden");}
function goEmpleado(){hideAll();empleadoPanel.classList.remove("hidden");}

// ðŸ” LOGIN ADMIN
function loginAdmin(){
  auth.signInWithEmailAndPassword(adminEmail.value,adminPass.value)
  .then(()=>{
    hideAll();
    adminPanel.classList.remove("hidden");
    fechaResumen.value=new Date().toISOString().slice(0,10);
    cargarEmpleados();
    cargarMarcaciones();
  }).catch(()=>alert("Error de acceso"));
}
function logout(){auth.signOut();backHome();}

// ðŸ‘· EMPLEADOS
function agregarEmpleado(){
  if(!nombreEmpleado.value||!pinEmpleado.value)return alert("Completa todo");
  db.ref("empleados").push({
    nombre:nombreEmpleado.value,
    pin:pinEmpleado.value,
    tipoSalario:"hora",
    valorSalario:0
  });
  nombreEmpleado.value="";pinEmpleado.value="";
}

function cargarEmpleados(){
  listaEmpleados.innerHTML="";
  db.ref("empleados").on("value",snap=>{
    listaEmpleados.innerHTML="";
    snap.forEach(e=>{
      const d=e.val();
      listaEmpleados.innerHTML+=`
      <div class="empleado">
        <b>${d.nombre}</b><br>
        PIN: ${d.pin}<br>
        <select onchange="db.ref('empleados/${e.key}').update({tipoSalario:this.value})">
          <option value="hora" ${d.tipoSalario==="hora"?"selected":""}>Por hora</option>
          <option value="mensual" ${d.tipoSalario==="mensual"?"selected":""}>Mensual</option>
        </select>
        <input type="number" value="${d.valorSalario||0}"
          onchange="db.ref('empleados/${e.key}').update({valorSalario:this.value})">
        <button class="danger" onclick="db.ref('empleados/${e.key}').remove()">Borrar</button>
      </div>`;
    });
  });
}

// ðŸ§‘ EMPLEADO MARCAR
empPin.onchange=()=>{
  db.ref("empleados").orderByChild("pin").equalTo(empPin.value).once("value",s=>{
    if(!s.exists()) return alert("PIN incorrecto");
    s.forEach(e=>{
      empleadoActual={id:e.key,nombre:e.val().nombre};
      empNombre.innerText=e.val().nombre;
      botonesEmpleado.classList.remove("hidden");
    });
  });
};

function marcar(tipo){
  const now=new Date();
  const fecha=now.toISOString().slice(0,10);
  const hora=now.toLocaleTimeString();
  db.ref(`marcaciones/${empleadoActual.id}/${fecha}/${tipo}`).once("value",s=>{
    if(s.exists()) return alert("Ya marcado");
    db.ref(`marcaciones/${empleadoActual.id}/${fecha}/${tipo}`).set({
      nombre:empleadoActual.nombre,
      tipo,fecha,hora,timestamp:Date.now()
    });
    empMsg.innerText=`${empleadoActual.nombre} âœ” ${tipo}`;
    setTimeout(backHome,2000);
  });
}

// ðŸ“Š RESUMEN
function cargarMarcaciones(){
  resumen.innerHTML="";
  const f=fechaResumen.value;
  db.ref("marcaciones").once("value",snap=>{
    snap.forEach(emp=>{
      snap.child(emp.key).child(f).forEach(m=>{
        const d=m.val();
        resumen.innerHTML+=`${d.nombre} | ${d.tipo} | ${d.hora}<br>`;
      });
    });
  });
}

// ðŸ“ EXCEL
function exportarExcel(){
  const rows=[["Nombre","Fecha","Tipo","Hora"]];
  db.ref("marcaciones").once("value",snap=>{
    snap.forEach(emp=>{
      emp.forEach(fecha=>{
        fecha.forEach(m=>{
          const d=m.val();
          rows.push([d.nombre,d.fecha,d.tipo,d.hora]);
        });
      });
    });
    const wb=XLSX.utils.book_new();
    const ws=XLSX.utils.aoa_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb,ws,"Marcaciones");
    XLSX.writeFile(wb,"Poladent.xlsx");
  });
}

backHome();
</script>
</body>
</html>
