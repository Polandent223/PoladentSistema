<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Poladent ‚Äì Control de Asistencia</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background:#eaf6ff;
  margin:0;
  padding:20px;
  text-align:center;
}
button {
  padding:12px 18px;
  margin:6px;
  font-size:15px;
}
input {
  padding:10px;
  margin:5px;
  font-size:15px;
}
.card {
  background:#fff;
  padding:20px;
  border-radius:10px;
  margin-top:15px;
}
.hidden { display:none; }
.notice {
  background:#dff3ff;
  padding:10px;
  margin-top:10px;
  border-radius:6px;
}
</style>
</head>

<body>

<h1>Poladent ü¶∑ü¶∑</h1>

<!-- HOME -->
<div id="home" class="card">
  <button onclick="goAdmin()">Administrador</button>
  <button onclick="goEmployee()">Empleado</button>
</div>

<!-- ADMIN LOGIN -->
<div id="adminLogin" class="card hidden">
  <h3>Administrador</h3>
  <input id="adminEmail" placeholder="Correo">
  <input id="adminPass" type="password" placeholder="Contrase√±a">
  <br>
  <button onclick="loginAdmin()">Entrar</button>
  <button onclick="backHome()">Volver</button>
</div>

<!-- ADMIN PANEL -->
<div id="adminPanel" class="card hidden">
  <h3>Panel Administrador</h3>
  <div id="notifications"></div>
  <div id="adminList"></div>
  <button onclick="logout()">Salir</button>
</div>

<!-- EMPLOYEE -->
<div id="employeePanel" class="card hidden">
  <h3>Empleado</h3>
  <input id="empName" placeholder="Nombre">
  <input id="empPin" type="password" placeholder="PIN">
  <br>
  <button onclick="mark('entrada')">Entrada</button>
  <button onclick="mark('almuerzo_salida')">Salida Almuerzo</button>
  <button onclick="mark('almuerzo_regreso')">Regreso Almuerzo</button>
  <button onclick="mark('salida')">Salida</button>
  <div id="empMsg" class="notice"></div>
  <button onclick="backHome()">Volver</button>
</div>

<script>
// üî• FIREBASE CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyAFOyMEo2SgWpcs8WHp2nKCO_ax9-lYZWo",
  authDomain: "poladent-5fa13.firebaseapp.com",
  databaseURL: "https://poladent-5fa13-default-rtdb.firebaseio.com",
  projectId: "poladent-5fa13",
  storageBucket: "poladent-5fa13.firebasestorage.app",
  messagingSenderId: "539152567873",
  appId: "1:539152567873:web:89c67ebb14bd55a77900c0"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

/* NAVEGACI√ìN */
function hideAll() {
  home.classList.add("hidden");
  adminLogin.classList.add("hidden");
  adminPanel.classList.add("hidden");
  employeePanel.classList.add("hidden");
}
function backHome() { hideAll(); home.classList.remove("hidden"); }
function goAdmin() { hideAll(); adminLogin.classList.remove("hidden"); }
function goEmployee() { hideAll(); employeePanel.classList.remove("hidden"); }

/* ADMIN */
function loginAdmin() {
  auth.signInWithEmailAndPassword(adminEmail.value, adminPass.value)
  .then(()=>{ hideAll(); adminPanel.classList.remove("hidden"); loadAdmin(); })
  .catch(()=>alert("Error de acceso"));
}
function logout() { auth.signOut(); backHome(); }

function loadAdmin() {
  db.ref("marcaciones").on("value", snap=>{
    let html = "";
    let noti = "";
    snap.forEach(day=>{
      day.forEach(emp=>{
        const d = emp.val();
        html += `<p><b>${d.nombre}</b> | ${d.tipo} | ${d.fecha} ${d.hora}</p>`;
        noti = `<div class="notice">${d.nombre} marc√≥ ${d.tipo}</div>`;
      });
    });
    adminList.innerHTML = html || "Sin registros";
    notifications.innerHTML = noti;
  });
}

/* EMPLEADO */
function mark(tipo) {
  if(!empName.value || !empPin.value) {
    alert("Completa nombre y PIN");
    return;
  }
  const now = new Date();
  const fecha = now.toLocaleDateString();
  const hora = now.toLocaleTimeString();

  const ref = db.ref("marcaciones/"+fecha+"/"+empName.value+"_"+empPin.value+"/"+tipo);
  ref.once("value", s=>{
    if(s.exists()) {
      empMsg.innerHTML = "‚ö†Ô∏è Ya marcado";
    } else {
      ref.set({
        nombre: empName.value,
        tipo,
        fecha,
        hora
      });
      empMsg.innerHTML = `‚úî ${tipo} registrada a las ${hora}`;
    }
  });
}

/* INICIO */
backHome();
</script>

</body>
  </html>
