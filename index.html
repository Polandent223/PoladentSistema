<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Poladent ‚Äì Sistema Completo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background:#f4f7fb;
  padding:20px;
  margin:0;
  color:#333;
}
h1{
  margin-bottom:25px;
  text-align:center;
}
h3{
  margin-bottom:15px;
}
.panel{
  max-width:1100px;
  margin:auto;
}
.card{
  background:white;
  padding:20px;
  border-radius:12px;
  margin:18px 0;
  box-shadow:0 4px 12px rgba(0,0,0,0.08);
  text-align:left;
}
.card h4{
  margin-top:15px;
  margin-bottom:10px;
  font-size:18px;
  border-bottom:1px solid #eee;
  padding-bottom:8px;
}
input,select,button{
  padding:10px;
  margin:6px 0;
  font-size:14px;
  border-radius:6px;
  border:1px solid #ccc;
}
button{
  cursor:pointer;
  background:#007bff;
  color:white;
  border:none;
  min-width:140px;
}
button:hover{
  opacity:0.9;
}
button.danger{
  background:#dc3545;
}
.hidden{display:none;}
.notice{
  background:#e7f3ff;
  padding:10px;
  border-radius:6px;
  margin-top:10px;
}
.empleado{
  background:#fafafa;
  border:1px solid #eee;
  padding:12px;
  border-radius:8px;
  margin-bottom:10px;
}
.empActions{
  margin-top:8px;
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}
.nombreGrande{
  font-size:26px;
  font-weight:bold;
  margin-bottom:12px;
  text-align:center;
}
.notif{
  background:#fff8e1;
  border:1px solid #ffe0a3;
  padding:8px;
  border-radius:6px;
  margin-bottom:6px;
}
canvas{
  margin-top:15px;
  background:#fff;
  border-radius:10px;
  padding:10px;
}
</style>
</head>

<body>
<h1>ü¶∑ Poladent ü¶∑</h1>

<!-- HOME -->
<div id="home" class="card">
  <button onclick="goAdmin()">Administrador</button>
  <button onclick="goEmployee()">Empleado</button>
</div>

<!-- ADMIN LOGIN -->
<div id="adminLogin" class="card hidden">
  <h3>Administrador</h3>
  <input id="adminEmail" placeholder="Correo">
  <input id="adminPass" type="password" placeholder="Contrase√±a">
  <br>
  <button onclick="loginAdmin()">Entrar</button>
  <button onclick="backHome()">Volver</button>
</div>

<!-- ADMIN PANEL -->
<div id="adminPanel" class="panel hidden">
  <h3>Panel Administrador</h3>

  <!-- Agregar empleado -->
  <div class="card">
    <h4>Agregar empleado</h4>
    <input id="nombreEmpleado" placeholder="Nombre del empleado">
    <input id="pinEmpleado" placeholder="PIN del empleado">
    <button onclick="agregarEmpleado()">Guardar empleado</button>
  </div>

  <!-- Empleados registrados -->
  <div class="card">
    <h4 style="cursor:pointer;" onclick="toggleSection('listaEmpleados')">üë• Empleados registrados ‚ñº</h4>
    <div id="listaEmpleados" style="max-height:300px; overflow:auto;"></div>
  </div>

  <!-- Resumen marcaciones -->
  <div class="card">
    <h4 style="cursor:pointer;" onclick="toggleSection('adminList')">Resumen de marcaciones ‚ñº</h4>
    <input type="date" id="filterDate" onchange="filterByDate()">
    <select id="periodoResumen" onchange="filterByDate()">
      <option value="diario">Diario</option>
      <option value="quincenal">Quincenal</option>
      <option value="mensual">Mensual</option>
    </select>
    <div id="adminList" style="max-height:300px; overflow:auto;"></div>
  </div>

  <!-- Notificaciones -->
  <div class="card">
    <h4 style="cursor:pointer;" onclick="toggleSection('notificaciones')">Notificaciones ‚ñº</h4>
    <div id="notificaciones" style="max-height:200px; overflow:auto;"></div>
  </div>

  <!-- Botones exportar -->
  <div class="card">
    <button onclick="exportExcelFiltro()">Exportar Marcaciones</button>
    <button onclick="exportExcelSalarialFiltro()">Exportar Salario</button>
  </div>

  <!-- GR√ÅFICO COMPLETO -->
  <div class="card">
    <canvas id="horasChart" width="400" height="200"></canvas>
    <h4>üìä Gr√°fico del d√≠a</h4>
  </div>

  <!-- GR√ÅFICO POR EMPLEADO -->
  <div class="card">
    <label>Desde: <input type="date" id="chartStart" onchange="updateChart()"></label>
    <label>Hasta: <input type="date" id="chartEnd" onchange="updateChart()"></label>
    <canvas id="horasChartEmpleado" width="400" height="200"></canvas>
    <h4>üìä Horas trabajadas por empleado</h4>
  </div>

  <button onclick="logout()">Salir</button>
</div>

<!-- EMPLEADO PANEL -->
<div id="employeePanel" class="card hidden">
  <div class="nombreGrande" id="empNombreGrande"></div>
  <input id="empPin" type="password" placeholder="Ingresa tu PIN">
  <br>
  <div id="employeeButtons" class="hidden">
    <button onclick="mark('entrada')">Entrada</button>
    <button onclick="mark('almuerzo_salida')">Salida Almuerzo</button>
    <button onclick="mark('almuerzo_regreso')">Regreso Almuerzo</button>
    <button onclick="mark('salida')">Salida</button>
  </div>
  <div id="empMsg" class="notice"></div>
  <button onclick="backHome()">Volver</button>
</div>

<script>
// üî• CONFIGURACI√ìN FIREBASE
const firebaseConfig={
  apiKey:"AIzaSyAFOyMEo2SgWpcs8WHp2nKCO_ax9-lYZWo",
  authDomain:"poladent-5fa13.firebaseapp.com",
  databaseURL:"https://poladent-5fa13-default-rtdb.firebaseio.com",
  projectId:"poladent-5fa13",
  storageBucket:"poladent-5fa13.firebasestorage.app",
  messagingSenderId:"539152567873",
  appId:"1:539152567873:web:89c67ebb14bd55a77900c0"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(), db=firebase.database();

// üåê NAVEGACI√ìN
function hideAll(){
  home.classList.add("hidden");
  adminLogin.classList.add("hidden");
  adminPanel.classList.add("hidden");
  employeePanel.classList.add("hidden");
}
function backHome(){
  hideAll();
  home.classList.remove("hidden");
  document.getElementById("empNombreGrande").innerHTML="";
  document.getElementById("empPin").value="";
  document.getElementById("employeeButtons").classList.add("hidden");
  document.getElementById("empMsg").innerHTML="";
}
function goAdmin(){hideAll();adminLogin.classList.remove("hidden");}
function goEmployee(){hideAll();employeePanel.classList.remove("hidden");}

// üë§ LOGIN ADMIN
function loginAdmin(){
  auth.signInWithEmailAndPassword(adminEmail.value,adminPass.value)
  .then(()=>{
    hideAll(); adminPanel.classList.remove("hidden");
    setDefaultDate(); loadEmpleados(); loadMarcaciones(); updateChart();
  })
  .catch(()=>alert("Error de acceso"));
}
function logout(){auth.signOut(); backHome();}

// üîπ Resto de funciones de empleados, marcaciones, exportar, notificaciones, etc. (igual que tu c√≥digo actual)

// üìä GR√ÅFICOS
function renderChart(startDate='', endDate=''){
  const ctx=document.getElementById("horasChart").getContext("2d");
  // mismo c√≥digo de resumen general
  const chartData={labels:[], datasets:[{label:'Horas trabajadas', data:[], backgroundColor:'rgba(0,123,255,0.5)'}]};
  const resumenHoras={};
  for(const empID in allMarcaciones){
    const fechas=allMarcaciones[empID];
    for(const fecha in fechas){
      const fechaObj=new Date(fecha);
      if(startDate && fechaObj<new Date(startDate)) continue;
      if(endDate && fechaObj>new Date(endDate)) continue;
      const tipos=fechas[fecha];
      let entrada=null, salida=null;
      Object.values(tipos).forEach(m=>{
        if(m.tipo==='entrada') entrada=m.timestamp;
        if(m.tipo==='salida') salida=m.timestamp;
      });
      if(!entrada || !salida) continue;
      const nombre=Object.values(tipos)[0].nombre || 'Sin nombre';
      if(!resumenHoras[nombre]) resumenHoras[nombre]=0;
      resumenHoras[nombre]+=(salida-entrada)/3600000;
    }
  }
  chartData.labels=Object.keys(resumenHoras);
  chartData.datasets[0].data=Object.values(resumenHoras);
  if(window.horasChartInstance) window.horasChartInstance.destroy();
  window.horasChartInstance=new Chart(ctx,{type:'bar', data:chartData, options:{responsive:true, plugins:{legend:{display:false}}}});
}

function renderChartEmpleado(startDate='', endDate=''){
  const ctx=document.getElementById("horasChartEmpleado").getContext("2d");
  const chartData={labels:[], datasets:[{label:'Horas trabajadas', data:[], backgroundColor:'rgba(0,123,255,0.5)'}]};
  const resumenHoras={};
  for(const empID in allMarcaciones){
    const fechas=allMarcaciones[empID];
    for(const fecha in fechas){
      const fechaObj=new Date(fecha);
      if(startDate && fechaObj<new Date(startDate)) continue;
      if(endDate && fechaObj>new Date(endDate)) continue;
      const tipos=fechas[fecha];
      let entrada=null, salida=null;
      Object.values(tipos).forEach(m=>{
        if(m.tipo==='entrada') entrada=m.timestamp;
        if(m.tipo==='salida') salida=m.timestamp;
      });
      if(!entrada || !salida) continue;
      const nombre=Object.values(tipos)[0].nombre || 'Sin nombre';
      if(!resumenHoras[nombre]) resumenHoras[nombre]=0;
      resumenHoras[nombre]+=(salida-entrada)/3600000;
    }
  }
  chartData.labels=Object.keys(resumenHoras);
  chartData.datasets[0].data=Object.values(resumenHoras);
  if(window.horasChartEmpleadoInstance) window.horasChartEmpleadoInstance.destroy();
  window.horasChartEmpleadoInstance=new Chart(ctx,{type:'bar', data:chartData, options:{responsive:true, plugins:{legend:{display:false}}}});
}

function updateChart(){
  const start=document.getElementById("chartStart").value;
  const end=document.getElementById("chartEnd").value;
  renderChart(start,end); // gr√°fico general
  renderChartEmpleado(start,end); // gr√°fico por empleado
}

// üîΩ Minimizar/expandir listas
function toggleSection(id){
  const el = document.getElementById(id);
  const header = el.previousElementSibling;
  if(el.style.display === 'none'){
    el.style.display = 'block';
    header.innerHTML = header.innerHTML.replace('‚ñ≤','‚ñº');
  } else {
    el.style.display = 'none';
    header.innerHTML = header.innerHTML.replace('‚ñº','‚ñ≤');
  }
}

// üîπ INICIO
backHome();
</script>
</body>
</html>
