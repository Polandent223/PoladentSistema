<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Poladent ‚Äì Sistema Completo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial;background:#eaf6ff;text-align:center;padding:20px}
.card{background:#fff;padding:20px;border-radius:10px;margin:15px auto;max-width:480px}
input,select,button{width:90%;padding:10px;margin:5px;font-size:15px}
button{background:#007bff;color:#fff;border:none;border-radius:6px;cursor:pointer}
button.danger{background:#dc3545}
.hidden{display:none}
.nombre{font-size:26px;font-weight:bold;margin-bottom:10px}
.alerta{background:#ffe0e0;padding:8px;margin:5px;border-radius:6px}
.ok{background:#e0ffe6;padding:8px;margin:5px;border-radius:6px}
.empleadoBox{border-bottom:1px solid #ddd;padding:10px;display:flex;justify-content:space-between;align-items:center}
</style>
</head>

<body>

<h1>ü¶∑ Poladent</h1>

<div id="home" class="card">
<button onclick="showAdmin()">Administrador</button>
<button onclick="showEmpleado()">Empleado</button>
</div>

<div id="adminLogin" class="card hidden">
<input id="adminEmail" placeholder="Correo">
<input id="adminPass" type="password" placeholder="Contrase√±a">
<button onclick="loginAdmin()">Entrar</button>
<button onclick="back()">Volver</button>
</div>

<div id="adminPanel" class="card hidden">
<h3>Administrador</h3>

<div class="card">
<input id="nombreEmp" placeholder="Nombre empleado">
<input id="pinEmp" placeholder="PIN">
<input id="salarioEmp" type="number" placeholder="Salario">
<select id="tipoSalario">
  <option value="diario">Diario</option>
  <option value="quincenal">Quincenal</option>
  <option value="mensual">Mensual</option>
</select>
<button onclick="addEmpleado()">Agregar empleado</button>
</div>

<div class="card">
<h4>Empleados registrados</h4>
<div id="listaEmpleados"></div>
</div>

<div class="card">
<h4>Resumen diario</h4>
<input type="date" id="fechaResumen" onchange="cargarResumen()">
<div id="resumen"></div>
<div id="alertas"></div>
<button onclick="exportar()">Exportar Excel</button>
</div>

<button onclick="logout()">Salir</button>
</div>

<div id="empleadoPanel" class="card hidden">
<div id="nombreGrande" class="nombre"></div>
<input id="pinIngreso" type="password" placeholder="PIN">
<div id="botones" class="hidden">
<button onclick="marcar('entrada')">Entrada</button>
<button onclick="marcar('salida')">Salida</button>
</div>
<div id="mensaje"></div>
<button onclick="back()">Volver</button>
</div>

<script>
// FIREBASE
firebase.initializeApp({
apiKey:"AIzaSyAFOyMEo2SgWpcs8WHp2nKCO_ax9-lYZWo",
authDomain:"poladent-5fa13.firebaseapp.com",
databaseURL:"https://poladent-5fa13-default-rtdb.firebaseio.com",
projectId:"poladent-5fa13"
});
const auth=firebase.auth(),db=firebase.database();
let empleado=null;

// NAVEGACI√ìN
function hide(){
home.classList.add("hidden");
adminLogin.classList.add("hidden");
adminPanel.classList.add("hidden");
empleadoPanel.classList.add("hidden");
}
function back(){hide();home.classList.remove("hidden")}
function showAdmin(){hide();adminLogin.classList.remove("hidden")}
function showEmpleado(){hide();empleadoPanel.classList.remove("hidden")}

// LOGIN ADMIN
function loginAdmin(){
auth.signInWithEmailAndPassword(adminEmail.value,adminPass.value)
.then(()=>{hide();adminPanel.classList.remove("hidden");initFecha();cargarEmpleados();cargarResumen()})
.catch(()=>alert("Error de acceso"));
}
function logout(){auth.signOut();back()}

// AGREGAR EMPLEADO
function addEmpleado(){
if(!nombreEmp.value||!pinEmp.value||!salarioEmp.value) return;
db.ref("empleados").push({
nombre:nombreEmp.value,
pin:pinEmp.value,
salario:parseFloat(salarioEmp.value),
tipoSalario:tipoSalario.value
});
nombreEmp.value="";pinEmp.value="";salarioEmp.value="";tipoSalario.value="diario";
}

// LISTA EMPLEADOS + SALARIO + PDF
function cargarEmpleados(){
db.ref("empleados").on("value",snap=>{
listaEmpleados.innerHTML="";
snap.forEach(e=>{
const emp=e.val();
listaEmpleados.innerHTML+=`
<div class="empleadoBox">
<div>
<b>${emp.nombre}</b><br>
PIN: ${emp.pin}<br>
Salario: <input type="number" value="${emp.salario||0}" onchange="guardarSalario('${e.key}',this.value)">
Tipo: <select onchange="guardarTipo('${e.key}',this.value)">
  <option value="diario" ${emp.tipoSalario==='diario'?'selected':''}>Diario</option>
  <option value="quincenal" ${emp.tipoSalario==='quincenal'?'selected':''}>Quincenal</option>
  <option value="mensual" ${emp.tipoSalario==='mensual'?'selected':''}>Mensual</option>
</select>
</div>
<div>
<button onclick="generarPDF('${e.key}')">Olerete PDF</button>
<button class="danger" onclick="borrarEmpleado('${e.key}')">Borrar</button>
</div>
</div>`;
});
});
}

function guardarSalario(id,valor){db.ref("empleados/"+id+"/salario").set(parseFloat(valor)||0);}
function guardarTipo(id,valor){db.ref("empleados/"+id+"/tipoSalario").set(valor);}
function borrarEmpleado(id){if(confirm("¬øBorrar empleado?")){db.ref("empleados/"+id).remove();db.ref("marcaciones/"+id).remove();}}

// EMPLEADO
pinIngreso.addEventListener("change",()=>{
db.ref("empleados").orderByChild("pin").equalTo(pinIngreso.value).once("value",s=>{
if(!s.exists()){alert("PIN incorrecto");return;}
s.forEach(e=>{
empleado={id:e.key,nombre:e.val().nombre};
nombreGrande.innerText=empleado.nombre;
botones.classList.remove("hidden");
});
});
});

function marcar(tipo){
const d=new Date();
const fecha=d.toISOString().slice(0,10);
db.ref(`marcaciones/${empleado.id}/${fecha}/${tipo}`)
.set({hora:d.toLocaleTimeString(),timestamp:d.getTime(),nombre:empleado.nombre});
mensaje.innerHTML=`<div class="ok">‚úî ${tipo} registrada</div>`;
setTimeout(back,1500);
cargarResumen();
}

// RESUMEN + ALERTAS
function initFecha(){fechaResumen.value=new Date().toISOString().slice(0,10);}

function cargarResumen(){
resumen.innerHTML="";alertas.innerHTML="";
db.ref("marcaciones").once("value",snap=>{
snap.forEach(emp=>{
db.ref("empleados/"+emp.key).once("value",empSnap=>{
const nombre=empSnap.val().nombre;
const dia=emp.child(fechaResumen.value);
if(!dia.exists())return;
let ent=dia.child("entrada").val()?.timestamp;
let sal=dia.child("salida").val()?.timestamp;
let hrs=0,extra=0,banco=0;
if(ent) resumen.innerHTML+=`<p><b>${nombre}</b> Entrada ${new Date(ent).toLocaleTimeString()}</p>`;
if(sal) resumen.innerHTML+=`<p><b>${nombre}</b> Salida ${new Date(sal).toLocaleTimeString()}</p>`;
if(ent && sal){
hrs=(sal-ent)/3600000;
extra=Math.max(0,hrs-8);
banco=extra; 
resumen.innerHTML+=`<p>Horas: ${hrs.toFixed(2)}, Extra: ${extra.toFixed(2)}, Banco: ${banco.toFixed(2)}</p>`;
}
if(ent && new Date(ent).getHours()>8) alertas.innerHTML+=`<div class="alerta">‚è∞ ${nombre} lleg√≥ tarde</div>`;
if(sal && new Date(sal).getHours()<17) alertas.innerHTML+=`<div class="alerta">‚ö†Ô∏è ${nombre} sali√≥ temprano</div>`;
});
});
});
}

// EXCEL
function exportar(){
let rows=[["Nombre","Fecha","Tipo","Hora"]];
db.ref("marcaciones").once("value",s=>{
s.forEach(emp=>{emp.forEach(d=>{Object.values(d.val()).forEach(m=>{rows.push([m.nombre,d.key,m.tipo||"",m.hora]);});});});
let wb=XLSX.utils.book_new();
let ws=XLSX.utils.aoa_to_sheet(rows);
XLSX.utils.book_append_sheet(wb,ws,"Resumen");
XLSX.writeFile(wb,"Poladent.xlsx");
}

// PDF ‚Äì OLERETE CON HORAS + EXTRA + BANCO
function generarPDF(empID){
db.ref("empleados/"+empID).once("value").then(empSnap=>{
const emp=empSnap.val();
db.ref("marcaciones/"+empID).once("value").then(mSnap=>{
const fecha=fechaResumen.value;
let marcaciones="";
let totalHoras=0, totalExtra=0, totalBanco=0;
if(mSnap.child(fecha).exists()){
Object.values(mSnap.child(fecha).val()).sort((a,b)=>a.timestamp-b.timestamp).forEach(m=>{
marcaciones+=`${m.tipo} ‚Üí ${m.hora}\n`;
if(m.tipo==="entrada") var ent=m.timestamp;
if(m.tipo==="salida") var sal=m.timestamp;
});
if(ent && sal){
totalHoras=(sal-ent)/3600000;
totalExtra=Math.max(0,totalHoras-8);
totalBanco=totalExtra;
}
}else{
marcaciones="No hay marcaciones hoy";
}

const { jsPDF } = window.jspdf;
const doc = new jsPDF();
doc.setFontSize(16);
doc.text("Poladent - Olerete",20,20);
doc.setFontSize(14);
doc.text(`Nombre: ${emp.nombre}`,20,30);
doc.text(`Fecha: ${fecha}`,20,40);
doc.text(`Salario (${emp.tipoSalario}): ${emp.salario}`,20,50);
doc.text("Marcaciones:",20,60);
doc.text(marcaciones,20,70);
doc.text(`Horas trabajadas: ${totalHoras.toFixed(2)}`,20,100);
doc.text(`Horas extra: ${totalExtra.toFixed(2)}`,20,110);
doc.text(`Banco de horas: ${totalBanco.toFixed(2)}`,20,120);
doc.text("__________________________",20,140);
doc.text("Firma empleado",20,150);
doc.save(`${emp.nombre}_${fecha}.pdf`);
});
});
}

back();
</script>
</body>
</html>
