<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Poladent â€“ Sistema Completo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial;background:#eaf6ff;padding:20px;text-align:center;}
h1,h2,h3{text-align:center;}
.card{background:white;padding:20px;border-radius:10px;margin:15px auto;max-width:450px;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
input,button,select{padding:10px;margin:5px;width:90%;font-size:15px;}
button{cursor:pointer;background:#007bff;color:white;border:none;border-radius:5px;}
button.danger{background:#dc3545;}
.hidden{display:none;}
.notice{background:#dff3ff;padding:10px;margin-top:8px;border-radius:6px;}
.empleado{border-bottom:1px solid #ddd;padding:10px 0;display:flex;flex-direction:column;}
.nombreGrande{font-size:24px;font-weight:bold;margin-bottom:10px;}
.notif{background:#fff3cd;padding:10px;margin:5px;border-radius:5px;border:1px solid #ffeeba;}
.empActions{margin-top:5px; display:flex; gap:5px;}
</style>
</head>

<body>

<h1>Poladent ðŸ¦·ðŸ¦·</h1>

<!-- HOME -->
<div id="home" class="card">
  <button onclick="goAdmin()">Administrador</button>
  <button onclick="goEmployee()">Empleado</button>
</div>

<!-- ADMIN LOGIN -->
<div id="adminLogin" class="card hidden">
  <h3>Administrador</h3>
  <input id="adminEmail" placeholder="Correo">
  <input id="adminPass" type="password" placeholder="ContraseÃ±a">
  <br>
  <button onclick="loginAdmin()">Entrar</button>
  <button onclick="backHome()">Volver</button>
</div>

<!-- ADMIN PANEL -->
<div id="adminPanel" class="card hidden">
  <h3>Panel Administrador</h3>

  <!-- Agregar empleado -->
  <div class="card">
    <h4>Agregar empleado</h4>
    <input id="nombreEmpleado" placeholder="Nombre del empleado">
    <input id="pinEmpleado" placeholder="PIN del empleado">
    <button onclick="agregarEmpleado()">Guardar empleado</button>
  </div>

  <!-- Lista empleados -->
  <div class="card">
    <h4>Empleados registrados <button onclick="toggleListaEmpleados()">Mostrar/Ocultar</button></h4>
    <div id="listaEmpleados"></div>
  </div>

  <!-- Resumen marcaciones -->
  <div class="card">
    <h4>Resumen de marcaciones <button onclick="toggleResumen()">Mostrar/Ocultar</button></h4>
    <input type="date" id="filterDate" onchange="renderAdminList(filterDate.value)">
    <select id="periodoResumen" onchange="renderAdminList(filterDate.value)">
      <option value="diario">Diario</option>
      <option value="quincenal">Quincenal</option>
      <option value="mensual">Mensual</option>
    </select>
    <div id="adminList"></div>
    <div id="notificaciones"></div>
    <button onclick="exportExcelFiltro()">Exportar Marcaciones</button>
    <button onclick="exportExcelSalarialFiltro()">Exportar Salario</button>
  </div>

  <button onclick="logout()">Salir</button>
</div>

  <!-- GrÃ¡fico de horas trabajadas -->
<div class="card">
  <h4>GrÃ¡fico de horas trabajadas</h4>
  <canvas id="horasChart" width="400" height="200"></canvas>
</div>

<!-- ExportaciÃ³n avanzada por rango de fechas -->
<div class="card">
  <h4>Exportar por rango de fechas</h4>
  <input type="date" id="fechaInicio">
  <input type="date" id="fechaFin">
  <button onclick="exportExcelRango()">Exportar Excel</button>
  <button onclick="exportExcelSalarialRango()">Exportar Salario</button>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
<!-- EMPLEADO PANEL -->
<div id="employeePanel" class="card hidden">
  <div class="nombreGrande" id="empNombreGrande"></div>
  <input id="empPin" type="password" placeholder="Ingresa tu PIN">
  <br>
  <div id="employeeButtons" class="hidden">
    <button onclick="mark('entrada')">Entrada</button>
    <button onclick="mark('almuerzo_salida')">Salida Almuerzo</button>
    <button onclick="mark('almuerzo_regreso')">Regreso Almuerzo</button>
    <button onclick="mark('salida')">Salida</button>
  </div>
  <div id="empMsg" class="notice"></div>
  <button onclick="backHome()">Volver</button>
</div>

<script>
// ðŸ”¥ FIREBASE
const firebaseConfig={
  apiKey:"AIzaSyAFOyMEo2SgWpcs8WHp2nKCO_ax9-lYZWo",
  authDomain:"poladent-5fa13.firebaseapp.com",
  databaseURL:"https://poladent-5fa13-default-rtdb.firebaseio.com",
  projectId:"poladent-5fa13",
  storageBucket:"poladent-5fa13.firebasestorage.app",
  messagingSenderId:"539152567873",
  appId:"1:539152567873:web:89c67ebb14bd55a77900c0"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(), db=firebase.database();

// ðŸŒ NAVEGACIÃ“N
function hideAll(){home.classList.add("hidden");adminLogin.classList.add("hidden");adminPanel.classList.add("hidden");employeePanel.classList.add("hidden");}
function backHome(){
  hideAll(); home.classList.remove("hidden");
  empNombreGrande.innerHTML=""; empPin.value=""; employeeButtons.classList.add("hidden"); empMsg.innerHTML="";
}
function goAdmin(){hideAll();adminLogin.classList.remove("hidden");}
function goEmployee(){hideAll();employeePanel.classList.remove("hidden");}

// ðŸ‘¤ ADMIN LOGIN
function loginAdmin(){
  auth.signInWithEmailAndPassword(adminEmail.value,adminPass.value)
  .then(()=>{hideAll();adminPanel.classList.remove("hidden");setDefaultDate();loadEmpleados();loadMarcaciones();})
  .catch(()=>alert("Error de acceso"));
}
function logout(){auth.signOut();backHome();}

// ðŸ‘· EMPLEADOS
let empleadoActual=null;
function agregarEmpleado(){
  const nombre=nombreEmpleado.value.trim(), pin=pinEmpleado.value.trim();
  if(!nombre||!pin){alert("Completa todos los campos"); return;}
  const id=db.ref("empleados").push().key;
  db.ref("empleados/"+id).set({nombre,pin,creado:Date.now(),salario:0,tipoSalario:"diario"});
  nombreEmpleado.value=""; pinEmpleado.value=""; loadEmpleados();
}
function loadEmpleados(){
  const cont=listaEmpleados; cont.innerHTML="";
  db.ref("empleados").on("value",snap=>{
    snap.forEach(emp=>{
      const d=emp.val();
      cont.innerHTML+=`<div class="empleado"><strong>${d.nombre}</strong><br>PIN: ${d.pin}<br>Salario: ${d.salario} (${d.tipoSalario})<div class="empActions"><button onclick="borrarEmpleado('${emp.key}')">Borrar</button><button onclick="asignarSalario('${emp.key}')">Asignar Salario</button><button onclick="generarOlerite('${emp.key}')">Olerite PDF</button></div></div>`;
    });
  });
}
function borrarEmpleado(id){if(confirm("Â¿Seguro?")){db.ref("empleados/"+id).remove();db.ref("marcaciones/"+id).remove();}}
function asignarSalario(id){const s=prompt("Salario"), t=prompt("Tipo (diario/quincenal/mensual)","diario");if(!s) return; db.ref("empleados/"+id).update({salario:parseFloat(s),tipoSalario:t}); loadEmpleados();}
function generarOlerite(id){db.ref("empleados/"+id).once("value",snap=>{const emp=snap.val(); if(!emp) return; const {jsPDF}=window.jspdf; const doc=new jsPDF(); doc.setFontSize(20); doc.text("Olerite de Pago",20,20); doc.setFontSize(14); doc.text(`Empleado: ${emp.nombre}`,20,40); doc.text(`Salario: ${emp.salario} (${emp.tipoSalario})`,20,50); doc.text(`Fecha: ${new Date().toLocaleDateString()}`,20,60); doc.save(`Olerite_${emp.nombre}.pdf`);});}

// ðŸ‘· EMPLEADO â€“ ORDEN MARCACIÃ“N
document.getElementById("empPin").addEventListener("change",()=>{
  const pin=empPin.value.trim(); if(!pin) return;
  db.ref("empleados").orderByChild("pin").equalTo(pin).once("value",snap=>{
    if(!snap.exists()){alert("PIN no encontrado"); employeeButtons.classList.add("hidden"); return;}
    snap.forEach(empSnap=>{empleadoActual={id:empSnap.key,nombre:empSnap.val().nombre}; empNombreGrande.innerHTML=empleadoActual.nombre; employeeButtons.classList.remove("hidden"); empMsg.innerHTML="";});
  });
});
function mark(tipo){
  if(!empleadoActual) return;
  db.ref("marcaciones/"+empleadoActual.id+"/"+getToday()).once("value").then(snap=>{
    const estados=snap.val()||{};
    const orden=["entrada","almuerzo_salida","almuerzo_regreso","salida"];
    const ultima=Object.keys(estados).sort((a,b)=>estados[a].timestamp-estados[b].timestamp).pop();
    if(ultima && orden.indexOf(tipo)<orden.indexOf(ultima)){alert("Debes marcar en orden correcto"); return;}
    if(navigator.geolocation){navigator.geolocation.getCurrentPosition(pos=>{
      const now=new Date(); const fecha=getToday(), hora=now.toLocaleTimeString(), timestamp=now.getTime();
      db.ref("marcaciones/"+empleadoActual.id+"/"+fecha+"/"+tipo).set({nombre:empleadoActual.nombre,tipo,fecha,hora,timestamp,lat:pos.coords.latitude,lon:pos.coords.longitude});
      let frases={"entrada":"Â¡Buen inicio!","almuerzo_salida":"Buen provecho ðŸ½ï¸","almuerzo_regreso":"Bienvenido ðŸ‘‹","salida":"Â¡Buen trabajo!"};
      empMsg.innerHTML=`${empleadoActual.nombre} | ${frases[tipo]} (${hora})`; mostrarNotificacion(`${empleadoActual.nombre} marcÃ³ ${tipo} a las ${hora}`); setTimeout(backHome,2000); loadMarcaciones();
    });} else alert("GPS no disponible");
  });
}

// ðŸ“ ADMIN â€“ RESUMEN
let allMarcaciones={}, excelRows=[], excelSalarial=[];
function loadMarcaciones(){db.ref("marcaciones").on("value",snap=>{allMarcaciones=snap.val()||{}; renderAdminList(filterDate.value);});}
function renderAdminList(dateFilter){
  adminList.innerHTML=""; notificaciones.innerHTML=""; excelRows=[]; excelSalarial=[];
  const periodo=periodoResumen.value; if(!allMarcaciones) return;
  for(const empID in allMarcaciones){
    const fechas=allMarcaciones[empID];
    for(const fecha in fechas){
      if(periodo!=="diario" && dateFilter && !fecha.startsWith(dateFilter.substring(0,7))) continue;
      if(periodo==="diario" && dateFilter && fecha!==dateFilter) continue;
      const tipos=fechas[fecha]; const sorted=Object.values(tipos).sort((a,b)=>a.timestamp-b.timestamp);
      sorted.forEach(data=>{
        if(!data.nombre)data.nombre="Sin nombre";
        adminList.innerHTML+=`<p><b>${data.nombre}</b> | ${data.tipo} | ${fecha} | ${data.hora}</p>`;
        excelRows.push([data.nombre,fecha,data.tipo,data.hora]);
        excelSalarial.push({nombre:data.nombre,fecha:data.fecha,tipo:data.tipo,timestamp:data.timestamp});
        notificaciones.innerHTML+=`<div class="notif">${data.nombre} marcÃ³ ${data.tipo} a las ${data.hora}</div>`;
      });
    }
  }
}
  function generarGraficoHoras() {
    // Calcular horas totales por empleado
    const horasPorEmpleado = {};
    for(const emp in allMarcaciones){
        const fechas = allMarcaciones[emp];
        for(const fecha in fechas){
            const tipos = fechas[fecha];
            let entrada=null, salida=null;
            for(const key in tipos){
                if(tipos[key].tipo === "entrada") entrada=tipos[key].timestamp;
                if(tipos[key].tipo === "salida") salida=tipos[key].timestamp;
            }
            if(entrada && salida){
                const hrs = (salida-entrada)/3600000;
                if(!horasPorEmpleado[tipos[Object.keys(tipos)[0]].nombre]) horasPorEmpleado[tipos[Object.keys(tipos)[0]].nombre]=0;
                horasPorEmpleado[tipos[Object.keys(tipos)[0]].nombre] += hrs;
            }
        }
    }

    const ctx = document.getElementById('horasChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(horasPorEmpleado),
            datasets: [{
                label: 'Horas trabajadas',
                data: Object.values(horasPorEmpleado),
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                title: { display: true, text: 'Horas trabajadas por empleado' }
            }
        }
    });
}

// Llamar cada vez que cargues marcaciones
loadMarcaciones = (function(orig){
    return function(){
        orig();
        generarGraficoHoras();
    }
})(loadMarcaciones);

// ðŸ“Š EXPORT
function exportExcelFiltro(){const rows=[["Nombre","Fecha","Tipo","Hora"],...excelRows]; const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(rows),"Resumen"); XLSX.writeFile(wb,"Poladent_Marcaciones.xlsx");}
function exportExcelSalarialFiltro(){
  const resumen={};
  for(const m of excelSalarial){
    if(!resumen[m.nombre]) resumen[m.nombre]={dias:{}};
    if(!resumen[m.nombre].dias[m.fecha]) resumen[m.nombre].dias[m.fecha]={entrada:null,salida:null};
    if(m.tipo==="entrada") resumen[m.nombre].dias[m.fecha].entrada=m.timestamp;
    if(m.tipo==="salida") resumen[m.nombre].dias[m.fecha].salida=m.timestamp;
  }
  const ws=[["Nombre","Fecha","Horas trabajadas","Horas extra","Banco de horas"]];
  for(const emp in resumen){
    let banco=0;
    for(const dia in resumen[emp].dias){
      const ent=resumen[emp].dias[dia].entrada, sal=resumen[emp].dias[dia].salida; if(!ent||!sal) continue;
      const hrs=(sal-ent)/3600000, extra=Math.max(0,hrs-8), normales=Math.min(8,hrs); banco+=extra;
      ws.push([emp,dia,normales.toFixed(2),extra.toFixed(2),banco.toFixed(2)]);
    }
  }
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(ws),"Salario"); XLSX.writeFile(wb,"Poladent_Salario.xlsx");
}
  function exportExcelRango(){
    const inicio = document.getElementById('fechaInicio').value;
    const fin = document.getElementById('fechaFin').value;
    if(!inicio || !fin){alert("Selecciona ambas fechas"); return;}
    const rows=[["Nombre","Fecha","Tipo","Hora"]];
    for(const m of excelRows){
        if(m[1] >= inicio && m[1] <= fin) rows.push(m);
    }
    const wb=XLSX.utils.book_new();
    const ws=XLSX.utils.aoa_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, "ResumenRango");
    XLSX.writeFile(wb, "Poladent_Marcaciones_Rango.xlsx");
}

function exportExcelSalarialRango(){
    const inicio = document.getElementById('fechaInicio').value;
    const fin = document.getElementById('fechaFin').value;
    if(!inicio || !fin){alert("Selecciona ambas fechas"); return;}
    const resumen={};
    for(const m of excelSalarial){
        if(m.fecha >= inicio && m.fecha <= fin){
            if(!resumen[m.nombre]) resumen[m.nombre]={dias:{}};
            if(!resumen[m.nombre].dias[m.fecha]) resumen[m.nombre].dias[m.fecha]={entrada:null,salida:null};
            if(m.tipo==="entrada") resumen[m.nombre].dias[m.fecha].entrada=m.timestamp;
            if(m.tipo==="salida") resumen[m.nombre].dias[m.fecha].salida=m.timestamp;
        }
    }
    const wsData=[["Nombre","Fecha","Horas trabajadas","Horas extra","Banco de horas"]];
    for(const emp in resumen){
        let bancoTotal=0;
        for(const dia in resumen[emp].dias){
            const ent=resumen[emp].dias[dia].entrada;
            const sal=resumen[emp].dias[dia].salida;
            if(!ent||!sal) continue;
            let hrs=(sal-ent)/3600000;
            let extra=Math.max(0,hrs-8);
            let normales=Math.min(8,hrs);
            bancoTotal+=extra;
            wsData.push([emp,dia,normales.toFixed(2),extra.toFixed(2),bancoTotal.toFixed(2)]);
        }
    }
    const wb=XLSX.utils.book_new();
    const ws=XLSX.utils.aoa_to_sheet(wsData);
    XLSX.utils.book_append_sheet(wb, ws, "SalarioRango");
    XLSX.writeFile(wb, "Poladent_Salario_Rango.xlsx");
}

// ðŸ“… CALENDARIO
function setDefaultDate(){const today=new Date(), yyyy=today.getFullYear(), mm=(today.getMonth()+1).toString().padStart(2,"0"), dd=today.getDate().toString().padStart(2,"0"); filterDate.value=`${yyyy}-${mm}-${dd}`;}
function getToday(){const t=new Date(); return `${t.getFullYear()}-${(t.getMonth()+1).toString().padStart(2,"0")}-${t.getDate().toString().padStart(2,"0")}`;}

// ðŸ”” NOTIFICACIONES
function mostrarNotificacion(text){const div=document.createElement("div"); div.className="notif"; div.innerText=text; notificaciones.prepend(div);}

// ðŸ”¹ VER/OCULTAR LISTAS
let listaVisible=true, resumenVisible=true;
function toggleListaEmpleados(){listaVisible=!listaVisible; listaEmpleados.style.display=listaVisible?"block":"none";}
function toggleResumen(){resumenVisible=!resumenVisible; adminList.style.display=resumenVisible?"block":"none"; notificaciones.style.display=resumenVisible?"block":"none";}

// ðŸ”¹ INICIO
backHome(); loadEmpleados(); loadMarcaciones();
</script>
</body>
      </html>
