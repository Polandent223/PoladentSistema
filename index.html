
<!-- Reemplaza el script de E3 con este -->
<script>
// üî• FIREBASE
firebase.initializeApp({
  apiKey:"AIzaSyAFOyMEo2SgWpcs8WHp2nKCO_ax9-lYZWo",
  authDomain:"poladent-5fa13.firebaseapp.com",
  databaseURL:"https://poladent-5fa13-default-rtdb.firebaseio.com",
  projectId:"poladent-5fa13"
});
const auth=firebase.auth();
const db=firebase.database();

// üß≠ NAV
function hideAll(){
  home.classList.add("hidden");
  adminLogin.classList.add("hidden");
  adminPanel.classList.add("hidden");
  employeePanel.classList.add("hidden");
}
function backHome(){hideAll();home.classList.remove("hidden");}
function goAdmin(){hideAll();adminLogin.classList.remove("hidden");}
function goEmployee(){hideAll();employeePanel.classList.remove("hidden");}

// üë§ ADMIN + ROLES
let currentUser=null, currentRole=null;

function loginAdmin(){
  auth.signInWithEmailAndPassword(adminEmail.value,adminPass.value)
  .then(res=>{
    currentUser=res.user;
    db.ref("users/"+currentUser.uid).once("value").then(snap=>{
      currentRole=snap.val()?.role || "admin";
      hideAll();
      if(currentRole==="admin") adminPanel.classList.remove("hidden");
      else goRolePanel(currentRole);
      cargarEmpleados();
      escucharNotificaciones();
    });
  }).catch(()=>alert("Error de acceso"));
}

function logout(){auth.signOut();currentUser=null;currentRole=null; backHome();}

function goRolePanel(role){
  // Panel solo lectura para RH / Supervisor
  adminPanel.classList.remove("hidden");
  document.querySelector("#adminPanel h3").innerText="Panel "+role.toUpperCase();
  // Ocultar botones de agregar/borrar
  document.querySelectorAll("#adminPanel button").forEach(b=>{
    if(b.innerText.includes("Guardar")||b.innerText.includes("Borrar")) b.style.display="none";
  });
}

// üë∑ AGREGAR / BORRAR EMPLEADOS (solo admin)
function agregarEmpleado(){
  if(currentRole!=="admin") return alert("Sin permisos");
  if(!nombreEmpleado.value||!pinEmpleado.value)return;
  db.ref("empleados").push({nombre:nombreEmpleado.value,pin:pinEmpleado.value});
  nombreEmpleado.value=""; pinEmpleado.value="";
}

function cargarEmpleados(){
  db.ref("empleados").on("value",snap=>{
    listaEmpleados.innerHTML="";
    snap.forEach(e=>{
      let botones="";
      if(currentRole==="admin") botones=` <button onclick="borrarEmpleado('${e.key}')">Borrar</button>`;
      listaEmpleados.innerHTML+=`<div>${e.val().nombre}${botones}</div>`;
    });
  });
}

function borrarEmpleado(id){
  if(currentRole!=="admin") return alert("Sin permisos");
  db.ref("empleados/"+id).remove();
}

// üë∑ EMPLEADO
let empleadoActual=null;
empPin.addEventListener("change",()=>{
  db.ref("empleados").orderByChild("pin").equalTo(empPin.value)
  .once("value",snap=>{
    snap.forEach(e=>{
      empleadoActual={id:e.key,nombre:e.val().nombre};
      empNombreGrande.innerText=empleadoActual.nombre;
      employeeButtons.classList.remove("hidden");
    });
  });
});

// ‚è±Ô∏è MARCAR + ATRASOS (E3)
function marcar(tipo){
  const now=new Date();
  const hora=now.toLocaleTimeString();
  const fecha=now.toISOString().split("T")[0];
  const timestamp=now.getTime();

  let atrasoMin=0, salidaAntesMin=0;
  if(tipo==="entrada"){ const limite=new Date(); limite.setHours(8,0,0,0); if(now>limite) atrasoMin=Math.floor((now-limite)/60000);}
  if(tipo==="salida"){ const limite=new Date(); limite.setHours(17,0,0,0); if(now<limite) salidaAntesMin=Math.floor((limite-now)/60000);}

  const data={nombre:empleadoActual.nombre,tipo,hora,fecha,timestamp,atrasoMin,salidaAntesMin};
  db.ref("marcaciones").push(data);
  db.ref("notificaciones").push(data);

  backHome();
}

// üîî NOTIF REALTIME
function escucharNotificaciones(){
  notificaciones.innerHTML="";
  db.ref("notificaciones").limitToLast(15).on("child_added",snap=>{
    const n=snap.val();
    let msg=`${n.nombre} marc√≥ ${n.tipo} (${n.hora})`;
    if(n.atrasoMin>0) msg+=` ‚ö†Ô∏è ${n.atrasoMin} min tarde`;
    if(n.salidaAntesMin>0) msg+=` ‚ö†Ô∏è sali√≥ ${n.salidaAntesMin} min antes`;
    notificaciones.innerHTML=`<div class="notif">${msg}</div>`+notificaciones.innerHTML;
  });
}

backHome();
</script>
