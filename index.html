<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Poladent ‚Äì Sistema Completo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{font-family:Arial;background:#eaf6ff;padding:20px;text-align:center;}
h1,h2,h3{text-align:center;}
.card{background:white;padding:20px;border-radius:10px;margin:15px auto;max-width:450px;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
input,button,select{padding:10px;margin:5px;width:90%;font-size:15px;}
button{cursor:pointer;background:#007bff;color:white;border:none;border-radius:5px;}
button.danger{background:#dc3545;}
.hidden{display:none;}
.notice{background:#dff3ff;padding:10px;margin-top:8px;border-radius:6px;}
.empleado{border-bottom:1px solid #ddd;padding:10px 0;display:flex;flex-direction:column;}
.nombreGrande{font-size:24px;font-weight:bold;margin-bottom:10px;}
.notif{background:#fff3cd;padding:10px;margin:5px;border-radius:5px;border:1px solid #ffeeba;}
.empActions{margin-top:5px; display:flex; gap:5px;}
</style>
</head>

<body>

<h1>ü¶∑ Poladent ü¶∑</h1>

<!-- HOME -->
<div id="home" class="card">
  <button onclick="goAdmin()">Administrador</button>
  <button onclick="goEmployee()">Empleado</button>
</div>

<!-- ADMIN LOGIN -->
<div id="adminLogin" class="card hidden">
  <h3>Administrador</h3>
  <input id="adminEmail" placeholder="Correo">
  <input id="adminPass" type="password" placeholder="Contrase√±a">
  <br>
  <button onclick="loginAdmin()">Entrar</button>
  <button onclick="backHome()">Volver</button>
</div>

<!-- ADMIN PANEL -->
<div id="adminPanel" class="card hidden">
  <h3>Panel Administrador</h3>

  <!-- Agregar empleado -->
  <div class="card">
    <h4>Agregar empleado</h4>
    <input id="nombreEmpleado" placeholder="Nombre del empleado">
    <input id="pinEmpleado" placeholder="PIN del empleado">
    <button onclick="agregarEmpleado()">Guardar empleado</button>
  </div>

  <!-- Empleados registrados -->
<div class="card">
  <h4 style="cursor:pointer;" onclick="toggleSection('listaEmpleados')">
    Empleados registrados ‚ñº
  </h4>
  <div id="listaEmpleados" style="max-height:300px; overflow:auto;"></div>
</div>

<!-- Resumen marcaciones -->
<div class="card">
  <h4 style="cursor:pointer;" onclick="toggleSection('adminList')">
    Resumen de marcaciones ‚ñº
  </h4>
  <input type="date" id="filterDate" onchange="filterByDate()">
  <select id="periodoResumen" onchange="filterByDate()">
    <option value="diario">Diario</option>
    <option value="quincenal">Quincenal</option>
    <option value="mensual">Mensual</option>
  </select>
  <div id="adminList" style="max-height:300px; overflow:auto;"></div>
  <h4 style="cursor:pointer;" onclick="toggleSection('notificaciones')">
  Notificaciones ‚ñº
</h4>
<div id="notificaciones" style="max-height:200px; overflow:auto; background:#fff3cd; padding:5px; border-radius:5px;"></div>
  <button onclick="exportExcelFiltro()">Exportar Marcaciones</button>
  <button onclick="exportExcelSalarialFiltro()">Exportar Salario</button>
</div>
  <!-- Gr√°fico horas trabajadas -->
  <div class="card">
    <h4>Gr√°fico de horas trabajadas</h4>
    <label>Desde: <input type="date" id="chartStart" onchange="updateChart()"></label>
    <label>Hasta: <input type="date" id="chartEnd" onchange="updateChart()"></label>
    <canvas id="horasChart" width="400" height="200"></canvas>
  </div>

  <button onclick="logout()">Salir</button>
</div>

<!-- EMPLEADO PANEL -->
<div id="employeePanel" class="card hidden">
  <div class="nombreGrande" id="empNombreGrande"></div>
  <input id="empPin" type="password" placeholder="Ingresa tu PIN">
  <br>
  <div id="employeeButtons" class="hidden">
    <button onclick="mark('entrada')">Entrada</button>
    <button onclick="mark('almuerzo_salida')">Salida Almuerzo</button>
    <button onclick="mark('almuerzo_regreso')">Regreso Almuerzo</button>
    <button onclick="mark('salida')">Salida</button>
  </div>
  <div id="empMsg" class="notice"></div>
  <button onclick="backHome()">Volver</button>
</div>
  <h4 style="cursor:pointer;" onclick="toggleSection('graficoDia')">
  Gr√°fico del d√≠a ‚ñº
</h4>

<div id="graficoDia" style="display:block;">
  <canvas id="chartDia" height="120"></canvas>
</div>

<script>
// üî• CONFIGURACI√ìN FIREBASE
const firebaseConfig={
  apiKey:"AIzaSyAFOyMEo2SgWpcs8WHp2nKCO_ax9-lYZWo",
  authDomain:"poladent-5fa13.firebaseapp.com",
  databaseURL:"https://poladent-5fa13-default-rtdb.firebaseio.com",
  projectId:"poladent-5fa13",
  storageBucket:"poladent-5fa13.firebasestorage.app",
  messagingSenderId:"539152567873",
  appId:"1:539152567873:web:89c67ebb14bd55a77900c0"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(), db=firebase.database();

// üåê NAVEGACI√ìN
function hideAll(){
  home.classList.add("hidden");
  adminLogin.classList.add("hidden");
  adminPanel.classList.add("hidden");
  employeePanel.classList.add("hidden");
}
function backHome(){
  hideAll();
  home.classList.remove("hidden");
  document.getElementById("empNombreGrande").innerHTML="";
  document.getElementById("empPin").value="";
  document.getElementById("employeeButtons").classList.add("hidden");
  document.getElementById("empMsg").innerHTML="";
}
function goAdmin(){hideAll();adminLogin.classList.remove("hidden");}
function goEmployee(){hideAll();employeePanel.classList.remove("hidden");}

// üë§ LOGIN ADMIN
function loginAdmin(){
  auth.signInWithEmailAndPassword(adminEmail.value,adminPass.value)
  .then(()=>{
    hideAll(); adminPanel.classList.remove("hidden");
    setDefaultDate(); loadEmpleados(); loadMarcaciones(); updateChart();
  })
  .catch(()=>alert("Error de acceso"));
}
function logout(){auth.signOut(); backHome();}

// üë∑ EMPLEADOS
function agregarEmpleado(){
  const nombre=document.getElementById("nombreEmpleado").value.trim();
  const pin=document.getElementById("pinEmpleado").value.trim();
  if(!nombre||!pin){alert("Completa todos los campos"); return;}
  const id=db.ref("empleados").push().key;
  db.ref("empleados/"+id).set({nombre,pin,creado:Date.now(),salario:0,tipoSalario:"diario"});
  document.getElementById("nombreEmpleado").value="";
  document.getElementById("pinEmpleado").value="";
}
function cargarEmpleados(){
  const cont=document.getElementById("listaEmpleados");
  db.ref("empleados").on("value",snap=>{
    cont.innerHTML="";
    snap.forEach(emp=>{
      const data=emp.val();
      cont.innerHTML+=`<div class="empleado">
        <strong>${data.nombre}</strong><br>
        PIN: ${data.pin}<br>
        Salario: ${data.salario} (${data.tipoSalario})
        <div class="empActions">
          <button onclick="borrarEmpleado('${emp.key}')">Borrar</button>
          <button onclick="asignarSalario('${emp.key}')">Asignar Salario</button>
          <button onclick="generarOlerite('${emp.key}')">Olerite PDF</button>
        </div>
      </div>`;
    });
  });
}
function loadEmpleados(){cargarEmpleados();}
function borrarEmpleado(id){
  if(confirm("¬øSeguro que deseas borrar este empleado?")){
    db.ref("empleados/"+id).remove();
    db.ref("marcaciones/"+id).remove();
  }
}

// üìå SALARIO
function asignarSalario(empID){
  const salario=prompt("Ingresa el salario:");
  if(!salario) return;
  const tipo=prompt("Tipo de salario (diario/quincenal/mensual):","diario");
  db.ref("empleados/"+empID).update({salario:parseFloat(salario),tipoSalario:tipo});
  loadEmpleados();
}

// üìå OLERITE PDF
function generarOlerite(empID){
  db.ref("empleados/"+empID).once("value",snap=>{
    const emp=snap.val();
    if(!emp) return;
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(20); doc.text("Olerite de Pago",20,20);
    doc.setFontSize(14);
    doc.text(`Empleado: ${emp.nombre}`,20,40);
    doc.text(`Salario: ${emp.salario} (${emp.tipoSalario})`,20,50);
    doc.text(`Fecha: ${new Date().toLocaleDateString()}`,20,60);
    doc.save(`Olerite_${emp.nombre}.pdf`);
  });
}

// üë∑ EMPLEADO ‚Äì PIN + BOTONES DIN√ÅMICOS + CONTROL DE ORDEN
let empleadoActual=null;
const etapas=['entrada','almuerzo_salida','almuerzo_regreso','salida'];
function mark(tipo){
  if(!empleadoActual) return;
  const now=new Date();
  const yyyy=now.getFullYear(), mm=now.getMonth()+1, dd=now.getDate();
  const fecha=`${yyyy}-${mm<10?'0'+mm:mm}-${dd<10?'0'+dd:dd}`;
  const ref=db.ref("marcaciones/"+empleadoActual.id+"/"+fecha);
  ref.once("value", snap => {
  const marc = snap.val() ? snap.val() : {};

  let lastEtapa = null;
  let lastTime = 0;

  Object.values(marc).forEach(m => {
    if (m.timestamp && m.timestamp > lastTime) {
      lastTime = m.timestamp;
      lastEtapa = m.tipo;
    }
  });

  const lastIndex = lastEtapa ? etapas.indexOf(lastEtapa) : -1;

  if (lastIndex === -1 && tipo !== 'entrada') {
    document.getElementById("empMsg").innerHTML =
      "‚ö†Ô∏è Debes iniciar con Entrada";
    return;
  }

  if (lastIndex !== -1 && etapas.indexOf(tipo) !== lastIndex + 1) {
    document.getElementById("empMsg").innerHTML =
      "‚ö†Ô∏è Debes seguir el orden de marcaci√≥n";
    return;
  }

    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(pos=>{
        const lat=pos.coords.latitude, lon=pos.coords.longitude;
        const hora=now.toLocaleTimeString(), timestamp=now.getTime();
        ref.child(tipo).set({nombre:empleadoActual.nombre,tipo,fecha,hora,timestamp,lat,lon});
        let frase="";
        if(tipo=="entrada") frase="¬°Que tengas un buen inicio de jornada!";
        if(tipo=="almuerzo_salida") frase="Buen provecho üçΩÔ∏è";
        if(tipo=="almuerzo_regreso") frase="Bienvenido de vuelta üëã";
        if(tipo=="salida") frase="¬°Buen trabajo!";
        document.getElementById("empMsg").innerHTML=`${empleadoActual.nombre} | ${frase} (${hora})`;
        mostrarNotificacion(`${empleadoActual.nombre} marc√≥ ${tipo} a las ${hora}`);
        setTimeout(backHome,2000);
        loadMarcaciones(); updateChart();
      },()=>alert("No se pudo obtener ubicaci√≥n GPS"));
    } else alert("GPS no disponible");
  });
}
document.getElementById("empPin").addEventListener("input", () => {
  const pin = document.getElementById("empPin").value.trim();
  if (!pin) {
    document.getElementById("employeeButtons").classList.add("hidden");
    document.getElementById("empNombreGrande").innerHTML = "";
    return;
  }

  db.ref("empleados").orderByChild("pin").equalTo(pin).once("value", snap => {
    if (!snap.exists()) {
      document.getElementById("employeeButtons").classList.add("hidden");
      document.getElementById("empNombreGrande").innerHTML = "";
      document.getElementById("empMsg").innerHTML = "‚ö†Ô∏è PIN no encontrado";
      return;
    }

    snap.forEach(empSnap => {
      empleadoActual = { id: empSnap.key, nombre: empSnap.val().nombre };
      document.getElementById("empNombreGrande").innerHTML = empleadoActual.nombre;
      document.getElementById("employeeButtons").classList.remove("hidden");
      document.getElementById("empMsg").innerHTML = "";
    });
  });
});

// üìù ADMIN ‚Äì RESUMEN ORDENADO
let excelRows=[], excelSalarial=[], allMarcaciones={};
function loadMarcaciones(){
  db.ref("marcaciones").on("value",snap=>{
    allMarcaciones=snap.val()||{};
    renderAdminList(document.getElementById("filterDate").value);
    updateChart();
    generarGraficoDia();
  });
}

function renderAdminList(dateFilter){
  const cont=document.getElementById("adminList"), notif=document.getElementById("notificaciones");
  cont.innerHTML=""; notif.innerHTML=""; excelRows=[]; excelSalarial=[];
  if(!allMarcaciones) return;

  const periodo=document.getElementById("periodoResumen").value;
  const empIDs=Object.keys(allMarcaciones).sort((a,b)=>{
    const nameA=Object.values(allMarcaciones[a])[0]? Object.values(Object.values(allMarcaciones[a])[0])[0].nombre:'';
    const nameB=Object.values(allMarcaciones[b])[0]? Object.values(Object.values(allMarcaciones[b])[0])[0].nombre:'';
    return nameA.localeCompare(nameB);
  });

  empIDs.forEach(empID=>{
    const fechas=allMarcaciones[empID];
    Object.keys(fechas).sort().forEach(fecha=>{
      if(dateFilter && !fecha.startsWith(dateFilter.substring(0,7)) && periodo!=="diario") return;
      if(periodo==="diario" && dateFilter && fecha!==dateFilter) return;
      const tipos=fechas[fecha];
      Object.keys(tipos).sort().forEach(tipo=>{
        const data=tipos[tipo];
        if(!data.nombre) data.nombre="Sin nombre";
        cont.innerHTML+=`<p><b>${data.nombre}</b> | ${data.tipo} | ${fecha} | ${data.hora}</p>`;
        excelRows.push([data.nombre,fecha,data.tipo,data.hora]);
        excelSalarial.push({nombre:data.nombre,fecha:data.fecha,tipo:data.tipo,timestamp:data.timestamp});
        notif.innerHTML+=`<div class="notif">${data.nombre} marc√≥ ${data.tipo} a las ${data.hora}</div>`;
      });
    });
  });
}

// üìä EXPORTACI√ìN FILTRADA
function exportExcelFiltro(){
  const fecha=document.getElementById("filterDate").value;
  const periodo=document.getElementById("periodoResumen").value;
  const rows=[["Nombre","Fecha","Tipo","Hora"]];
  for(const m of excelRows){
    const mFecha=m[1];
    if(periodo==="diario" && mFecha!==fecha) continue;
    if(periodo==="quincenal" && !mFecha.startsWith(fecha.substring(0,7))) continue;
    if(periodo==="mensual" && !mFecha.startsWith(fecha.substring(0,4)+"-"+fecha.substring(5,7))) continue;
    rows.push(m);
  }
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(rows),"Resumen");
  XLSX.writeFile(wb,"Poladent_Marcaciones_Filtro.xlsx");
}

function exportExcelSalarialFiltro(){
  const fecha=document.getElementById("filterDate").value;
  const periodo=document.getElementById("periodoResumen").value;
  const resumen={};
  for(const m of excelSalarial){
    const mFecha=m.fecha;
    if(periodo==="diario" && mFecha!==fecha) continue;
    if(periodo==="quincenal" && !mFecha.startsWith(fecha.substring(0,7))) continue;
    if(periodo==="mensual" && !mFecha.startsWith(fecha.substring(0,4)+"-"+fecha.substring(5,7))) continue;
    if(!resumen[m.nombre]) resumen[m.nombre]={dias:{}};
    if(!resumen[m.nombre].dias[mFecha]) resumen[m.nombre].dias[mFecha]={entrada:null,salida:null};
    if(m.tipo==="entrada") resumen[m.nombre].dias[mFecha].entrada=m.timestamp;
    if(m.tipo==="salida") resumen[m.nombre].dias[mFecha].salida=m.timestamp;
  }
  const wsData=[["Nombre","Fecha","Horas trabajadas","Horas extra","Banco de horas"]];
  for(const emp in resumen){
    let bancoTotal=0;
    for(const dia in resumen[emp].dias){
      const ent=resumen[emp].dias[dia].entrada;
      const sal=resumen[emp].dias[dia].salida;
      if(!ent||!sal) continue;
      let hrs=(sal-ent)/3600000;
      let extra=Math.max(0,hrs-8);
      let normales=Math.min(8,hrs);
      bancoTotal+=extra;
      wsData.push([emp,dia,normales.toFixed(2),extra.toFixed(2),bancoTotal.toFixed(2)]);
    }
  }
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(wsData),"Salario");
  XLSX.writeFile(wb,"Poladent_Salario_Filtro.xlsx");
}

// üìÖ CALENDARIO
function setDefaultDate(){
  const today=new Date();
  let month=today.getMonth()+1; if(month<10) month="0"+month;
  let day=today.getDate(); if(day<10) day="0"+day;
  const yyyy=today.getFullYear();
  document.getElementById("filterDate").value=`${yyyy}-${month}-${day}`;
}
function filterByDate(){renderAdminList(document.getElementById("filterDate").value); updateChart();}

// üîî NOTIFICACIONES
function mostrarNotificacion(text){
  const notif=document.getElementById("notificaciones");
  const div=document.createElement("div");
  div.className="notif";
  div.innerText=text;
  notif.prepend(div);
}

// üìä GR√ÅFICO HORAS
function renderChart(startDate='', endDate=''){
  const ctx=document.getElementById("horasChart").getContext("2d");
  let chartData={labels:[], datasets:[{label:'Horas trabajadas', data:[], backgroundColor:'rgba(0,123,255,0.5)'}]};
  const filtroInicio=startDate ? new Date(startDate) : null;
  const filtroFin=endDate ? new Date(endDate) : null;

  const resumenHoras={};
  for(const empID in allMarcaciones){
    const fechas=allMarcaciones[empID];
    for(const fecha in fechas){
      const fechaObj=new Date(fecha);
      if(filtroInicio && fechaObj<filtroInicio) continue;
      if(filtroFin && fechaObj>filtroFin) continue;

      const tipos=fechas[fecha];
      let entrada=null, salida=null;
      Object.values(tipos).forEach(m=>{
        if(m.tipo==='entrada') entrada=m.timestamp;
        if(m.tipo==='salida') salida=m.timestamp;
      });
      if(!entrada || !salida) continue;
      const nombre=Object.values(tipos)[0].nombre || 'Sin nombre';
      if(!resumenHoras[nombre]) resumenHoras[nombre]=0;
      resumenHoras[nombre]+=(salida-entrada)/3600000;
    }
  }

  chartData.labels=Object.keys(resumenHoras);
  chartData.datasets[0].data=Object.values(resumenHoras);

  if(window.horasChartInstance) window.horasChartInstance.destroy();
  window.horasChartInstance=new Chart(ctx,{
    type:'bar',
    data:chartData,
    options:{responsive:true, plugins:{legend:{display:false}}}
  });
}

// Actualiza gr√°fico al cambiar rango
function updateChart(){
  const start=document.getElementById("chartStart").value;
  const end=document.getElementById("chartEnd").value;
  renderChart(start,end);
}
// üîΩ Funci√≥n para minimizar/expandir listas
function toggleSection(id){
  const el = document.getElementById(id);
  const header = el.previousElementSibling;
  if(el.style.display === 'none'){
    el.style.display = 'block';
    header.innerHTML = header.innerHTML.replace('‚ñ≤','‚ñº');
  } else {
    el.style.display = 'none';
    header.innerHTML = header.innerHTML.replace('‚ñº','‚ñ≤');
  }
}
  let chartDia = null;

function generarGraficoDia() {
  const hoy = new Date().toISOString().split('T')[0];
  const empleadosHoras = {};

  registros.forEach(r => {
    if (r.fecha === hoy && r.entrada && r.salida) {
      const entrada = new Date(`${r.fecha} ${r.entrada}`);
      const salida = new Date(`${r.fecha} ${r.salida}`);
      const horas = (salida - entrada) / 3600000;

      empleadosHoras[r.nombre] = (empleadosHoras[r.nombre] || 0) + horas;
    }
  });

  const nombres = Object.keys(empleadosHoras);
  const horas = Object.values(empleadosHoras);

  const ctx = document.getElementById('chartDia');

  if (chartDia) chartDia.destroy();

  chartDia = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: nombres,
      datasets: [{
        label: 'Horas trabajadas hoy',
        data: horas,
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Horas'
          }
        }
      }
    }
  });
}
// üîπ INICIO
backHome();
</script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</body>
</html>
