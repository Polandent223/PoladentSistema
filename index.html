<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Poladent ‚Äì Sistema Completo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{font-family:Arial;background:#eaf6ff;padding:20px;text-align:center;}
.card{background:#fff;padding:20px;border-radius:10px;margin:15px auto;max-width:450px;box-shadow:0 2px 5px rgba(0,0,0,.1);}
button,input,select{padding:10px;margin:5px;width:90%;}
button{background:#007bff;color:#fff;border:none;border-radius:5px;cursor:pointer;}
button.small{width:auto;padding:5px 10px;font-size:12px;}
.hidden{display:none;}
.nombreGrande{font-size:24px;font-weight:bold;margin-bottom:10px;}
.notice{background:#dff3ff;padding:10px;border-radius:5px;margin-top:8px;}
.falta{color:red;font-weight:bold;}
.ok{color:green;font-weight:bold;}
.warn{color:#e69500;font-weight:bold;}
</style>
</head>

<body>

<h1>Poladent ü¶∑</h1>

<div id="home" class="card">
  <button onclick="goAdmin()">Administrador</button>
  <button onclick="goEmployee()">Empleado</button>
</div>

<div id="adminLogin" class="card hidden">
  <input id="adminEmail" placeholder="Correo">
  <input id="adminPass" type="password" placeholder="Contrase√±a">
  <button onclick="loginAdmin()">Entrar</button>
  <button onclick="backHome()">Volver</button>
</div>

<div id="adminPanel" class="card hidden">
  <h3>Administrador</h3>

  <input type="date" id="filterDate" onchange="renderAdmin()">
  <div id="adminList"></div>

  <button onclick="logout()">Salir</button>
</div>

<div id="employeePanel" class="card hidden">
  <div class="nombreGrande" id="empNombre"></div>
  <input id="empPin" type="password" placeholder="PIN">
  <div id="employeeButtons" class="hidden">
    <button onclick="mark('entrada')">Entrada</button>
    <button onclick="mark('almuerzo_salida')">Salida Almuerzo</button>
    <button onclick="mark('almuerzo_regreso')">Regreso Almuerzo</button>
    <button onclick="mark('salida')">Salida</button>
  </div>
  <div id="empMsg" class="notice"></div>
  <button onclick="backHome()">Volver</button>
</div>

<script>
const firebaseConfig={
apiKey:"AIzaSyAFOyMEo2SgWpcs8WHp2nKCO_ax9-lYZWo",
authDomain:"poladent-5fa13.firebaseapp.com",
databaseURL:"https://poladent-5fa13-default-rtdb.firebaseio.com",
projectId:"poladent-5fa13"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(), db=firebase.database();

function hideAll(){
  home.classList.add("hidden");
  adminLogin.classList.add("hidden");
  adminPanel.classList.add("hidden");
  employeePanel.classList.add("hidden");
}
function backHome(){hideAll();home.classList.remove("hidden");}
function goAdmin(){hideAll();adminLogin.classList.remove("hidden");}
function goEmployee(){hideAll();employeePanel.classList.remove("hidden");}

function loginAdmin(){
  auth.signInWithEmailAndPassword(adminEmail.value,adminPass.value)
  .then(()=>{
    hideAll();
    adminPanel.classList.remove("hidden");
    filterDate.value=hoy();
    renderAdmin();
  });
}
function logout(){auth.signOut();backHome();}

let empleadoActual=null;

document.getElementById("empPin").addEventListener("change",()=>{
  db.ref("empleados").orderByChild("pin").equalTo(empPin.value).once("value",s=>{
    if(!s.exists()) return alert("PIN incorrecto");
    s.forEach(e=>{
      empleadoActual={id:e.key,nombre:e.val().nombre};
      empNombre.innerText=empleadoActual.nombre;
      employeeButtons.classList.remove("hidden");
    });
  });
});

function hoy(){
  const d=new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}

function mark(tipo){
  const fecha=hoy();
  const now=new Date();
  db.ref(`marcaciones/${empleadoActual.id}/${fecha}/${tipo}`)
  .set({
    nombre:empleadoActual.nombre,
    tipo,
    hora:now.toLocaleTimeString(),
    timestamp:now.getTime()
  });
  empMsg.innerHTML="‚úî Marcado";
  setTimeout(backHome,1500);
}

function renderAdmin(){
  const fecha=filterDate.value;
  adminList.innerHTML="";

  db.ref("marcaciones").once("value",snap=>{
    snap.forEach(emp=>{
      const dias=emp.val();
      if(!dias[fecha]){
        adminList.innerHTML+=`<p class="falta">${emp.key} ‚ùå FALTA</p>`;
        return;
      }

      const marcas=dias[fecha];
      let ent=marcas.entrada, sal=marcas.salida;

      let estado="<span class='warn'>‚ö† Incompleto</span>";
      if(ent && sal) estado="<span class='ok'>‚úÖ Completo</span>";

      let horas=0;
      if(ent && sal) horas=((sal.timestamp-ent.timestamp)/3600000).toFixed(2);

      adminList.innerHTML+=`
        <div class="card">
          <b>${ent?.nombre || "Empleado"}</b><br>
          ${estado}<br>
          Horas: ${horas || "0"}<br>
          Entrada: ${ent?.hora || "‚Äî"} 
          <button class="small" onclick="editar('${emp.key}','${fecha}','entrada')">Editar</button><br>
          Salida: ${sal?.hora || "‚Äî"} 
          <button class="small" onclick="editar('${emp.key}','${fecha}','salida')">Editar</button>
        </div>
      `;
    });
  });
}

function editar(emp,fecha,tipo){
  const nueva=prompt("Nueva hora (HH:MM:SS)");
  if(!nueva) return;
  db.ref(`marcaciones/${emp}/${fecha}/${tipo}`).update({hora:nueva});
  renderAdmin();
}

backHome();
</script>
</body>
</html>
